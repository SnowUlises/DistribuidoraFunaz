<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administración - Distribuidora Funaz</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #333;
      padding: 2em;
    }
    header {
      background: #4a90e2;
      color: white;
      text-align: center;
      padding: 1.5em 0;
      font-size: 2em;
      font-weight: bold;
      user-select: none;
      margin-bottom: 2em;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    button.btn-volver {
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 1.5em;
      display: inline-block;
    }
    button.btn-volver:hover {
      background: #357ABD;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
    }
    details {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1.5em;
      padding: 1.5em;
      cursor: pointer;
      transition: box-shadow 0.3s;
    }
    details[open] {
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    summary {
      font-size: 1.4em;
      font-weight: 600;
      outline: none;
      list-style: none;
      cursor: pointer;
      user-select: none;
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    summary::before {
      content: "▶";
      display: inline-block;
      transition: transform 0.3s ease;
    }
    details[open] summary::before {
      transform: rotate(90deg);
    }
    .usuario-item, .peticion-item {
      background: #eef3f7;
      border-radius: 8px;
      margin-bottom: 1em;
      padding: 1em;
      box-shadow: inset 0 0 5px #bbb;
    }
    .peticion-details {
      margin-bottom: 1em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
    }
    .peticion-details summary {
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      margin-bottom: 0.5em;
      color: #3a3a3a;
    }
    .peticion-info {
      margin-bottom: 0.8em;
      font-size: 0.95em;
    }
    .peticion-items {
      margin-top: 0.5em;
      padding-left: 1em;
    }
    .item {
      margin: 0.5em 0;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .item-controls {
      display: flex;
      gap: 0.5em;
    }
    .item-controls button {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .item-controls button.increase {
      background: #28a745;
      color: white;
    }
    .item-controls button.increase:hover {
      background: #218838;
    }
    .item-controls button.decrease {
      background: #ffc107;
      color: black;
    }
    .item-controls button.decrease:hover {
      background: #e0a800;
    }
    .item-controls button.delete {
      background: #dc3545;
      color: white;
    }
    .item-controls button.delete:hover {
      background: #c82333;
    }
    .status-container {
      display: flex;
      gap: 1em;
      align-items: center;
      margin-top: 0.5em;
    }
    .status-container label {
      font-size: 0.9em;
      cursor: pointer;
      user-select: none;
    }
    .status-container input[type="checkbox"] {
      margin-right: 4px;
    }
    .pedido-actions, .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8em;
      margin-top: 1em;
      align-items: center;
    }
    button.confirmar {
      background: #28a745;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.confirmar:hover {
      background: #218838;
    }
    button.confirmar-plus {
      background: #17a2b8;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.confirmar-plus:hover {
      background: #138496;
    }
    button.preview-pdf {
      background: #6c757d;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.preview-pdf:hover {
      background: #5a6268;
    }
    button.copy-faltantes {
      background: #fd7e14;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.copy-faltantes:hover {
      background: #dd6b10;
    }
    button.delete-peticion {
      background: #dc3545;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.delete-peticion:hover {
      background: #c82333;
    }
    button.enfocar {
      background: #9c27b0;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.enfocar:hover {
      background: #7b1fa2;
    }
    .pedido-item.enfocado {
      background: #f3e5f5;
      border: 3px solid #9c27b0;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(156, 39, 176, 0.4);
      transform: scale(1.02);
      transition: all 0.3s;
      z-index: 10;
      position: relative;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      color: #d9534f;
      font-weight: bold;
      margin-top: 0.5em;
    }
    #mensajeError {
      margin-bottom: 1em;
      color: red;
      font-weight: bold;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    footer {
      text-align: center;
      color: #777;
      margin-top: 2em;
    }
    button.add-product {
      background: #007bff;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.add-product:hover {
      background: #0069d9;
    }
    dialog {
      padding: 1.5em;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 90%;
    }
    dialog form {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    dialog label {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    dialog input[type="text"] {
      flex: 1;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    dialog button {
      padding: 0.5em 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    dialog button[type="button"]:first-of-type {
      background: #28a745;
      color: white;
    }
    dialog button[type="button"]:last-of-type {
      background: #dc3545;
      color: white;
    }
    button.load-more {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 1em auto;
    }
    button.load-more:hover {
      background: #357ABD;
    }
  </style>
</head>
<body>
  <header>Panel de administración</header>
  <main>
    <button class="btn-volver" onclick="location.href='index.html'">← Volver a tienda</button>
    <div id="mensajeError"></div>
    <details>
      <summary>Usuarios y pedidos</summary>
      <div id="listaUsuarios"></div>
    </details>
    <details>
      <summary>Peticiones</summary>
      <div id="listaPeticiones"></div>
    </details>
  </main>
  <footer>
    Distribuidora Funaz
  </footer>
  <dialog id="addProductModal">
    <form>
      <label for="productsInput">Productos (IDxCantidad, separados por coma):</label>
      <input type="text" id="productsInput" placeholder="353x5,24x2">
      <label>
        <input type="checkbox" id="apply3percent"> Aplicar -3%
      </label>
      <button type="button" onclick="addProductsToPedido()">Añadir</button>
      <button type="button" onclick="closeAddModal()">Cancelar</button>
    </form>
  </dialog>
  <script>
  const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  // Security check
  const user = localStorage.getItem('loggedUser');
  if (user !== 'admin') {
    window.location.href = 'index.html';
  }
  // States
  let estadosPedidos = JSON.parse(localStorage.getItem('estadosPedidos') || '{}');
  const usedButtons = JSON.parse(localStorage.getItem('usedButtons') || '{}');
  let productos = [];
  let currentPedidoId = null;
  window.usersPedidos = {};
  function guardarEstados() {
    localStorage.setItem('estadosPedidos', JSON.stringify(estadosPedidos));
  }
  function saveUsedButtons() {
    localStorage.setItem('usedButtons', JSON.stringify(usedButtons));
  }
  function mostrarError(msg) {
    const el = document.getElementById('mensajeError');
    if (el) el.textContent = msg;
    else console.warn('mensajeError no encontrado:', msg);
  }
  // ==================== FUNCIÓN ENFOCAR ====================
  function enfocarPedido(pedidoId) {
    const selectedPedido = document.getElementById(`pedido-${pedidoId}`);
    if (!selectedPedido) return;
    const btn = selectedPedido.querySelector('.enfocar');
    const estaEnfocado = selectedPedido.classList.contains('enfocado');
    // Resetear todo
    document.querySelectorAll('.pedido-item').forEach(p => {
      p.style.display = '';
      p.classList.remove('enfocado');
      const b = p.querySelector('.enfocar');
      if (b) b.textContent = 'Enfocar';
    });
    const peticionesSection = document.querySelector('main details:nth-of-type(2)');
    if (peticionesSection) peticionesSection.style.display = '';
    if (!estaEnfocado) {
      // Ocultar todos los demás pedidos
      document.querySelectorAll('.pedido-item').forEach(p => {
        if (p.id !== `pedido-${pedidoId}`) {
          p.style.display = 'none';
        }
      });
      // Ocultar sección de peticiones
      if (peticionesSection) peticionesSection.style.display = 'none';
      // Resaltar el pedido seleccionado
      selectedPedido.classList.add('enfocado');
      btn.textContent = 'Mostrar todos';
      // Abrir solo el usuario correspondiente y cerrar los demás
      const userDetails = selectedPedido.closest('.user-details');
      if (userDetails) {
        document.querySelectorAll('.user-details').forEach(ud => {
          ud.open = false;
        });
        userDetails.open = true;
      }
      // Scroll suave al pedido
      selectedPedido.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
  // ========================================================
  function toggleGuardado(usuario, idx, el) {
    const key = `${usuario}-${idx}`;
    const nuevo = !!el.checked;
    const confirmado = confirm(nuevo
      ? '¿Marcar pedido como guardado?'
      : '¿Desmarcar pedido guardado?');
    if (!confirmado) { el.checked = !nuevo; return; }
    estadosPedidos[key] = { ...estadosPedidos[key], guardado: nuevo };
    guardarEstados();
  }
  function toggleRecibido(usuario, idx, el) {
    const key = `${usuario}-${idx}`;
    const nuevo = !!el.checked;
    const confirmado = confirm(nuevo
      ? '¿Marcar pedido como recibido?'
      : '¿Desmarcar pedido recibido?');
    if (!confirmado) { el.checked = !nuevo; return; }
    estadosPedidos[key] = { ...estadosPedidos[key], recibido: nuevo };
    guardarEstados();
  }
  function formatDateTime(fecha) {
    const date = new Date(fecha);
    const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const formattedDate = `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
    const formattedTime = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    return { formattedDate, formattedTime };
  }
  function getOpenStates() {
    const mainUsersDetails = document.querySelector('details > summary:first-child').parentElement;
    const mainPeticionesDetails = document.querySelectorAll('details')[1];
    const openUserNames = Array.from(document.querySelectorAll('.user-details[open]')).map(d => d.querySelector('summary').textContent.trim());
    return {
      usersOpen: mainUsersDetails?.open || false,
      peticionesOpen: mainPeticionesDetails?.open || false,
      openUserNames
    };
  }
  function restoreOpenStates(states) {
    const mainUsersDetails = document.querySelector('details > summary:first-child').parentElement;
    if (mainUsersDetails && states.usersOpen) mainUsersDetails.open = true;
    const mainPeticionesDetails = document.querySelectorAll('details')[1];
    if (mainPeticionesDetails && states.peticionesOpen) mainPeticionesDetails.open = true;
    states.openUserNames.forEach(name => {
      const userDetail = Array.from(document.querySelectorAll('.user-details')).find(d => d.querySelector('summary').textContent.trim() === name);
      if (userDetail) userDetail.open = true;
    });
  }
  const detailsContents = new Map();
  function setupDetails(det) {
    if (detailsContents.has(det)) return;
    const content = [];
    let child = det.firstChild;
    while (child) {
      if (child.tagName !== 'SUMMARY') {
        content.push(child);
      }
      child = child.nextSibling;
    }
    detailsContents.set(det, content);
    if (!det.open) {
      content.forEach(node => det.removeChild(node));
    }
    det.addEventListener('toggle', function() {
      if (this.open) {
        const cont = detailsContents.get(this);
        cont.forEach(node => this.appendChild(node));
      } else {
        const newContent = [];
        let ch = this.firstChild;
        while (ch) {
          if (ch.tagName !== 'SUMMARY') {
            newContent.push(ch);
          }
          ch = ch.nextSibling;
        }
        detailsContents.set(this, newContent);
        newContent.forEach(node => this.removeChild(node));
      }
    });
  }
  function buildPedidoHTML(pedido, index, userName) {
    const items = pedido.items;
    const pedidoId = pedido.id ?? `${userName}-${index}`;
    const key = `${userName}-${index}`;
    const estado = estadosPedidos[key] || {};
    const total = items.reduce((sum, p) => sum + p.subtotal, 0);
    const { formattedDate, formattedTime } = formatDateTime(pedido.fecha);
    return `
      <li>
        <div class="pedido-item" id="pedido-${pedidoId}">
          <div class="pedido-line">
            <strong>Pedido #${index + 1}</strong> del ${formattedDate} ${formattedTime} (ID: ${pedidoId}) - <b>Total: <span id="total-${pedidoId}">${formatMoney(total)}</span></b>
          </div>
          <div class="peticion-items" id="items-${pedidoId}">
            ${items.map((item, itemIndex) => `
              <div class="item" data-item-index="${itemIndex}">
                <span id="item-text-${pedidoId}-${itemIndex}">${item.nombre}: <span id="cantidad-${pedidoId}-${itemIndex}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}</span>
                <div class="item-controls">
                  <button class="increase" onclick="modificarCantidadPedido('${pedidoId}', ${itemIndex}, 1)">+</button>
                  <button class="decrease" onclick="modificarCantidadPedido('${pedidoId}', ${itemIndex}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
                  <button class="delete" onclick="eliminarItemPedido('${pedidoId}', ${itemIndex})">Eliminar</button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="pedido-actions">
            <button onclick="eliminarPedido('${pedidoId}', '${userName}', ${index})">Eliminar pedido</button>
            <button class="guardar-btn" data-pedidoid="${pedidoId}" data-username="${userName}" data-index="${index}">
              Guardar pedido
            </button>
            <button class="preview-pdf" onclick="previewPDFPedido('${pedidoId}')">Descargar PDF Preview</button>
            <button class="add-product" onclick="openAddModal('${pedidoId}')">Añadir producto</button>
            <button class="confirmar" onclick="guardarCambiosPedido('${pedidoId}')">Guardar Cambios</button>
            <button class="enfocar" onclick="enfocarPedido('${pedidoId}')">Enfocar</button>
            <span class="guardar-status" id="guardar-status-${pedidoId}" aria-hidden="true">
              ${estado.guardado ? '✅ Guardado' : ''}
            </span>
          </div>
          <div class='status-container'>
            <label><input type='checkbox' ${estado.guardado ? 'checked' : ''} onchange="toggleGuardado('${userName}',${index}, this)"> Guardado</label>
            <label><input type='checkbox' ${estado.recibido ? 'checked' : ''} onchange="toggleRecibido('${userName}',${index}, this)"> Recibido</label>
            <label><input type="checkbox" id="modo-devolucion-${pedidoId}"> Modo Devolución</label>
          </div>
        </div>
      </li>`;
  }
  function addGuardarBtnListener(btn) {
    btn.addEventListener('click', async () => {
      const pedidoId = btn.dataset.pedidoid;
      const username = btn.dataset.username;
      const idx = Number(btn.dataset.index);
      const statusSpan = document.getElementById(`guardar-status-${pedidoId}`);
      if (statusSpan) statusSpan.textContent = '⏳ Guardando...';
      try {
        await guardarPedido(pedidoId);
        if (statusSpan) statusSpan.textContent = '✅ Guardado';
        const key = `${username}-${idx}`;
        estadosPedidos[key] = estadosPedidos[key] || {};
        estadosPedidos[key].guardado = true;
        guardarEstados();
      } catch (err) {
        if (statusSpan) statusSpan.textContent = '❌ Error';
        console.error('Error al guardar pedido:', err);
        mostrarError(`Error al guardar pedido ${pedidoId}: ${err.message}`);
      }
    });
  }
  async function cargarUsuarios() {
    try {
      const listaPedidos = document.getElementById('listaUsuarios');
      if (!listaPedidos) {
        console.error('Elemento listaUsuarios no encontrado en el DOM');
        mostrarError('Error: listaUsuarios no encontrado en el DOM');
        return;
      }
      listaPedidos.innerHTML = '<p>Cargando pedidos...</p>';
      const res = await fetch(`${apiBase}/pedidos`, { cache: 'no-store' });
      if (!res.ok) {
        console.warn('Error al cargar pedidos:', res.status, await res.text().catch(() => ''));
        mostrarError(`Error al cargar pedidos de ${apiBase}/pedidos: HTTP ${res.status}`);
        listaPedidos.innerHTML = '<p>No se pudieron cargar los pedidos.</p>';
        return;
      }
      const pedidosRaw = await res.json();
      console.log('Pedidos API response:', JSON.stringify(pedidosRaw, null, 2));
      const pedidosPorUsuario = {};
      pedidosRaw.forEach(p => {
        const user = p.user || 'Invitado';
        if (!pedidosPorUsuario[user]) pedidosPorUsuario[user] = [];
        let items = Array.isArray(p.items) ? p.items : typeof p.items === 'string' ? JSON.parse(p.items || '[]') : [];
        items = items.map(item => ({
          id: item.id || 'unknown',
          nombre: String(item.nombre || 'Sin nombre'),
          cantidad: Number(item.cantidad) || 1,
          precio_unitario: Number(item.precio_unitario || item.precio) || 0,
          subtotal: Number(item.subtotal) || (Number(item.cantidad) * Number(item.precio_unitario || item.precio)) || 0
        }));
        pedidosPorUsuario[user].push({ ...p, items });
      });
      listaPedidos.innerHTML = '';
      if (Object.keys(pedidosPorUsuario).length === 0) {
        listaPedidos.innerHTML = '<p>No hay pedidos registrados.</p>';
        return;
      }
      Object.entries(pedidosPorUsuario).forEach(([userName, userPedidos]) => {
        userPedidos.sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));
        usersPedidos[userName] = userPedidos;
        const initialCount = 5;
        const pedidosToShow = userPedidos.slice(0, initialCount);
        let pedidosHTML = '<ul>';
        pedidosToShow.forEach((pedido, index) => {
          pedidosHTML += buildPedidoHTML(pedido, index, userName);
        });
        pedidosHTML += '</ul>';
        const hasMore = userPedidos.length > initialCount;
        if (hasMore) {
          pedidosHTML += `<button class="load-more" data-username="${userName}" data-loaded="${initialCount}" onclick="loadMorePedidos(this)">Cargar más</button>`;
        }
        const userDiv = document.createElement('details');
        userDiv.className = 'user-details';
        userDiv.innerHTML = `<summary>${userName}</summary>
          <div class='usuario-item'>${pedidosHTML}</div>`;
        listaPedidos.appendChild(userDiv);
        pedidosToShow.forEach((pedido, index) => {
          const pedidoId = pedido.id ?? `${userName}-${index}`;
          const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
          if (pedidoDiv) {
            pedidoDiv.dataset.items = JSON.stringify(pedido.items);
            pedidoDiv.dataset.originalItems = JSON.stringify(pedido.items);
          }
        });
        userDiv.querySelectorAll('.guardar-btn').forEach(addGuardarBtnListener);
      });
      document.querySelectorAll('#listaUsuarios details').forEach(setupDetails);
      setupDetails(document.querySelector('main details:nth-of-type(1)'));
    } catch (err) {
      console.error('Error en cargarUsuarios:', err);
      mostrarError('Error inesperado al cargar usuarios y pedidos.');
      const listaPedidos = document.getElementById('listaUsuarios');
      if (listaPedidos) listaPedidos.innerHTML = '<p>Error al cargar pedidos.</p>';
    }
  }
  function loadMorePedidos(btn) {
    const userName = btn.dataset.username;
    const loaded = parseInt(btn.dataset.loaded);
    const userPedidos = usersPedidos[userName];
    const nextPedidos = userPedidos.slice(loaded, loaded + 5);
    if (nextPedidos.length === 0) return;
    const ul = btn.previousElementSibling;
    nextPedidos.forEach((pedido, offset) => {
      const index = loaded + offset;
      const liHTML = buildPedidoHTML(pedido, index, userName);
      ul.insertAdjacentHTML('beforeend', liHTML);
      const pedidoId = pedido.id ?? `${userName}-${index}`;
      const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
      if (pedidoDiv) {
        pedidoDiv.dataset.items = JSON.stringify(pedido.items);
        pedidoDiv.dataset.originalItems = JSON.stringify(pedido.items);
      }
      const guardarBtn = pedidoDiv.querySelector('.guardar-btn');
      if (guardarBtn) {
        addGuardarBtnListener(guardarBtn);
      }
    });
    btn.dataset.loaded = loaded + nextPedidos.length;
    if (parseInt(btn.dataset.loaded) >= userPedidos.length) {
      btn.remove();
    }
  }
  function modificarCantidadPedido(pedidoId, itemIndex, change) {
    console.log(`Modificando cantidad: pedidoId=${pedidoId}, itemIndex=${itemIndex}, change=${change}`);
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    if (!pedidoDiv) {
      console.error(`Pedido ${pedidoId} no encontrado en el DOM`);
      mostrarError(`Pedido ${pedidoId} no encontrado`);
      return;
    }
    let items = JSON.parse(pedidoDiv.dataset.items || '[]');
    if (!items[itemIndex]) {
      console.error(`Item ${itemIndex} no encontrado en pedido ${pedidoId}`);
      return;
    }
    items[itemIndex].cantidad = Math.max(1, (items[itemIndex].cantidad || 1) + change);
    items[itemIndex].subtotal = items[itemIndex].cantidad * items[itemIndex].precio_unitario;
    pedidoDiv.dataset.items = JSON.stringify(items);
    const cantidadSpan = document.getElementById(`cantidad-${pedidoId}-${itemIndex}`);
    const itemText = document.getElementById(`item-text-${pedidoId}-${itemIndex}`);
    if (cantidadSpan && itemText) {
      cantidadSpan.textContent = items[itemIndex].cantidad;
      itemText.innerHTML = `${items[itemIndex].nombre}: <span id="cantidad-${pedidoId}-${itemIndex}">${items[itemIndex].cantidad}</span> x ${formatMoney(items[itemIndex].precio_unitario)} = ${formatMoney(items[itemIndex].subtotal)}`;
    }
    const decreaseBtn = document.querySelector(`#items-${pedidoId} .item[data-item-index="${itemIndex}"] .decrease`);
    if (decreaseBtn) {
      decreaseBtn.disabled = items[itemIndex].cantidad <= 1;
    }
    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
    const totalSpan = document.getElementById(`total-${pedidoId}`);
    if (totalSpan) {
      totalSpan.textContent = formatMoney(total);
    }
  }
  function eliminarItemPedido(pedidoId, itemIndex) {
    if (!confirm('¿Eliminar este item del pedido?')) return;
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    if (!pedidoDiv) return;
    let items = JSON.parse(pedidoDiv.dataset.items || '[]');
    items = items.filter((_, idx) => idx !== itemIndex);
    pedidoDiv.dataset.items = JSON.stringify(items);
    const itemsContainer = document.getElementById(`items-${pedidoId}`);
    if (itemsContainer) {
      itemsContainer.innerHTML = items.length > 0 ? items.map((item, index) => `
        <div class="item" data-item-index="${index}">
          <span id="item-text-${pedidoId}-${index}">${item.nombre}: <span id="cantidad-${pedidoId}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}</span>
          <div class="item-controls">
            <button class="increase" onclick="modificarCantidadPedido('${pedidoId}', ${index}, 1)">+</button>
            <button class="decrease" onclick="modificarCantidadPedido('${pedidoId}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
            <button class="delete" onclick="eliminarItemPedido('${pedidoId}', ${index})">Eliminar</button>
          </div>
        </div>
      `).join('') : '<p>No hay items en este pedido.</p>';
      const total = items.reduce((sum, it) => sum + it.subtotal, 0);
      const totalSpan = document.getElementById(`total-${pedidoId}`);
      if (totalSpan) totalSpan.textContent = formatMoney(total);
    }
  }
  async function guardarCambiosPedido(pedidoId) {
    if (!confirm('¿Guardar los cambios en este pedido?')) return;
    try {
      const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
      if (!pedidoDiv) throw new Error('Pedido no encontrado');
      const items = JSON.parse(pedidoDiv.dataset.items || '[]');
      const originalItems = JSON.parse(pedidoDiv.dataset.originalItems || '[]');
      if (!items || items.length === 0) return alert('No hay items');
      
      const modoDevolucion = document.getElementById(`modo-devolucion-${pedidoId}`)?.checked || false;

      // Cálculo de deltas para stock
      const deltaMap = new Map();
      originalItems.forEach(oi => deltaMap.set(oi.id, -oi.cantidad));
      items.forEach(item => {
        const curr = deltaMap.get(item.id) || 0;
        deltaMap.set(item.id, curr + item.cantidad);
      });

      const stockUpdates = [];
      for (const [id, delta] of deltaMap.entries()) {
        if (delta !== 0 && (delta > 0 || modoDevolucion)) {
          stockUpdates.push({id, cantidad: delta});
        }
      }

      const payload = {
        items: items.map(item => ({
          id: item.id,
          nombre: item.nombre,
          cantidad: item.cantidad,
          precio_unitario: item.precio_unitario,
          subtotal: item.cantidad * item.precio_unitario
        })),
        stockUpdates
      };
      const res = await fetch(`${apiBase}/actualizar-pedido/${pedidoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      pedidoDiv.dataset.originalItems = JSON.stringify(items);
      alert('Cambios guardados con éxito.');
      const openStates = getOpenStates();
      const savedScroll = window.scrollY;
      await Promise.all([cargarPedidos(), cargarUsuarios()]);
      restoreOpenStates(openStates);
      setTimeout(() => window.scrollTo(0, savedScroll), 100);
    } catch (err) {
      console.error(err);
      mostrarError(`Error al guardar cambios: ${err.message}`);
    }
  }
  async function previewPDFPedido(pedidoId) {
    try {
      const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
      if (!pedidoDiv) throw new Error('Pedido no encontrado');
      let items = JSON.parse(pedidoDiv.dataset.items || '[]');
      const userName = pedidoDiv.closest('.user-details').querySelector('summary').textContent;
      const payload = {
        user: userName,
        items: items.map(item => ({
          id: item.id || 'unknown',
          nombre: String(item.nombre || 'Sin nombre'),
          cantidad: Number(item.cantidad) || 1,
          precio_unitario: Number(item.precio_unitario) || 0,
          subtotal: Number(item.cantidad) * Number(item.precio_unitario) || 0
        })),
        total: items.reduce((sum, item) => sum + (Number(item.cantidad) * Number(item.precio_unitario)), 0),
        fecha: new Date().toISOString()
      };
      const saveRes = await fetch(`${apiBase}/generar-pdf-peticion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      if (!saveRes.ok) throw new Error(`HTTP ${saveRes.status}`);
      const data = await saveRes.json();
      if (data.ok && data.pdf) {
        window.open(data.pdf, '_blank');
      }
    } catch (err) {
      console.error(err);
      mostrarError(`Error al generar PDF: ${err.message}`);
    }
  }
  async function guardarPedido(pedidoId) {
    try {
      const r = await fetch(`${apiBase}/pedidos/${pedidoId}/pdf`, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Error del servidor: ${r.status}`);
      const data = await r.json();
      if (data.ok && data.pdf) {
        window.open(data.pdf, '_blank');
      }
    } catch (err) {
      console.error(err);
      throw err;
    }
  }
  async function eliminarPedido(pedidoId, usuario, index) {
    if (!confirm('¿Eliminar este pedido?')) return;
    try {
      const key = `${usuario}-${index}`;
      const estado = estadosPedidos[key] || {};
      const esRecibido = estado.recibido || false;
      const res = await fetch(`${apiBase}/eliminar-pedido/${encodeURIComponent(pedidoId)}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recibido: esRecibido }),
        cache: 'no-store'
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      delete estadosPedidos[key];
      guardarEstados();
      const openStates = getOpenStates();
      const savedScroll = window.scrollY;
      await cargarPedidos();
      await cargarUsuarios();
      restoreOpenStates(openStates);
      setTimeout(() => window.scrollTo(0, savedScroll), 100);
      alert('Pedido eliminado correctamente.');
    } catch (err) {
      console.error(err);
      mostrarError(`Error al eliminar pedido: ${err.message}`);
    }
  }
  async function cargarPedidos() {
    try {
      const res = await fetch(`${apiBase}/pedidos`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      localStorage.setItem('pedidos', JSON.stringify(data));
    } catch (err) {
      console.error(err);
    }
  }
  function formatMoney(n) {
    try {
      return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(n);
    } catch (e) {
      return '$' + Number(n).toFixed(2);
    }
  }
  async function cargarProductos() {
    try {
      const res = await fetch(`${apiBase}/productos`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      productos = await res.json();
    } catch (err) {
      console.error(err);
      mostrarError('Error al cargar productos.');
    }
  }
  async function cargarPeticiones() {
    try {
      const listaPeticiones = document.getElementById('listaPeticiones');
      if (!listaPeticiones) return;
      listaPeticiones.innerHTML = '<p>Cargando peticiones...</p>';
      const res = await fetch(`${apiBase}/peticiones`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const peticiones = await res.json();
      listaPeticiones.innerHTML = '';
      if (peticiones.length === 0) {
        listaPeticiones.innerHTML = '<p>No hay peticiones registradas.</p>';
        return;
      }
      peticiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      peticiones.forEach(peticion => {
        const peticionDiv = document.createElement('details');
        peticionDiv.className = 'peticion-details';
        peticionDiv.id = `peticion-${peticion.id}`;
        const isUsed = usedButtons[peticion.id];
        peticionDiv.dataset.items = JSON.stringify(peticion.items);
        peticionDiv.dataset.nombre = peticion.nombre;
        const { formattedDate, formattedTime } = formatDateTime(peticion.fecha);
        peticionDiv.innerHTML = `
          <summary>Petición ID: ${peticion.id} - ${peticion.nombre} - Fecha: ${formattedDate} ${formattedTime}</summary>
          <div class="peticion-item">
            <div class="peticion-info">
              <strong>Teléfono:</strong> ${peticion.telefono}
              <strong>Total:</strong> <span id="total-${peticion.id}">${formatMoney(peticion.total)}</span>
              <div class="peticion-items" id="items-${peticion.id}">
                ${peticion.items.map((item, index) => {
                  let stockWarning = '';
                  const product = productos.find(p => p.id === item.id);
                  if (product && item.cantidad > (product.stock || 0)) {
                    stockWarning = '<span style="color: red;"> Falta stock</span>';
                  }
                  return `
                  <div class="item" data-item-index="${index}">
                    <span id="item-text-${peticion.id}-${index}">${item.nombre}: <span id="cantidad-${peticion.id}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}${stockWarning}</span>
                    <div class="item-controls">
                      <button class="increase" onclick="modificarCantidad('${peticion.id}', ${index}, 1)">+</button>
                      <button class="decrease" onclick="modificarCantidad('${peticion.id}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
                      <button class="delete" onclick="eliminarItemPeticion('${peticion.id}', ${index})">Eliminar</button>
                    </div>
                  </div>
                `;
                }).join('')}
              </div>
              ${isUsed ? `<div class="status">Estado: ${isUsed === 'plus7' ? 'Confirmado -3%' : 'Confirmado'}</div>` : `
                <div class="button-group">
                  <button class="confirmar" onclick="confirmarPeticion(${peticion.id}, false)">Confirmar Pedido</button>
                  <button class="confirmar-plus" onclick="confirmarPeticion(${peticion.id}, true)">Confirmar Pedido -3%</button>
                  <button class="preview-pdf" onclick="previewPDF(${peticion.id})">Descargar PDF Preview</button>
                  <button class="copy-faltantes" onclick="copiarFaltantes(${peticion.id})">Copiar faltantes</button>
                  <button class="delete-peticion" onclick="eliminarPeticion(${peticion.id})">Eliminar Petición</button>
                </div>
              `}
            </div>
          </div>
        `;
        listaPeticiones.appendChild(peticionDiv);
      });
      document.querySelectorAll('#listaPeticiones details').forEach(setupDetails);
      setupDetails(document.querySelector('main details:nth-of-type(2)'));
    } catch (err) {
      console.error(err);
      mostrarError('Error al cargar peticiones.');
    }
  }
  function modificarCantidad(peticionId, itemIndex, change) {
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    if (!peticionDiv) return;
    let items = JSON.parse(peticionDiv.dataset.items || '[]');
    items[itemIndex].cantidad = Math.max(1, items[itemIndex].cantidad + change);
    items[itemIndex].subtotal = items[itemIndex].cantidad * items[itemIndex].precio_unitario;
    peticionDiv.dataset.items = JSON.stringify(items);
    const cantidadSpan = document.getElementById(`cantidad-${peticionId}-${itemIndex}`);
    const itemText = document.getElementById(`item-text-${peticionId}-${itemIndex}`);
    let stockWarning = '';
    const product = productos.find(p => p.id === items[itemIndex].id);
    if (product && items[itemIndex].cantidad > (product.stock || 0)) {
      stockWarning = '<span style="color: red;"> Falta stock</span>';
    }
    if (cantidadSpan && itemText) {
      cantidadSpan.textContent = items[itemIndex].cantidad;
      itemText.innerHTML = `${items[itemIndex].nombre}: <span id="cantidad-${peticionId}-${itemIndex}">${items[itemIndex].cantidad}</span> x ${formatMoney(items[itemIndex].precio_unitario)} = ${formatMoney(items[itemIndex].subtotal)}${stockWarning}`;
    }
    const decreaseBtn = document.querySelector(`#items-${peticionId} .item[data-item-index="${itemIndex}"] .decrease`);
    if (decreaseBtn) decreaseBtn.disabled = items[itemIndex].cantidad <= 1;
    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
    const totalSpan = document.getElementById(`total-${peticionId}`);
    if (totalSpan) totalSpan.textContent = formatMoney(total);
  }
  function eliminarItemPeticion(peticionId, itemIndex) {
    if (!confirm('¿Eliminar este item de la petición?')) return;
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    if (!peticionDiv) return;
    let items = JSON.parse(peticionDiv.dataset.items || '[]');
    items = items.filter((_, idx) => idx !== itemIndex);
    peticionDiv.dataset.items = JSON.stringify(items);
    const itemsContainer = document.getElementById(`items-${peticionId}`);
    if (itemsContainer) {
      itemsContainer.innerHTML = items.length > 0 ? items.map((item, index) => {
        let stockWarning = '';
        const product = productos.find(p => p.id === item.id);
        if (product && item.cantidad > (product.stock || 0)) stockWarning = '<span style="color: red;"> Falta stock</span>';
        return `
        <div class="item" data-item-index="${index}">
          <span id="item-text-${peticionId}-${index}">${item.nombre}: <span id="cantidad-${peticionId}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}${stockWarning}</span>
          <div class="item-controls">
            <button class="increase" onclick="modificarCantidad('${peticionId}', ${index}, 1)">+</button>
            <button class="decrease" onclick="modificarCantidad('${peticionId}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
            <button class="delete" onclick="eliminarItemPeticion('${peticionId}', ${index})">Eliminar</button>
          </div>
        </div>
      `;
      }).join('') : '<p>No hay items en esta petición.</p>';
      const total = items.reduce((sum, it) => sum + it.subtotal, 0);
      const totalSpan = document.getElementById(`total-${peticionId}`);
      if (totalSpan) totalSpan.textContent = formatMoney(total);
    }
  }
  async function eliminarPeticion(peticionId) {
    if (!confirm('¿Eliminar esta petición?')) return;
    try {
      const deleteRes = await fetch(`${apiBase}/peticiones/${peticionId}`, { method: 'DELETE', cache: 'no-store' });
      if (!deleteRes.ok) throw new Error(`HTTP ${deleteRes.status}`);
      alert('Petición eliminada con éxito.');
      const openStates = getOpenStates();
      await cargarPeticiones();
      restoreOpenStates(openStates);
    } catch (err) {
      mostrarError(`Error al eliminar petición: ${err.message}`);
    }
  }
  async function confirmarPeticion(peticionId, subtractThreePercent) {
    if (!confirm(`¿Confirmar esta petición${subtractThreePercent ? ' con -3%' : ''}?`)) return;
    try {
      if (usedButtons[peticionId]) return alert('Ya fue confirmado.');
      const peticionDiv = document.getElementById(`peticion-${peticionId}`);
      if (!peticionDiv) throw new Error('Petición no encontrada');
      const items = JSON.parse(peticionDiv.dataset.items || '[]');
      if (items.length === 0) return alert('No hay items');
      const summary = peticionDiv.querySelector('summary');
      const nombre = summary.textContent.split(' - ')[1].split(' - ')[0];
      const pedidoItems = items.map(item => ({
        id: item.id,
        cantidad: item.cantidad,
        precio: subtractThreePercent ? item.precio_unitario * 0.97 : item.precio_unitario
      }));
      const payload = { user: nombre, pedido: pedidoItems };
      const saveRes = await fetch(`${apiBase}/guardar-pedidos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      if (!saveRes.ok) throw new Error(`HTTP ${saveRes.status}`);
      const deleteRes = await fetch(`${apiBase}/peticiones/${peticionId}`, { method: 'DELETE', cache: 'no-store' });
      if (!deleteRes.ok) throw new Error(`HTTP ${deleteRes.status}`);
      usedButtons[peticionId] = subtractThreePercent ? 'plus7' : 'normal';
      saveUsedButtons();
      alert(`Petición confirmada${subtractThreePercent ? ' con -3%' : ''} correctamente.`);
      const openStates = getOpenStates();
      const savedScroll = window.scrollY;
      await Promise.all([cargarPedidos(), cargarPeticiones(), cargarUsuarios()]);
      restoreOpenStates(openStates);
      setTimeout(() => window.scrollTo(0, savedScroll), 100);
    } catch (err) {
      mostrarError(`Error al confirmar petición: ${err.message}`);
    }
  }
  async function previewPDF(peticionId) {
    try {
      const peticionDiv = document.getElementById(`peticion-${peticionId}`);
      if (!peticionDiv) throw new Error('Petición no encontrada');
      const items = JSON.parse(peticionDiv.dataset.items || '[]');
      const nombre = peticionDiv.dataset.nombre;
      const payload = {
        user: nombre,
        items: items.map(item => ({
          id: item.id,
          nombre: item.nombre,
          cantidad: item.cantidad,
          precio_unitario: item.precio_unitario * 0.97 * 1.10,
          subtotal: item.cantidad * (item.precio_unitario * 0.97 * 1.10)
        })),
        total: items.reduce((sum, item) => sum + item.cantidad * (item.precio_unitario * 0.97 * 1.10), 0),
        fecha: new Date().toISOString()
      };
      const saveRes = await fetch(`${apiBase}/generar-pdf-peticion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      if (!saveRes.ok) throw new Error(`HTTP ${saveRes.status}`);
      const data = await saveRes.json();
      if (data.ok && data.pdf) window.open(data.pdf, '_blank');
    } catch (err) {
      mostrarError(`Error al generar PDF: ${err.message}`);
    }
  }
  function copiarFaltantes(peticionId) {
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    if (!peticionDiv) return alert('Petición no encontrada');
    const items = JSON.parse(peticionDiv.dataset.items);
    let faltantes = [];
    for (const item of items) {
      const product = productos.find(p => p.id === item.id);
      const stock = product ? Math.max(product.stock || 0, 0) : 0;
      const missing = Math.max(0, item.cantidad - stock);
      if (missing > 0) faltantes.push(`${missing} ${item.nombre}`);
    }
    const textToCopy = faltantes.join('\n');
    navigator.clipboard.writeText(textToCopy).then(() => {
      alert('Faltantes copiados:\n' + textToCopy);
    }).catch(() => {
      alert('Error al copiar. Copia manual:\n' + textToCopy);
    });
  }
  function openAddModal(pedidoId) {
    currentPedidoId = pedidoId;
    document.getElementById('productsInput').value = '';
    document.getElementById('apply3percent').checked = false;
    document.getElementById('addProductModal').showModal();
  }
  function closeAddModal() {
    document.getElementById('addProductModal').close();
  }
  function addProductsToPedido() {
    const input = document.getElementById('productsInput').value.trim();
    const apply3 = document.getElementById('apply3percent').checked;
    if (!input) return alert('Ingrese productos');
    const entries = input.split(',').map(s => s.trim()).filter(s => s);
    const newItems = [];
    for (const ent of entries) {
      const [idStr, qtyStr] = ent.split('x').map(s => s.trim());
      const id = parseInt(idStr);
      const qty = parseInt(qtyStr) || 1;
      if (isNaN(id) || qty <= 0) continue;
      const product = productos.find(p => p.id === id);
      if (!product) continue;
      let precio = product.precio * 1.10;
      if (apply3) precio *= 0.97;
      const subtotal = qty * precio;
      newItems.push({
        id: product.id,
        nombre: product.nombre,
        cantidad: qty,
        precio_unitario: precio,
        subtotal
      });
    }
    if (newItems.length === 0) return alert('No se encontraron productos válidos');
    const pedidoDiv = document.getElementById(`pedido-${currentPedidoId}`);
    if (!pedidoDiv) return alert('Pedido no encontrado');
    let items = JSON.parse(pedidoDiv.dataset.items || '[]');
    newItems.forEach(newItem => {
      const existingIndex = items.findIndex(i => i.id === newItem.id);
      if (existingIndex >= 0) {
        items[existingIndex].cantidad += newItem.cantidad;
        items[existingIndex].subtotal = items[existingIndex].cantidad * items[existingIndex].precio_unitario;
      } else {
        items.push(newItem);
      }
    });
    pedidoDiv.dataset.items = JSON.stringify(items);
    const itemsContainer = document.getElementById(`items-${currentPedidoId}`);
    if (itemsContainer) {
      itemsContainer.innerHTML = items.map((item, index) => `
        <div class="item" data-item-index="${index}">
          <span id="item-text-${currentPedidoId}-${index}">${item.nombre}: <span id="cantidad-${currentPedidoId}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}</span>
          <div class="item-controls">
            <button class="increase" onclick="modificarCantidadPedido('${currentPedidoId}', ${index}, 1)">+</button>
            <button class="decrease" onclick="modificarCantidadPedido('${currentPedidoId}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
            <button class="delete" onclick="eliminarItemPedido('${currentPedidoId}', ${index})">Eliminar</button>
          </div>
        </div>
      `).join('');
    }
    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
    const totalSpan = document.getElementById(`total-${currentPedidoId}`);
    if (totalSpan) totalSpan.textContent = formatMoney(total);
    closeAddModal();
  }
  async function init() {
    try {
      await cargarProductos();
      await cargarPedidos();
      await cargarUsuarios();
      await cargarPeticiones();
    } catch (err) {
      console.error('Error en init:', err);
      mostrarError('Error al inicializar la página.');
    }
  }
  window.onload = init;
  </script>
</body>
</html>
