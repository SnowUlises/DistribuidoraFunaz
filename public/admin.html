<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administración - Distribuidora Funaz</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #333;
      padding: 2em;
    }
    header {
      background: #4a90e2;
      color: white;
      text-align: center;
      padding: 1.5em 0;
      font-size: 2em;
      font-weight: bold;
      user-select: none;
      margin-bottom: 2em;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    button.btn-volver {
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 1.5em;
      display: inline-block;
    }
    button.btn-volver:hover {
      background: #357ABD;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
    }
    details {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1.5em;
      padding: 1.5em;
      cursor: pointer;
      transition: box-shadow 0.3s;
    }
    details[open] {
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    summary {
      font-size: 1.4em;
      font-weight: 600;
      outline: none;
      list-style: none;
      cursor: pointer;
      user-select: none;
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    summary::before {
      content: "▶";
      display: inline-block;
      transition: transform 0.3s ease;
    }
    details[open] summary::before {
      transform: rotate(90deg);
    }
    .usuario-item, .peticion-item {
      background: #eef3f7;
      border-radius: 8px;
      margin-bottom: 1em;
      padding: 1em;
      box-shadow: inset 0 0 5px #bbb;
    }
    .peticion-details {
      margin-bottom: 1em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
    }
    .peticion-details summary {
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      margin-bottom: 0.5em;
      color: #3a3a3a;
    }
    .peticion-info {
      margin-bottom: 0.8em;
      font-size: 0.95em;
    }
    .peticion-items {
      margin-top: 0.5em;
      padding-left: 1em;
    }
    .item {
      margin: 0.5em 0;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .item-controls {
      display: flex;
      gap: 0.5em;
    }
    .item-controls button {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .item-controls button.increase {
      background: #28a745;
      color: white;
    }
    .item-controls button.increase:hover {
      background: #218838;
    }
    .item-controls button.decrease {
      background: #ffc107;
      color: black;
    }
    .item-controls button.decrease:hover {
      background: #e0a800;
    }
    .item-controls button.delete {
      background: #dc3545;
      color: white;
    }
    .item-controls button.delete:hover {
      background: #c82333;
    }
    .status-container {
      display: flex;
      gap: 1em;
      align-items: center;
      margin-top: 0.5em;
    }
    .status-container label {
      font-size: 0.9em;
      cursor: pointer;
      user-select: none;
    }
    .status-container input[type="checkbox"] {
      margin-right: 4px;
    }
    .button-group {
      display: flex;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    button.confirmar {
      background: #28a745;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.confirmar:hover {
      background: #218838;
    }
    button.confirmar-plus {
      background: #17a2b8;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.confirmar-plus:hover {
      background: #138496;
    }
    button.preview-pdf {
      background: #6c757d;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.preview-pdf:hover {
      background: #5a6268;
    }
    button.delete-peticion {
      background: #dc3545;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.delete-peticion:hover {
      background: #c82333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      color: #d9534f;
      font-weight: bold;
      margin-top: 0.5em;
    }
    #mensajeError {
      margin-bottom: 1em;
      color: red;
      font-weight: bold;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    footer {
      text-align: center;
      color: #777;
      margin-top: 2em;
    }
  </style>
</head>
<body>
  <header>Panel de administración</header>
  <main>
    <button class="btn-volver" onclick="location.href='index.html'">← Volver a tienda</button>
    <div id="mensajeError"></div>
    <details>
      <summary>Usuarios y pedidos</summary>
      <div id="listaUsuarios"></div>
    </details>
    <details>
      <summary>Peticiones</summary>
      <div id="listaPeticiones"></div>
    </details>
  </main>
  <footer>
    Distribuidora Funaz
  </footer>
  <script>
    const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';
    // Security check
    const user = localStorage.getItem('loggedUser');
    if (user !== 'admin') {
      window.location.href = 'index.html';
    }
    // States
    let estadosPedidos = JSON.parse(localStorage.getItem('estadosPedidos') || '{}');
    const usedButtons = JSON.parse(localStorage.getItem('usedButtons') || '{}');
    let productos = [];
    function guardarEstados() {
      localStorage.setItem('estadosPedidos', JSON.stringify(estadosPedidos));
    }
    function saveUsedButtons() {
      localStorage.setItem('usedButtons', JSON.stringify(usedButtons));
    }
    function mostrarError(msg) {
      const el = document.getElementById('mensajeError');
      if (el) el.textContent = msg;
      else console.warn('mensajeError no encontrado:', msg);
    }
    // Toggle functions
    function toggleGuardado(usuario, idx, el) {
      const key = `${usuario}-${idx}`;
      const nuevo = !!el.checked;
      const confirmado = confirm(nuevo
        ? '¿Marcar pedido como guardado?'
        : '¿Desmarcar pedido guardado?');
      if (!confirmado) { el.checked = !nuevo; return; }
      estadosPedidos[key] = { ...estadosPedidos[key], guardado: nuevo };
      guardarEstados();
    }
    function toggleRecibido(usuario, idx, el) {
      const key = `${usuario}-${idx}`;
      const nuevo = !!el.checked;
      const confirmado = confirm(nuevo
        ? '¿Marcar pedido como recibido?'
        : '¿Desmarcar pedido recibido?');
      if (!confirmado) { el.checked = !nuevo; return; }
      estadosPedidos[key] = { ...estadosPedidos[key], recibido: nuevo };
      guardarEstados();
    }
    // Load usuarios y pedidos (unchanged)
    async function cargarUsuarios() {
      try {
        const listaPedidos = document.getElementById('listaUsuarios');
        if (!listaPedidos) {
          console.error('Elemento listaUsuarios no encontrado en el DOM');
          mostrarError('Error: listaUsuarios no encontrado en el DOM');
          return;
        }
        listaPedidos.innerHTML = '<p>Cargando pedidos...</p>';
        const res = await fetch(`${apiBase}/pedidos`, { cache: 'no-store' });
        if (!res.ok) {
          console.warn('Error al cargar pedidos:', res.status, await res.text().catch(() => ''));
          mostrarError(`Error al cargar pedidos de ${apiBase}/pedidos: HTTP ${res.status}`);
          listaPedidos.innerHTML = '<p>No se pudieron cargar los pedidos.</p>';
          return;
        }
        const pedidosRaw = await res.json();
        console.log('Pedidos cargados:', pedidosRaw);
        const pedidosPorUsuario = {};
        pedidosRaw.forEach(p => {
          const user = p.user || 'Invitado';
          if (!pedidosPorUsuario[user]) pedidosPorUsuario[user] = [];
          pedidosPorUsuario[user].push(p);
        });
        listaPedidos.innerHTML = '';
        if (Object.keys(pedidosPorUsuario).length === 0) {
          listaPedidos.innerHTML = '<p>No hay pedidos registrados.</p>';
          return;
        }
        Object.entries(pedidosPorUsuario).forEach(([userName, userPedidos]) => {
          userPedidos.sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));
          const userDiv = document.createElement('details');
          userDiv.className = 'user-details';
          let pedidosHTML = '<ul>';
          userPedidos.forEach((pedido, index) => {
            const items = Array.isArray(pedido.items) ? pedido.items : [];
            const pedidoId = pedido.id ?? `${userName}-${index}`;
            const key = `${userName}-${index}`;
            const estado = estadosPedidos[key] || {};
            const total = items.reduce((sum, p) => {
              const precio = p.precio_unitario ?? p.precio ?? 0;
              return sum + precio * (p.cantidad ?? 1);
            }, 0);
            pedidosHTML += `<li>
              <div class="pedido-line">
                <strong>Pedido #${index + 1}</strong> (ID: ${pedidoId}) - <b>Total: $${total.toFixed(2)}</b>
              </div>
              <ul>
                ${(items.map(p => {
                  const precio = p.precio_unitario ?? p.precio ?? 0;
                  return `<li>${p.nombre} x${p.cantidad ?? 1} - $${precio.toFixed(2)}</li>`;
                })).join('')}
              </ul>
              <div class="pedido-actions">
                <button onclick="eliminarPedido('${pedidoId}', '${userName}', ${index})">Eliminar pedido</button>
                <button class="guardar-btn" data-pedidoid="${pedidoId}" data-username="${userName}" data-index="${index}">
                  Guardar pedido
                </button>
                <span class="guardar-status" id="guardar-status-${pedidoId}" aria-hidden="true">
                  ${estado.guardado ? '✅ Guardado' : ''}
                </span>
              </div>
              <div class='status-container'>
                <label><input type='checkbox' ${estado.guardado ? 'checked' : ''} onchange="toggleGuardado('${userName}',${index}, this)"> Guardado</label>
                <label><input type='checkbox' ${estado.recibido ? 'checked' : ''} onchange="toggleRecibido('${userName}',${index}, this)"> Recibido</label>
              </div>
            </li>`;
          });
          pedidosHTML += '</ul>';
          userDiv.innerHTML = `<summary>${userName}</summary>
            <div class='usuario-item'>${pedidosHTML}</div>`;
          listaPedidos.appendChild(userDiv);
          userDiv.querySelectorAll('.guardar-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const pedidoId = btn.dataset.pedidoid;
              const username = btn.dataset.username;
              const idx = Number(btn.dataset.index);
              const statusSpan = document.getElementById(`guardar-status-${pedidoId}`);
              if (statusSpan) statusSpan.textContent = '⏳ Guardando...';
              try {
                await guardarPedido(pedidoId);
                if (statusSpan) statusSpan.textContent = '✅ Guardado';
                const key = `${username}-${idx}`;
                estadosPedidos[key] = estadosPedidos[key] || {};
                estadosPedidos[key].guardado = true;
                guardarEstados();
              } catch (err) {
                if (statusSpan) statusSpan.textContent = '❌ Error';
                console.error('Error al guardar pedido:', err);
                mostrarError(`Error al guardar pedido ${pedidoId}: ${err.message}`);
              }
            });
          });
        });
      } catch (err) {
        console.error('Error en cargarUsuarios:', err);
        mostrarError('Error inesperado al cargar usuarios y pedidos.');
        const listaPedidos = document.getElementById('listaUsuarios');
        if (listaPedidos) listaPedidos.innerHTML = '<p>Error al cargar pedidos.</p>';
      }
    }
    async function guardarPedido(pedidoId) {
      try {
        const r = await fetch(`${apiBase}/pedidos/${pedidoId}/pdf`, { cache: 'no-store' });
        if (!r.ok) {
          const txt = await r.text().catch(() => '');
          throw new Error(`Error del servidor: ${r.status} ${txt}`);
        }
        const data = await r.json();
        if (data.ok && data.pdf) {
          window.open(data.pdf, '_blank');
        } else {
          throw new Error('No se pudo generar el PDF');
        }
      } catch (err) {
        console.error('No se pudo generar el PDF:', err);
        throw err;
      }
    }
    async function eliminarPedido(pedidoId, usuario, index) {
  if (!confirm('¿Eliminar este pedido?')) return;
  try {
    const key = `${usuario}-${index}`;
    const estado = estadosPedidos[key] || {};
    const esRecibido = estado.recibido || false;
    console.log(`Eliminando pedido ${pedidoId}, recibido: ${esRecibido}`); // Log para depuración
    const res = await fetch(`${apiBase}/eliminar-pedido/${encodeURIComponent(pedidoId)}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recibido: esRecibido }),
      cache: 'no-store'
    });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      console.warn('Error del servidor al eliminar pedido:', res.status, txt);
      mostrarError(`No se pudo eliminar el pedido en ${apiBase}/eliminar-pedido/${pedidoId}: HTTP ${res.status}`);
      return;
    }
    delete estadosPedidos[key];
    guardarEstados();
    await cargarPedidos();
    await cargarUsuarios();
    alert('Pedido eliminado correctamente.');
  } catch (err) {
    console.error('Error al eliminar pedido:', err);
    mostrarError(`Error de red al eliminar pedido: ${err.message}`);
  }
}
    async function cargarPedidos() {
      try {
        const res = await fetch(`${apiBase}/pedidos`, { cache: 'no-store' });
        if (!res.ok) {
          console.warn('No se pudieron cargar pedidos:', res.status, await res.text().catch(() => ''));
          mostrarError(`Error al cargar pedidos de ${apiBase}/pedidos: HTTP ${res.status}`);
          return;
        }
        const data = await res.json();
        localStorage.setItem('pedidos', JSON.stringify(data));
        console.log('Pedidos guardados en localStorage:', data);
      } catch (err) {
        console.error('Error cargando pedidos:', err);
        mostrarError(`Error de red al cargar pedidos: ${err.message}`);
      }
    }
    function formatMoney(n) {
      try {
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(n);
      } catch (e) {
        return '$' + Number(n).toFixed(2);
      }
    }
    async function cargarProductos() {
      try {
        const res = await fetch(`${apiBase}/productos`, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`Error al cargar productos: HTTP ${res.status}`);
        }
        productos = await res.json();
        console.log('Productos cargados:', productos);
      } catch (err) {
        console.error('Error en cargarProductos:', err);
        mostrarError('Error al cargar productos para verificación de stock.');
      }
    }
    async function cargarPeticiones() {
      try {
        const listaPeticiones = document.getElementById('listaPeticiones');
        if (!listaPeticiones) {
          console.error('Elemento listaPeticiones no encontrado en el DOM');
          mostrarError('Error: listaPeticiones no encontrado en el DOM');
          return;
        }
        listaPeticiones.innerHTML = '<p>Cargando peticiones...</p>';
        const res = await fetch(`${apiBase}/peticiones`, { cache: 'no-store' });
        if (!res.ok) {
          console.warn('Error al cargar peticiones:', res.status, await res.text().catch(() => ''));
          mostrarError(`Error al cargar peticiones de ${apiBase}/peticiones: HTTP ${res.status}`);
          listaPeticiones.innerHTML = '<p>No se pudieron cargar las peticiones.</p>';
          return;
        }
        const peticiones = await res.json();
        console.log('Peticiones cargadas:', peticiones);
        listaPeticiones.innerHTML = '';
        if (peticiones.length === 0) {
          listaPeticiones.innerHTML = '<p>No hay peticiones registradas.</p>';
          return;
        }
        peticiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        peticiones.forEach(peticion => {
          const peticionDiv = document.createElement('details');
          peticionDiv.className = 'peticion-details';
          peticionDiv.id = `peticion-${peticion.id}`;
          const isUsed = usedButtons[peticion.id];
          peticionDiv.dataset.items = JSON.stringify(peticion.items);
          peticionDiv.dataset.nombre = peticion.nombre;
          peticionDiv.innerHTML = `
            <summary>Petición ID: ${peticion.id} - Nombre: ${peticion.nombre} - Fecha: ${new Date(peticion.fecha).toLocaleDateString('es-AR')}</summary>
            <div class="peticion-item">
              <div class="peticion-info">
                <strong>Teléfono:</strong> ${peticion.telefono}
                <strong>Total:</strong> <span id="total-${peticion.id}">${formatMoney(peticion.total)}</span>
                <div class="peticion-items" id="items-${peticion.id}">
                  ${peticion.items.map((item, index) => {
                    let stockWarning = '';
                    const product = productos.find(p => p.id === item.id);
                    if (product && item.cantidad > (product.stock || 0)) {
                      stockWarning = '<span style="color: red;"> Falta stock</span>';
                    }
                    return `
                    <div class="item" data-item-index="${index}">
                      <span id="item-text-${peticion.id}-${index}">${item.nombre}: <span id="cantidad-${peticion.id}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}${stockWarning}</span>
                      <div class="item-controls">
                        <button class="increase" onclick="modificarCantidad('${peticion.id}', ${index}, 1)">+</button>
                        <button class="decrease" onclick="modificarCantidad('${peticion.id}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
                        <button class="delete" onclick="eliminarItemPeticion('${peticion.id}', ${index})">Eliminar</button>
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
                ${isUsed ? `<div class="status">Estado: ${isUsed === 'normal' ? 'Confirmado' : 'Confirmado -3%'}</div>` : `
                  <div class="button-group">
                    <button class="confirmar" onclick="confirmarPeticion(${peticion.id}, false)">Confirmar Pedido</button>
                    <button class="confirmar-plus" onclick="confirmarPeticion(${peticion.id}, true)">Confirmar Pedido -3%</button>
                    <button class="preview-pdf" onclick="previewPDF(${peticion.id})">Descargar PDF Preview</button>
                    <button class="delete-peticion" onclick="eliminarPeticion(${peticion.id})">Eliminar Petición</button>
                  </div>
                `}
              </div>
            </div>
          `;
          listaPeticiones.appendChild(peticionDiv);
        });
      } catch (err) {
        console.error('Error en cargarPeticiones:', err);
        mostrarError(`Error inesperado al cargar peticiones: ${err.message}`);
        const listaPeticiones = document.getElementById('listaPeticiones');
        if (listaPeticiones) listaPeticiones.innerHTML = '<p>Error al cargar peticiones.</p>';
      }
    }
    function modificarCantidad(peticionId, itemIndex, change) {
      console.log(`Modificando cantidad: peticionId=${peticionId}, itemIndex=${itemIndex}, change=${change}`);
      const peticionDiv = document.getElementById(`peticion-${peticionId}`);
      if (!peticionDiv) {
        console.error(`Petición ${peticionId} no encontrada en el DOM`);
        mostrarError(`Petición ${peticionId} no encontrada`);
        return;
      }
      let items = JSON.parse(peticionDiv.dataset.items || '[]');
      if (!items[itemIndex]) {
        console.error(`Item ${itemIndex} no encontrado en petición ${peticionId}`);
        return;
      }
      items[itemIndex].cantidad = Math.max(1, (items[itemIndex].cantidad || 1) + change);
      items[itemIndex].subtotal = items[itemIndex].cantidad * items[itemIndex].precio_unitario;
      peticionDiv.dataset.items = JSON.stringify(items);
      const cantidadSpan = document.getElementById(`cantidad-${peticionId}-${itemIndex}`);
      const itemText = document.getElementById(`item-text-${peticionId}-${itemIndex}`);
      let stockWarning = '';
      const product = productos.find(p => p.id === items[itemIndex].id);
      if (product && items[itemIndex].cantidad > (product.stock || 0)) {
        stockWarning = '<span style="color: red;"> Falta stock</span>';
      }
      if (cantidadSpan && itemText) {
        cantidadSpan.textContent = items[itemIndex].cantidad;
        itemText.innerHTML = `${items[itemIndex].nombre}: <span id="cantidad-${peticionId}-${itemIndex}">${items[itemIndex].cantidad}</span> x ${formatMoney(items[itemIndex].precio_unitario)} = ${formatMoney(items[itemIndex].subtotal)}${stockWarning}`;
      } else {
        console.error(`Elementos cantidad-${peticionId}-${itemIndex} o item-text-${peticionId}-${itemIndex} no encontrados`);
      }
      const decreaseBtn = document.querySelector(`#items-${peticionId} .item[data-item-index="${itemIndex}"] .decrease`);
      if (decreaseBtn) {
        decreaseBtn.disabled = items[itemIndex].cantidad <= 1;
      }
      const total = items.reduce((sum, it) => sum + it.subtotal, 0);
      const totalSpan = document.getElementById(`total-${peticionId}`);
      if (totalSpan) {
        totalSpan.textContent = formatMoney(total);
      } else {
        console.error(`Total span total-${peticionId} no encontrado`);
      }
    }
    function eliminarItemPeticion(peticionId, itemIndex) {
      if (!confirm('¿Eliminar este item de la petición?')) return;
      console.log(`Eliminando item: peticionId=${peticionId}, itemIndex=${itemIndex}`);
      const peticionDiv = document.getElementById(`peticion-${peticionId}`);
      if (!peticionDiv) {
        console.error(`Petición ${peticionId} no encontrada en el DOM`);
        mostrarError(`Petición ${peticionId} no encontrada`);
        return;
      }
      let items = JSON.parse(peticionDiv.dataset.items || '[]');
      if (!items[itemIndex]) {
        console.error(`Item ${itemIndex} no encontrado en petición ${peticionId}`);
        return;
      }
      items = items.filter((_, idx) => idx !== itemIndex);
      peticionDiv.dataset.items = JSON.stringify(items);
      const itemsContainer = document.getElementById(`items-${peticionId}`);
      if (itemsContainer) {
        itemsContainer.innerHTML = items.length > 0 ? items.map((item, index) => {
          let stockWarning = '';
          const product = productos.find(p => p.id === item.id);
          if (product && item.cantidad > (product.stock || 0)) {
            stockWarning = '<span style="color: red;"> Falta stock</span>';
          }
          return `
          <div class="item" data-item-index="${index}">
            <span id="item-text-${peticionId}-${index}">${item.nombre}: <span id="cantidad-${peticionId}-${index}">${item.cantidad}</span> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}${stockWarning}</span>
            <div class="item-controls">
              <button class="increase" onclick="modificarCantidad('${peticionId}', ${index}, 1)">+</button>
              <button class="decrease" onclick="modificarCantidad('${peticionId}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
              <button class="delete" onclick="eliminarItemPeticion('${peticionId}', ${index})">Eliminar</button>
            </div>
          </div>
        `;
        }).join('') : '<p>No hay items en esta petición.</p>';
        const total = items.reduce((sum, it) => sum + it.subtotal, 0);
        const totalSpan = document.getElementById(`total-${peticionId}`);
        if (totalSpan) {
          totalSpan.textContent = formatMoney(total);
        }
      } else {
        console.error(`Items container items-${peticionId} no encontrado`);
      }
    }
    async function eliminarPeticion(peticionId) {
      if (!confirm('¿Eliminar esta petición?')) return;
      console.log(`Eliminando petición: ${peticionId}`);
      try {
        const deleteRes = await fetch(`${apiBase}/peticiones/${peticionId}`, {
          method: 'DELETE',
          cache: 'no-store'
        });
        if (!deleteRes.ok) {
          const txt = await deleteRes.text().catch(() => '');
          throw new Error(`HTTP ${deleteRes.status}: ${txt}`);
        }
        alert('Petición eliminada con éxito.');
        await cargarPeticiones();
      } catch (err) {
        console.error('Error al eliminar petición:', err);
        mostrarError(`No se pudo eliminar la petición ${peticionId}: ${err.message}`);
      }
    }
    async function confirmarPeticion(peticionId, subtractThreePercent) {
      try {
        if (usedButtons[peticionId]) {
          alert('Este pedido ya ha sido confirmado.');
          return;
        }
        const peticionDiv = document.getElementById(`peticion-${peticionId}`);
        if (!peticionDiv) {
          throw new Error('Petición no encontrada en el DOM');
        }
        const items = JSON.parse(peticionDiv.dataset.items || '[]');
        if (!items || items.length === 0) {
          alert('No hay items en la petición para confirmar.');
          return;
        }
        const summary = peticionDiv.querySelector('summary');
        if (!summary) {
          throw new Error('Summary no encontrado para la petición');
        }
        const nombre = summary.textContent.split(' - ')[1].split(' - ')[0];
        const pedidoItems = items.map(item => ({
          id: item.id,
          cantidad: item.cantidad,
          precio: subtractThreePercent ? item.precio_unitario * 0.97 : item.precio_unitario
        }));
        const payload = {
          user: nombre,
          pedido: pedidoItems
        };
        console.log('💾 Enviando a guardar-pedidos:', JSON.stringify(payload, null, 2));
        const saveRes = await fetch(`${apiBase}/guardar-pedidos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          cache: 'no-store'
        });
        if (!saveRes.ok) {
          const txt = await saveRes.json().catch(() => ({ error: `HTTP ${saveRes.status}` }));
          throw new Error(txt.error || `HTTP ${saveRes.status}`);
        }
        console.log(`Eliminando petición ${peticionId}`);
        const deleteRes = await fetch(`${apiBase}/peticiones/${peticionId}`, {
          method: 'DELETE',
          cache: 'no-store'
        });
        if (!deleteRes.ok) {
          const txt = await deleteRes.json().catch(() => ({ error: `HTTP ${deleteRes.status}` }));
          throw new Error(txt.error || `HTTP ${deleteRes.status}`);
        }
        usedButtons[peticionId] = subtractThreePercent ? 'plus7' : 'normal';
        saveUsedButtons();
        alert(`Petición ${subtractThreePercent ? 'confirmada con -3%' : 'confirmada'} y eliminada con éxito.`);
        await Promise.all([cargarPedidos(), cargarPeticiones(), cargarUsuarios()]);
      } catch (err) {
        console.error('Error en confirmarPeticion:', err);
        mostrarError(`No se pudo confirmar la petición ${peticionId}: ${err.message}`);
      }
    }
    async function previewPDF(peticionId) {
      try {
        const peticionDiv = document.getElementById(`peticion-${peticionId}`);
        if (!peticionDiv) {
          throw new Error('Petición no encontrada en el DOM');
        }
        const items = JSON.parse(peticionDiv.dataset.items || '[]');
        if (!items || items.length === 0) {
          alert('No hay items en la petición para previsualizar.');
          return;
        }
        const nombre = peticionDiv.dataset.nombre;
        const payload = {
          user: nombre,
          items: items.map(item => ({
            id: item.id,
            nombre: item.nombre,
            cantidad: item.cantidad,
            precio_unitario: item.precio_unitario * 0.97 * 1.10,
            subtotal: item.cantidad * (item.precio_unitario * 0.97 * 1.10)
          })),
          total: items.reduce((sum, item) => sum + item.cantidad * (item.precio_unitario * 0.97 * 1.10), 0),
          fecha: new Date().toISOString()
        };
        console.log('📄 Enviando a generar-pdf-peticion:', JSON.stringify(payload, null, 2));
        const saveRes = await fetch(`${apiBase}/generar-pdf-peticion`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          cache: 'no-store'
        });
        if (!saveRes.ok) {
          const txt = await saveRes.json().catch(() => ({ error: `HTTP ${saveRes.status}` }));
          throw new Error(txt.error || `HTTP ${saveRes.status}`);
        }
        const data = await saveRes.json();
        if (data.ok && data.pdf) {
          window.open(data.pdf, '_blank');
        } else {
          throw new Error('No se pudo generar el PDF de preview');
        }
      } catch (err) {
        console.error('Error en previewPDF:', err);
        mostrarError(`No se pudo generar el PDF de preview para la petición ${peticionId}: ${err.message}`);
      }
    }
    async function init() {
      try {
        console.log('Iniciando carga de datos...');
        await cargarProductos();
        await cargarPedidos();
        await cargarUsuarios();
        await cargarPeticiones();
        console.log('Inicialización completada');
      } catch (err) {
        console.error('Error en init:', err);
        mostrarError('Error al inicializar la página. Revisa la consola para más detalles.');
      }
    }
    window.onload = init;
  </script>
</body>
</html>

