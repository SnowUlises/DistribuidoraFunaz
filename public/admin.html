<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Distribuidora Funaz</title>
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --accent: #e8f5e9;
      --bg: #f0f2f5;
      --text: #2c3e50;
      --card-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --radius: 12px;
      --danger: #d32f2f;
      --warning: #f57c00;
      --info: #0288d1;
      
      /* Colores de Estado */
      --state-armando-bg: #fff3e0;
      --state-armando-border: #ffb74d;
      --state-armando-text: #ef6c00;
      --state-preparado-bg: #f1f8e9;
      --state-preparado-border: #76ff03;
      --state-preparado-text: #2e7d32;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 6em;
    }

    /* --- Header --- */
    header {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 1.5em 0;
      font-size: 1.8em;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
      margin-bottom: 2em;
    }

    main {
      max-width: 95%;
      margin: 0 auto;
      padding: 0 1.5em;
    }

    /* --- Controles Superiores --- */
    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2em;
    }

    .search-container {
      flex: 1;
      max-width: 400px;
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
      transition: border-color 0.3s;
    }
    .search-input:focus { border-color: var(--primary); }

    button.btn-volver {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button.btn-volver:hover { background: var(--primary); color: #fff; }

    #mensajeError {
      text-align: center;
      color: var(--danger);
      background: #ffebee;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 1em;
      border: 1px solid #ffcdd2;
      display: none;
    }
    #mensajeError:not(:empty) { display: block; }

    /* --- Toolbar Flotante --- */
    #groupToolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: flex;
      gap: 15px;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
    }
    #groupToolbar.visible { opacity: 1; pointer-events: all; transform: translateX(-50%) translateY(0); }
    #groupToolbar span { font-weight: 600; }
    #groupToolbar button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
    }
    #groupToolbar button.cancel { background: #666; }
    #groupToolbar button.bulk-cloud { background: var(--primary-light); display: none; }
    #groupToolbar button.bulk-pdf { background: var(--warning); display: none; }
    #btnGroupAction { display: none; }

    /* --- Checkboxes --- */
    .user-select-check, .peticion-check, .pedido-check {
      transform: scale(1.3);
      cursor: pointer;
      accent-color: var(--primary);
    }
    .user-select-check { margin-right: 15px; }
    .pedido-check { margin-right: 10px; margin-top: 5px; }

    /* --- Etiquetas --- */
    .sub-user-label, .business-label {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 5px;
    }
    .sub-user-label { background: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; }
    .business-label { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; margin-right: 5px; }

    /* --- Layout Principal (GRID DE CLIENTES) --- */
    #listaUsuarios, #listaPeticiones {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); 
      gap: 1.5em;
      margin-bottom: 2em;
    }

    /* --- Tarjeta de Cliente (Contenedor) --- */
    .user-details {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid #eee;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .user-details > summary {
      list-style: none;
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      padding: 1em;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      color: var(--text);
    }
    .user-details > summary::-webkit-details-marker { display: none; }
    .user-details[open] > summary { background: #e8f5e9; color: var(--primary); border-bottom: 1px solid #c8e6c9; }

    /* --- Grid INTERNO de Pedidos (Dentro del Cliente) --- */
    .usuario-item ul {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
        gap: 15px;
        padding: 15px;
        list-style: none;
        margin: 0;
    }

    /* --- Tarjeta de Pedido Individual --- */
    .pedido-item {
      background: #fff;
      border: 2px solid #eee;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s;
      height: 480px; /* Altura fija para scroll interno */
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Colores de Estado */
    .pedido-item.estado-armando { border-color: var(--state-armando-border); background-color: var(--state-armando-bg); }
    .pedido-item.estado-preparado { border-color: var(--state-preparado-border); background-color: var(--state-preparado-bg); }

    /* √Årea de Items con SCROLL */
    .peticion-items {
        flex: 1;
        overflow-y: auto;
        margin: 10px 0;
        padding-right: 5px;
        background: rgba(255,255,255,0.7);
        border-radius: 4px;
        border: 1px solid #eee;
    }
    .peticion-items::-webkit-scrollbar { width: 6px; }
    .peticion-items::-webkit-scrollbar-track { background: #f1f1f1; }
    .peticion-items::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* Enfocado */
    .pedido-item.enfocado {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        width: 90%; max-width: 600px; height: 85vh;
        box-shadow: 0 0 0 100vw rgba(0,0,0,0.6);
    }

    .pedido-line {
      font-size: 0.9em;
      margin-bottom: 0.5em;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding-bottom: 5px;
    }

    .item {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.9em; padding: 6px 0; border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .pedido-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .pedido-actions button { width: 100%; padding: 8px 4px; font-size: 0.85em; }

    /* SWITCH Armando/Preparado */
    .switch-container {
        display: flex; align-items: center; justify-content: space-between;
        background: rgba(255,255,255,0.6);
        padding: 5px 10px; border-radius: 20px; margin-top: 5px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .switch-label { font-weight: bold; font-size: 0.9em; text-transform: uppercase; }
    
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--state-armando-border); transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px;
      left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--state-preparado-border); }
    input:checked + .slider:before { transform: translateX(26px); }

    /* Botones */
    button { border: 1px solid #ddd; background: white; color: #555; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    button:hover { transform: translateY(-1px); }

    .guardar-btn { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; } /* Guardar Cloud */
    .preview-pdf { background: #fff3e0; color: #ef6c00; border-color: #ffe0b2; } /* PDF +3% */
    .delete { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .confirmar { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .ver-original { background: #f3e5f5; color: #7b1fa2; border-color: #e1bee7; }
    .add-product { color: var(--info); border-color: #b3e5fc; }

    /* Focus Dot */
    .focus-dot {
        width: 12px; height: 12px; border: 2px solid #ccc; border-radius: 50%;
        margin-left: auto; cursor: pointer;
    }
    .focus-dot.active { background-color: var(--primary); border-color: var(--primary); }
    .user-details.usuario-enfocado { border: 2px solid var(--primary); }

    /* Dialog */
    dialog {
      border: none; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      padding: 2em; width: 90%; max-width: 450px;
    }
    dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
    dialog input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; }

    footer { text-align: center; color: #888; font-size: 0.9em; margin-top: 4em; }

    @media (max-width: 600px) {
      #listaUsuarios, #listaPeticiones { grid-template-columns: 1fr; }
      .usuario-item ul { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>Panel de Administraci√≥n</header>
  
  <main>
    <div class="top-controls">
      <button class="btn-volver" onclick="location.href='index.html'">‚Üê Volver a tienda</button>
      <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="Buscar cliente o grupo..." onkeyup="filtrarUsuarios()">
      </div>
      <div id="mensajeError"></div>
    </div>

    <details open>
      <summary>Usuarios y Pedidos (Cuadr√≠cula)</summary>
      <div id="listaUsuarios"></div>
    </details>

    <details open style="margin-top: 2em;">
      <summary>Peticiones Pendientes</summary>
      <div style="margin-bottom: 1em; padding: 10px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <button onclick="copiarFaltantesGrupo()" style="background: var(--info); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Faltantes En Grupo</button>
        <button onclick="procesarPeticionesMasivas(false)" style="background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Aceptar Selecc.</button>
        <button onclick="procesarPeticionesMasivas(true)" style="background: #00838f; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Aceptar Selecc. (-3%)</button>
        <span id="peticionesSelectedCount" style="font-size: 0.9em; color: #555;">0 seleccionados</span>
      </div>
      <div id="listaPeticiones"></div>
    </details>
  </main>

  <div id="groupToolbar">
      <span id="selectedCount">0 seleccionados</span>
      <button onclick="handleGroupAction()" id="btnGroupAction">Crear Grupo</button>
      <button class="bulk-cloud" onclick="procesarPedidosMasivos('cloud')">Guardar Cloud</button>
      <button class="bulk-pdf" onclick="procesarPedidosMasivos('pdf')">PDF +3%</button>
      <button class="cancel" onclick="clearSelection()">Cancelar</button>
  </div>

  <footer>Distribuidora Funaz ¬© 2025</footer>

  <dialog id="addProductModal">
    <form onsubmit="event.preventDefault(); addProductsToPedido();">
      <label for="productsInput" style="font-weight:600; color:var(--primary)">Productos (IDxCantidad, separados por coma):</label>
      <input type="text" id="productsInput" placeholder="Ej: 353x5, 24x2">
      <label><input type="checkbox" id="apply3percent"> Aplicar -3%</label>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:1em;">
        <button type="button" onclick="closeAddModal()" style="background:#eee;">Cancelar</button>
        <button type="submit" style="background:var(--primary); color:white;">A√±adir</button>
      </div>
    </form>
  </dialog>

  <script>
  const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

  // Verificaci√≥n de Admin
  const user = localStorage.getItem('loggedUser');
  if (user !== 'admin') window.location.href = 'index.html';

  // --- Estado Global ---
  let originalPedidosCache = JSON.parse(localStorage.getItem('originalPedidosCache') || '{}');
  // estadosPedidos guardar√° { estado: 'armando'|'preparado', timestamp: ... }
  let estadosPedidos = JSON.parse(localStorage.getItem('estadosPedidos') || '{}');
  let groupsConfig = JSON.parse(localStorage.getItem('groupsConfig') || '{}'); 
  const usedButtons = JSON.parse(localStorage.getItem('usedButtons') || '{}');
  let productos = [];
  let currentPedidoId = null;
  window.usersPedidos = {};
  
  // Selecciones
  let selectedUsersForGroup = new Set();
  let selectedPedidoIds = new Set(); 

  // --- Limpieza de Cach√© Antigua (1 semana) ---
  function cleanOldCache() {
      const now = Date.now();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      let changed = false;
      Object.keys(originalPedidosCache).forEach(key => {
          const entry = originalPedidosCache[key];
          // Si tiene timestamp y es mayor a una semana, borrar
          if (entry.timestamp && (now - entry.timestamp > oneWeek)) {
              delete originalPedidosCache[key];
              changed = true;
          }
      });
      if(changed) guardarOriginalCache();
  }

  // --- Persistencia ---
  function guardarEstados() { localStorage.setItem('estadosPedidos', JSON.stringify(estadosPedidos)); }
  function saveUsedButtons() { localStorage.setItem('usedButtons', JSON.stringify(usedButtons)); }
  function guardarOriginalCache() { localStorage.setItem('originalPedidosCache', JSON.stringify(originalPedidosCache)); }
  function saveGroups() { localStorage.setItem('groupsConfig', JSON.stringify(groupsConfig)); }

  // --- UI Helpers ---
  function mostrarError(msg) {
    const el = document.getElementById('mensajeError');
    if (el) el.textContent = msg;
    setTimeout(() => { if(el) el.textContent = ''; }, 6000);
  }

  function formatMoney(n) {
    try {
      return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(n);
    } catch (e) { return '$' + Number(n).toFixed(2); }
  }

  function formatDateTime(fecha) {
    const date = new Date(fecha);
    const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return { 
        formattedDate: `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`,
        formattedTime: `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    };
  }

  function filtrarUsuarios() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.user-details').forEach(detail => {
          const name = detail.dataset.searchName.toLowerCase();
          detail.style.display = name.includes(query) ? '' : 'none';
      });
  }

  // ==================== L√ìGICA DE VISUALIZACI√ìN PEDIDOS ====================

  function enfocarPedido(pedidoId) {
    const selectedPedido = document.getElementById(`pedido-${pedidoId}`);
    if (!selectedPedido) return;
    
    const btn = selectedPedido.querySelector('.enfocar');
    const estaEnfocado = selectedPedido.classList.contains('enfocado');
    
    // Resetear otros
    document.querySelectorAll('.pedido-item').forEach(p => {
      p.classList.remove('enfocado');
      const b = p.querySelector('.enfocar');
      if (b) b.textContent = 'Enfocar';
    });

    if (!estaEnfocado) {
      selectedPedido.classList.add('enfocado');
      btn.textContent = 'Cerrar';
    } 
  }

  function renderItemsHTML(pedidoId, items, editable = true) {
    return items.map((item, itemIndex) => `
      <div class="item" ${editable ? `data-item-index="${itemIndex}"` : ''}>
        <span id="item-text-${pedidoId}-${itemIndex}" style="flex:1; padding-right:10px;">
            ${item.nombre}: <b>${item.cantidad}</b> x ${formatMoney(item.precio_unitario)} = <b>${formatMoney(item.subtotal)}</b>
        </span>
        ${editable ? `
        <div style="display:flex; gap:2px;">
          <button class="increase" style="padding:2px 6px; background:#dcedc8;" onclick="modificarCantidadPedido('${pedidoId}', ${itemIndex}, 1)">+</button>
          <button class="decrease" style="padding:2px 6px; background:#fff9c4;" onclick="modificarCantidadPedido('${pedidoId}', ${itemIndex}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
          <button class="delete" style="padding:2px 6px;" onclick="eliminarItemPedido('${pedidoId}', ${itemIndex})">√ó</button>
        </div>
        ` : ''}
      </div>
    `).join('');
  }

  function updatePedidoItems(pedidoId, items, editable = true) {
    const container = document.getElementById(`items-${pedidoId}`);
    if (!container) return;
    container.innerHTML = renderItemsHTML(pedidoId, items, editable);
    const total = items.reduce((acc, item) => acc + item.subtotal, 0);
    const totalSpan = document.getElementById(`total-${pedidoId}`);
    if (totalSpan) totalSpan.textContent = formatMoney(total);
  }

  // --- SWITCH DE ESTADO (ARMANDO / PREPARADO) ---
  function syncStatus(pedidoId, isPreparado) {
      // 1. Guardar localmente
      if (!estadosPedidos[pedidoId]) estadosPedidos[pedidoId] = {};
      estadosPedidos[pedidoId].estado = isPreparado ? 'preparado' : 'armando';
      estadosPedidos[pedidoId].timestamp = Date.now();
      guardarEstados();

      // 2. Actualizar UI
      const card = document.getElementById(`pedido-${pedidoId}`);
      const label = document.getElementById(`status-label-${pedidoId}`);
      
      const armandoColor = getComputedStyle(document.documentElement).getPropertyValue('--state-armando-text').trim();
      const preparadoColor = getComputedStyle(document.documentElement).getPropertyValue('--state-preparado-text').trim();

      if (card) {
          if (isPreparado) {
              card.classList.remove('estado-armando');
              card.classList.add('estado-preparado');
              if(label) { label.textContent = "Preparado"; label.style.color = preparadoColor; }
          } else {
              card.classList.remove('estado-preparado');
              card.classList.add('estado-armando');
              if(label) { label.textContent = "Armando"; label.style.color = armandoColor; }
          }
      }
  }

  function buildPedidoHTML(pedido, index, groupOrUserName) {
    const items = pedido.items;
    const pedidoId = pedido.id ?? `${pedido.user}-${index}`;
    
    // Recuperar estado (Default: armando)
    const storedState = estadosPedidos[pedidoId]?.estado || 'armando';
    const isPreparado = storedState === 'preparado';
    
    const total = items.reduce((sum, p) => sum + p.subtotal, 0);
    const { formattedDate, formattedTime } = formatDateTime(pedido.fecha);

    // CACH√â DE ORIGINAL (Solo guarda si no existe)
    if (pedido.id && !originalPedidosCache[pedidoId]) {
      originalPedidosCache[pedidoId] = {
          items: structuredClone(items),
          timestamp: Date.now() 
      };
      guardarOriginalCache();
    }

    const subUserHeader = (groupOrUserName !== pedido.user) ? `<div class="sub-user-label">üë§ ${pedido.user}</div>` : '';
    const negocioHeader = (pedido.nombre_negocio) ? `<div class="business-label">üè¢ ${pedido.nombre_negocio}</div>` : '';

    const estadoClass = isPreparado ? 'estado-preparado' : 'estado-armando';
    const labelText = isPreparado ? 'Preparado' : 'Armando';
    const labelColor = isPreparado ? 'var(--state-preparado-text)' : 'var(--state-armando-text)';

    return `
      <li>
        ${negocioHeader}
        ${subUserHeader}
        <div class="pedido-item ${estadoClass}" id="pedido-${pedidoId}" 
             data-items='${JSON.stringify(items)}' 
             data-veryOriginalItems='${JSON.stringify((originalPedidosCache[pedidoId] && originalPedidosCache[pedidoId].items) ? originalPedidosCache[pedidoId].items : items)}'>
          
          <div class="pedido-line" style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" class="pedido-check" value="${pedidoId}" onclick="event.stopPropagation(); togglePedidoSelection('${pedidoId}', this)">
            <div style="flex:1;">
                <strong>Pedido</strong> <small>(ID: ${pedidoId})</small><br> 
                ${formattedDate} ${formattedTime} <br> 
                <b>Total: <span id="total-${pedidoId}">${formatMoney(total)}</span></b>
            </div>
          </div>

          <div class="switch-container">
            <span id="status-label-${pedidoId}" class="switch-label" style="color: ${labelColor}">${labelText}</span>
            <label class="switch">
              <input type="checkbox" ${isPreparado ? 'checked' : ''} onchange="syncStatus('${pedidoId}', this.checked)">
              <span class="slider"></span>
            </label>
          </div>

          <div class="peticion-items" id="items-${pedidoId}">
           ${renderItemsHTML(pedidoId, items)}
          </div>

          <div class="pedido-actions">
            <button class="guardar-btn" data-pedidoid="${pedidoId}">Cloud (Guardar)</button>
            <button class="preview-pdf" onclick="previewPDFPedido('${pedidoId}')">PDF + 3%</button>
            
            <button class="add-product" onclick="openAddModal('${pedidoId}')">+ Prod</button>
            <button class="ver-original" onclick="toggleViewOriginal('${pedidoId}')">Original</button>
            
            <button class="actualizar-precios" onclick="actualizarPreciosPedido('${pedidoId}', false)">$ Act</button>
            <button class="actualizar-precios" onclick="actualizarPreciosPedido('${pedidoId}', true)">$ -3%</button>
            
            <button class="confirmar" onclick="guardarCambiosPedido('${pedidoId}')">Confirmar</button>
            <button class="enfocar" onclick="enfocarPedido('${pedidoId}')">Enfocar</button>
            
            <button class="delete" style="grid-column: span 2; margin-top:5px;" onclick="eliminarPedido('${pedidoId}', '${pedido.user}', ${index})">Eliminar Pedido</button>
            
            <span class="guardar-status" id="guardar-status-${pedidoId}" style="grid-column: span 2; text-align:center; font-size:1.2em;"></span>
          </div>
        </div>
      </li>`;
  }

  function addGuardarBtnListener(btn) {
    btn.addEventListener('click', async () => {
      const pedidoId = btn.dataset.pedidoid;
      const statusSpan = document.getElementById(`guardar-status-${pedidoId}`);
      if (statusSpan) statusSpan.textContent = '‚è≥';
      try {
        await guardarPedido(pedidoId);
        if (statusSpan) statusSpan.textContent = '‚úÖ';
      } catch (err) {
        if (statusSpan) statusSpan.textContent = '‚ùå';
        alert(err.message);
      }
    });
  }

  // ==================== L√ìGICA DE ELIMINAR ====================
  async function eliminarPedido(pedidoId, usuario, index) {
    // 1. Verificar Estado
    const state = estadosPedidos[pedidoId]?.estado || 'armando';
    const isPreparado = state === 'preparado';
    
    let msg = `¬øEliminar pedido permanentemente?`;
    if (isPreparado) {
        msg += `\n\n‚ö†Ô∏è EST√Å EN 'PREPARADO': NO se devolver√° el stock.`;
    } else {
        msg += `\n\n‚úÖ EST√Å EN 'ARMANDO': Se devolver√° el stock autom√°ticamente.`;
    }

    if (!confirm(msg)) return;

    try {
      const res = await fetch(`${apiBase}/eliminar-pedido/${pedidoId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        // Aqu√≠ pasamos "recibido" como true si est√° preparado (para NO restaurar stock)
        body: JSON.stringify({ recibido: isPreparado }) 
      });
      if (!res.ok) throw new Error(await res.text());
      alert('Pedido eliminado correctamente.');
      location.reload();
    } catch (e) {
      mostrarError(e.message);
    }
  }

  // ==================== ORIGINAL / EDICI√ìN ====================
  function toggleViewOriginal(pedidoId) {
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    const isViewingOriginal = pedidoDiv.classList.toggle('viewing-original');
    
    let itemsToShow;
    if (isViewingOriginal) {
        // Cargar desde cache profunda
        const raw = pedidoDiv.dataset.veryOriginalItems;
        itemsToShow = raw ? JSON.parse(raw) : JSON.parse(pedidoDiv.dataset.items);
    } else {
        // Cargar actual
        itemsToShow = JSON.parse(pedidoDiv.dataset.items);
    }

    updatePedidoItems(pedidoId, itemsToShow, !isViewingOriginal);

    const btn = pedidoDiv.querySelector('.ver-original');
    btn.textContent = isViewingOriginal ? 'Volver a Editado' : 'Original';
    
    pedidoDiv.querySelectorAll('button').forEach(b => {
      if (!b.classList.contains('ver-original')) b.disabled = isViewingOriginal;
    });
    
    if (isViewingOriginal) {
        pedidoDiv.style.border = "2px dashed #7b1fa2";
    } else {
        const isPrep = pedidoDiv.classList.contains('estado-preparado');
        pedidoDiv.style.border = isPrep ? "2px solid #76ff03" : "2px solid #eee";
    }
  }

  // ==================== CARGA DE DATOS ====================
  async function cargarUsuarios() {
    try {
      const listaPedidos = document.getElementById('listaUsuarios');
      listaPedidos.innerHTML = '<p style="text-align:center">Cargando pedidos...</p>';
      
      const res = await fetch(`${apiBase}/pedidos`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Error al cargar pedidos.');
      const pedidosRaw = await res.json();
      
      const processedPedidos = pedidosRaw.map(p => {
        let items = Array.isArray(p.items) ? p.items : JSON.parse(p.items || '[]');
        items = items.map(item => ({
          id: item.id || 'unknown',
          nombre: String(item.nombre || 'Sin nombre'),
          cantidad: Number(item.cantidad) || 1,
          precio_unitario: Number(item.precio_unitario || item.precio) || 0,
          subtotal: Number(item.subtotal) || (Number(item.cantidad) * Number(item.precio_unitario || item.precio)) || 0
        }));
        return { ...p, items, user: p.user || 'Invitado' };
      });

      // Agrupaci√≥n
      const userToGroupMap = {};
      Object.entries(groupsConfig).forEach(([groupName, members]) => {
          members.forEach(member => userToGroupMap[member] = groupName);
      });
      const pedidosOrganizados = {};
      processedPedidos.forEach(pedido => {
          const key = userToGroupMap[pedido.user] || pedido.user;
          if (!pedidosOrganizados[key]) pedidosOrganizados[key] = [];
          pedidosOrganizados[key].push(pedido);
      });
      window.usersPedidos = pedidosOrganizados;

      listaPedidos.innerHTML = '';
      if (Object.keys(pedidosOrganizados).length === 0) {
        listaPedidos.innerHTML = '<p style="text-align:center">No hay pedidos registrados.</p>';
        return;
      }

      Object.entries(pedidosOrganizados).forEach(([displayName, userPedidos]) => {
        userPedidos.sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));
        
        let pedidosHTML = '<ul>';
        userPedidos.forEach((pedido, index) => {
           pedidosHTML += buildPedidoHTML(pedido, index, displayName);
        });
        pedidosHTML += '</ul>';

        const userDiv = document.createElement('details');
        userDiv.className = 'user-details';
        userDiv.dataset.searchName = displayName;
        
        const isGroup = !!groupsConfig[displayName];
        const disolverBtn = isGroup ? `<button class="btn-disolver" onclick="event.preventDefault(); disolverGrupo('${displayName}')" style="margin-left:auto; font-size:0.7em; background:transparent; border:1px solid #999;">Disolver Grupo</button>` : '';
        const groupTag = isGroup ? ` <span style="font-size:0.6em; background:#333; color:#fff; padding:2px 6px; border-radius:4px; margin-left:8px;">GRUPO</span>` : '';
        
        userDiv.innerHTML = `
            <summary>
                <div style="display:flex; align-items:center; gap:10px; flex:1;">
                    <input type="checkbox" class="user-select-check" onclick="event.stopPropagation(); toggleUserSelection('${displayName}', this)">
                    <span>${displayName} ${groupTag}</span>
                    ${disolverBtn}
                </div>
                <div class="focus-dot" onclick="enfocarUsuario(this, '${displayName}')" title="Enfocar"></div>
            </summary>
            <div class='usuario-item'>${pedidosHTML}</div>
        `;
        listaPedidos.appendChild(userDiv);
        userDiv.querySelectorAll('.guardar-btn').forEach(addGuardarBtnListener);
      });
    } catch (err) {
      console.error(err);
      mostrarError('Error inesperado al cargar usuarios.');
    }
  }

  // --- SELECCI√ìN Y MASIVOS ---
  function toggleUserSelection(userName, checkbox) {
      if (checkbox.checked) selectedUsersForGroup.add(userName);
      else selectedUsersForGroup.delete(userName);
      updateGroupToolbar();
  }
  function togglePedidoSelection(pedidoId, checkbox) {
      if (checkbox.checked) selectedPedidoIds.add(pedidoId);
      else selectedPedidoIds.delete(pedidoId);
      updateGroupToolbar();
  }
  function clearSelection() {
      selectedUsersForGroup.clear();
      selectedPedidoIds.clear();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if(cb.classList.contains('user-select-check') || cb.classList.contains('pedido-check')) cb.checked = false;
      });
      updateGroupToolbar();
  }
  function updateGroupToolbar() {
      const toolbar = document.getElementById('groupToolbar');
      const countSpan = document.getElementById('selectedCount');
      const btnGroup = document.getElementById('btnGroupAction');
      const btnCloud = document.querySelector('.bulk-cloud');
      const btnPdf = document.querySelector('.bulk-pdf');
      
      const userCount = selectedUsersForGroup.size;
      const pedidoCount = selectedPedidoIds.size;

      if (pedidoCount > 0) {
          toolbar.classList.add('visible');
          countSpan.textContent = `${pedidoCount} pedidos`;
          btnCloud.style.display = 'inline-block';
          btnPdf.style.display = 'inline-block';
          btnGroup.style.display = 'none';
      } else if (userCount > 0) {
          toolbar.classList.add('visible');
          countSpan.textContent = `${userCount} usuarios`;
          btnCloud.style.display = 'none';
          btnPdf.style.display = 'none';
          btnGroup.style.display = 'inline-block';
          
          let groupCount = 0; let uCount = 0;
          selectedUsersForGroup.forEach(name => {
              if (groupsConfig[name]) groupCount++; else uCount++;
          });
          if (groupCount === 1 && uCount > 0) btnGroup.textContent = "Unir al Grupo";
          else if (groupCount === 0 && uCount > 1) btnGroup.textContent = "Crear Grupo";
          else btnGroup.textContent = "Selecci√≥n inv√°lida";
      } else {
          toolbar.classList.remove('visible');
      }
  }

  async function procesarPedidosMasivos(modo) {
      if(selectedPedidoIds.size === 0) return alert('Selecciona al menos un pedido.');
      const accionTexto = (modo === 'cloud') ? 'GUARDAR CLOUD' : 'PDF + 3%';
      if(!confirm(`¬ø${accionTexto} para ${selectedPedidoIds.size} pedidos?\nSe abrir√°n ventanas emergentes.`)) return;
      
      const pedidos = Array.from(selectedPedidoIds);
      for(const pid of pedidos) {
          try {
              if (modo === 'cloud') {
                  await guardarPedido(pid);
                  const statusSpan = document.getElementById(`guardar-status-${pid}`);
                  if (statusSpan) statusSpan.textContent = '‚úÖ';
              } else {
                  await previewPDFPedido(pid); 
              }
              await new Promise(r => setTimeout(r, 800)); 
          } catch(e) { console.error(e); }
      }
  }

  // --- GRUPOS ---
  function handleGroupAction() {
      let groupNames = []; let normalUsers = [];
      selectedUsersForGroup.forEach(name => {
          if (groupsConfig[name]) groupNames.push(name); else normalUsers.push(name);
      });
      if (groupNames.length === 0 && normalUsers.length > 1) {
          const newName = prompt("Nombre para el nuevo grupo:");
          if (newName && !groupsConfig[newName]) {
             groupsConfig[newName] = normalUsers;
             saveGroups(); location.reload();
          }
      } else if (groupNames.length === 1 && normalUsers.length > 0) {
          groupsConfig[groupNames[0]] = [...groupsConfig[groupNames[0]], ...normalUsers];
          saveGroups(); location.reload();
      }
  }
  function disolverGrupo(name) {
      if(confirm(`¬øDisolver grupo ${name}?`)) { delete groupsConfig[name]; saveGroups(); location.reload(); }
  }
  function enfocarUsuario(dot, userName) {
      event.preventDefault(); event.stopPropagation();
      const container = dot.closest('.user-details');
      const yaEnfocado = container.classList.contains('usuario-enfocado');
      
      document.querySelectorAll('.user-details').forEach(ud => {
          ud.style.display = yaEnfocado ? '' : (ud === container ? '' : 'none');
          ud.classList.remove('usuario-enfocado');
          const d = ud.querySelector('.focus-dot'); if(d) d.classList.remove('active');
      });
      if (!yaEnfocado) {
          container.classList.add('usuario-enfocado');
          container.open = true;
          dot.classList.add('active');
      }
      filtrarUsuarios();
  }
  
  // --- EDICI√ìN DE PEDIDO ---
  function modificarCantidadPedido(pedidoId, itemIndex, change) {
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    if (pedidoDiv.classList.contains('viewing-original')) return;
    let items = JSON.parse(pedidoDiv.dataset.items || '[]');
    items[itemIndex].cantidad = Math.max(1, items[itemIndex].cantidad + change);
    items[itemIndex].subtotal = items[itemIndex].cantidad * items[itemIndex].precio_unitario;
    pedidoDiv.dataset.items = JSON.stringify(items);
    updatePedidoItems(pedidoId, items);
  }
  function eliminarItemPedido(pedidoId, itemIndex) {
    if (!confirm('¬øEliminar item?')) return;
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    if (pedidoDiv.classList.contains('viewing-original')) return;
    let items = JSON.parse(pedidoDiv.dataset.items || '[]');
    items = items.filter((_, idx) => idx !== itemIndex);
    pedidoDiv.dataset.items = JSON.stringify(items);
    updatePedidoItems(pedidoId, items);
  }
  async function actualizarPreciosPedido(pedidoId, applyDiscount) {
      const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
      if (pedidoDiv.classList.contains('viewing-original')) return alert('Est√°s viendo el original.');
      if (!confirm(`¬øActualizar precios${applyDiscount?' con -3%':''} a valor actual?`)) return;
      try {
          const res = await fetch(`${apiBase}/productos`);
          const currentProductos = await res.json();
          const precioMap = new Map(currentProductos.map(p => [p.id, p.precio]));
          let items = JSON.parse(pedidoDiv.dataset.items);
          const multiplier = applyDiscount ? 1.10 * 0.97 : 1.10;
          
          let changed = false;
          const updated = items.map(item => {
              const base = precioMap.get(item.id);
              if (base !== undefined) {
                  const nuevo = Number((base * multiplier).toFixed(2));
                  if(nuevo !== item.precio_unitario) changed = true;
                  return { ...item, precio_unitario: nuevo, subtotal: nuevo * item.cantidad };
              }
              return item;
          });
          if(!changed) return alert('Precios ya actualizados.');
          pedidoDiv.dataset.items = JSON.stringify(updated);
          updatePedidoItems(pedidoId, updated);
      } catch(e) { console.error(e); }
  }
  async function guardarCambiosPedido(pedidoId) {
    const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
    if (pedidoDiv.classList.contains('viewing-original')) return alert('Est√°s en vista original.');
    if (!confirm('¬øGuardar cambios permanentemente?')) return;
    try {
      const items = JSON.parse(pedidoDiv.dataset.items);
      const originalItems = JSON.parse(pedidoDiv.dataset.veryOriginalItems || '[]');
      
      const deltaMap = new Map();
      originalItems.forEach(oi => deltaMap.set(oi.id, -Number(oi.cantidad||0)));
      items.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) + Number(i.cantidad||0)));
      
      const stockUpdates = [];
      // L√≥gica de servidor: enviamos cantidad positiva si queremos RESTAR stock (se vendi√≥ m√°s)
      for(const [id, delta] of deltaMap.entries()) {
          if (delta > 0) stockUpdates.push({id, cantidad: delta});
      }

      const res = await fetch(`${apiBase}/actualizar-pedido/${pedidoId}`, {
          method: 'PUT', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ 
              items: items.map(i => ({...i, subtotal: i.cantidad * i.precio_unitario})),
              stockUpdates 
          })
      });
      if(!res.ok) throw new Error();
      
      // Actualizamos referencia "original"
      originalPedidosCache[pedidoId] = { items: items, timestamp: Date.now() };
      guardarOriginalCache();
      pedidoDiv.dataset.veryOriginalItems = JSON.stringify(items);
      
      alert('Guardado con √©xito.');
    } catch(e) { mostrarError('Error al guardar.'); }
  }

  // --- API CALLS ---
  async function guardarPedido(pedidoId) {
      const res = await fetch(`${apiBase}/pedidos/${pedidoId}/pdf`);
      if(!res.ok) throw new Error('Error generando PDF Cloud');
      const d = await res.json(); if(d.pdf) window.open(d.pdf, '_blank');
  }
  async function previewPDFPedido(pedidoId) {
      const div = document.getElementById(`pedido-${pedidoId}`);
      const items = JSON.parse(div.dataset.items);
      const user = div.closest('.user-details').querySelector('summary').innerText.split('\n')[0].trim();
      const payload = {
          user: user, items: items, total: items.reduce((s,i)=>s+i.subtotal,0), fecha: new Date().toISOString()
      };
      const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const d = await res.json(); if(d.pdf) window.open(d.pdf, '_blank');
  }

  // --- A√ëADIR PRODUCTO ---
  function openAddModal(pid) { currentPedidoId = pid; document.getElementById('addProductModal').showModal(); }
  function closeAddModal() { document.getElementById('addProductModal').close(); }
  async function addProductsToPedido() {
      const input = document.getElementById('productsInput').value;
      if(!productos.length) { const r = await fetch(`${apiBase}/productos`); productos = await r.json(); }
      const apply3 = document.getElementById('apply3percent').checked;
      const parts = input.split(',');
      let newItems = [];
      for(let p of parts) {
          const [id, qty] = p.trim().split('x');
          const prod = productos.find(x => x.id == id);
          if(prod) {
              let pr = prod.precio * 1.10; if(apply3) pr *= 0.97;
              newItems.push({id:prod.id, nombre:prod.nombre, cantidad:parseInt(qty), precio_unitario:pr, subtotal: parseInt(qty)*pr});
          }
      }
      if(newItems.length) {
          const div = document.getElementById(`pedido-${currentPedidoId}`);
          let items = JSON.parse(div.dataset.items);
          newItems.forEach(ni => {
              const idx = items.findIndex(i => i.id == ni.id);
              if(idx >= 0) { items[idx].cantidad += ni.cantidad; items[idx].subtotal = items[idx].cantidad * items[idx].precio_unitario; }
              else items.push(ni);
          });
          div.dataset.items = JSON.stringify(items);
          updatePedidoItems(currentPedidoId, items);
          closeAddModal();
      }
  }

  // --- PETICIONES ---
  function renderPeticionItemsHTML(items, peticionId) {
    return items.map((item, index) => {
        let stockWarning = '';
        const product = productos.find(p => p.id === item.id);
        if (product && item.cantidad > (product.stock || 0)) {
            stockWarning = '<span style="color: #d32f2f; font-weight:bold; font-size:0.8em; margin-left:5px;">‚ö†Ô∏è Falta stock</span>';
        }
        return `
        <div class="item" data-item-index="${index}">
        <span id="item-text-${peticionId}-${index}" style="flex:1;">
            ${item.nombre}: <b><span id="cantidad-${peticionId}-${index}">${item.cantidad}</span></b> x ${formatMoney(item.precio_unitario)} = ${formatMoney(item.subtotal)}${stockWarning}
        </span>
        <div style="display:flex; gap:2px;">
            <button class="increase" style="padding:2px 6px; background:#dcedc8;" onclick="modificarCantidad('${peticionId}', ${index}, 1)">+</button>
            <button class="decrease" style="padding:2px 6px; background:#fff9c4;" onclick="modificarCantidad('${peticionId}', ${index}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''}>-</button>
            <button class="delete" style="padding:2px 6px;" onclick="eliminarItemPeticion('${peticionId}', ${index})">√ó</button>
        </div>
        </div>
        `;
    }).join('');
  }

  function modificarCantidad(peticionId, itemIndex, change) {
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    if (!peticionDiv) return;
    let items = JSON.parse(peticionDiv.dataset.items || '[]');
    items[itemIndex].cantidad = Math.max(1, items[itemIndex].cantidad + change);
    items[itemIndex].subtotal = items[itemIndex].cantidad * items[itemIndex].precio_unitario;
    peticionDiv.dataset.items = JSON.stringify(items);
    
    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
    document.getElementById(`total-${peticionId}`).textContent = formatMoney(total);
    const cantSpan = document.getElementById(`cantidad-${peticionId}-${itemIndex}`);
    const txtSpan = document.getElementById(`item-text-${peticionId}-${itemIndex}`);
    if(cantSpan) {
        cantSpan.textContent = items[itemIndex].cantidad;
        txtSpan.innerHTML = `${items[itemIndex].nombre}: <b><span id="cantidad-${peticionId}-${itemIndex}">${items[itemIndex].cantidad}</span></b> x ${formatMoney(items[itemIndex].precio_unitario)} = ${formatMoney(items[itemIndex].subtotal)}`;
    }
  }

  function eliminarItemPeticion(peticionId, itemIndex) {
    if (!confirm('¬øEliminar item?')) return;
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    let items = JSON.parse(peticionDiv.dataset.items || '[]');
    items = items.filter((_, idx) => idx !== itemIndex);
    peticionDiv.dataset.items = JSON.stringify(items);
    
    const container = document.getElementById(`items-${peticionId}`);
    if(container) container.innerHTML = renderPeticionItemsHTML(items, peticionId);
    
    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
    const totalLabel = document.getElementById(`total-${peticionId}`).textContent = formatMoney(total);
  }

  async function cargarPeticiones() {
      const lista = document.getElementById('listaPeticiones');
      try {
          const res = await fetch(`${apiBase}/peticiones`, { cache: 'no-store' });
          const peticiones = await res.json();
          lista.innerHTML = '';
          if(!peticiones.length) { lista.innerHTML = '<p>No hay peticiones.</p>'; return; }
          
          peticiones.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
          peticiones.forEach(p => {
              const isUsed = usedButtons[p.id];
              const { formattedDate, formattedTime } = formatDateTime(p.fecha);
              
              const div = document.createElement('div');
              // Usamos estilo pedido-item para mantener grilla consistente
              div.className = 'pedido-item';
              div.id = `peticion-${p.id}`;
              div.dataset.items = JSON.stringify(p.items);
              div.dataset.nombre = p.nombre;
              div.dataset.userId = p.user_id || '';
              div.dataset.nombreNegocio = p.nombre_negocio || '';
              
              const itemsHTML = renderPeticionItemsHTML(p.items, p.id);
              
              // Botonera de peticiones
              let buttonsHTML = '';
              if (isUsed) {
                  buttonsHTML = `<div style="margin-top:10px; padding:10px; background:#e8f5e9; color:#2e7d32; border-radius:6px; text-align:center; font-weight:bold;">
                    Estado: ${isUsed === 'plus7' ? '‚úÖ Confirmado -3%' : '‚úÖ Confirmado'}
                 </div>`;
              } else {
                  buttonsHTML = `
                  <div class="pedido-actions">
                      <button class="confirmar" onclick="confirmarPeticion(${p.id}, false)">Confirmar</button>
                      <button class="confirmar" style="color:#00838f; border-color:#b2ebf2;" onclick="confirmarPeticion(${p.id}, true)">Confirmar -3%</button>
                      <button class="preview-pdf" onclick="previewPDF(${p.id})">Preview PDF</button>
                      <button class="add-product" onclick="copiarFaltantes(${p.id})">Copiar Faltantes</button>
                      <button class="delete" style="grid-column: span 2;" onclick="eliminarPeticion(${p.id})">Eliminar Petici√≥n</button>
                  </div>`;
              }

              div.innerHTML = `
                 <div class="pedido-line" style="display:flex; gap:10px; align-items:flex-start;">
                    <input type="checkbox" class="peticion-check" value="${p.id}" onclick="event.stopPropagation(); updatePeticionSelection()">
                    <div style="flex:1;">
                        <strong>${p.nombre}</strong> <small>(ID: ${p.id})</small><br>
                        ${formattedDate} ${formattedTime}<br>
                        Tel: ${p.telefono || '-'}<br>
                        <b>Total Est: <span id="total-${p.id}">${formatMoney(p.total)}</span></b>
                    </div>
                 </div>
                 <div class="peticion-items" id="items-${p.id}">${itemsHTML}</div>
                 ${buttonsHTML}
              `;
              lista.appendChild(div);
          });
      } catch(e) { console.error(e); }
  }

  function updatePeticionSelection() {
      const checks = document.querySelectorAll('.peticion-check:checked');
      const span = document.getElementById('peticionesSelectedCount');
      if(span) span.textContent = `${checks.length} seleccionados`;
  }

  async function confirmarPeticion(peticionId, subtractThreePercent, isBulk = false) {
    if (!isBulk && !confirm(`¬øConfirmar esta petici√≥n${subtractThreePercent ? ' con -3%' : ''}?`)) return;
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    const botones = peticionDiv.querySelectorAll('button');
    botones.forEach(btn => { btn.disabled = true; });

    try {
      if (usedButtons[peticionId]) throw new Error('Ya fue confirmado.');
      const items = JSON.parse(peticionDiv.dataset.items || '[]');
      if (items.length === 0) throw new Error('No hay items');
      
      const nombre = peticionDiv.dataset.nombre;
      const userId = peticionDiv.dataset.userId || null;
      const nombreNegocio = peticionDiv.dataset.nombreNegocio || null;
      
      const pedidoItems = items.map(item => ({
        id: item.id, cantidad: item.cantidad,
        precio: subtractThreePercent ? item.precio_unitario * 0.97 : item.precio_unitario
      }));

      const res = await fetch(`${apiBase}/guardar-pedidos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: nombre, pedido: pedidoItems, user_id: userId, nombre_negocio: nombreNegocio })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      
      await fetch(`${apiBase}/peticiones/${peticionId}`, { method: 'DELETE' });
      usedButtons[peticionId] = subtractThreePercent ? 'plus7' : 'normal';
      saveUsedButtons();
      
      if (!isBulk) { alert('Petici√≥n confirmada.'); location.reload(); }
      return true;
    } catch (err) {
      if (!isBulk) { alert(err.message); botones.forEach(btn => btn.disabled = false); }
      return false;
    }
  }

  async function procesarPeticionesMasivas(applyDiscount) {
      const checks = document.querySelectorAll('.peticion-check:checked');
      if(checks.length === 0) return alert('Selecciona al menos una petici√≥n.');
      if(!confirm(`¬øAceptar ${checks.length} peticiones?`)) return;
      let procesados = 0;
      for (const chk of checks) {
          const exito = await confirmarPeticion(chk.value, applyDiscount, true); 
          if(exito) procesados++;
      }
      alert(`Proceso finalizado. ${procesados} aceptados.`);
      location.reload();
  }

  async function eliminarPeticion(id) {
    if(!confirm('¬øEliminar petici√≥n?')) return;
    try {
        await fetch(`${apiBase}/peticiones/${id}`, { method: 'DELETE' });
        cargarPeticiones();
    } catch(e) { mostrarError(e.message); }
  }

  // --- FALTANTES ---
  function copiarFaltantes(peticionId) {
    const peticionDiv = document.getElementById(`peticion-${peticionId}`);
    if (!peticionDiv) return alert('Petici√≥n no encontrada');
    const items = JSON.parse(peticionDiv.dataset.items);
    let faltantes = [];
    for (const item of items) {
      const product = productos.find(p => p.id === item.id);
      const stock = product ? Math.max(product.stock || 0, 0) : 0;
      const missing = Math.max(0, item.cantidad - stock);
      if (missing > 0) faltantes.push(`${missing} ${item.nombre}`);
    }
    const textToCopy = faltantes.join('\n');
    navigator.clipboard.writeText(textToCopy).then(() => alert('Copiado:\n' + textToCopy));
  }
  function copiarFaltantesGrupo() {
    const checks = document.querySelectorAll('.peticion-check:checked');
    if(checks.length === 0) return alert('Selecciona peticiones.');
    const aggregated = new Map();
    checks.forEach(chk => {
        const div = document.getElementById(`peticion-${chk.value}`);
        const items = JSON.parse(div.dataset.items);
        items.forEach(item => {
            const idKey = String(item.id); 
            if(!aggregated.has(idKey)) aggregated.set(idKey, { nombre: item.nombre, cantidad: 0 });
            aggregated.get(idKey).cantidad += Number(item.cantidad);
        });
    });
    const faltantes = [];
    for (const [idKey, data] of aggregated) {
        const product = productos.find(p => p.id == idKey);
        let stock = product ? Number(product.stock) : 0;
        if (isNaN(stock) || stock < 0) stock = 0;
        const missing = data.cantidad - stock;
        if(missing > 0) faltantes.push(`${missing} ${data.nombre}`);
    }
    const text = faltantes.join('\n') || 'No faltan productos.';
    navigator.clipboard.writeText(text).then(() => alert('Copiado:\n' + text));
  }

  async function previewPDF(peticionId) {
      const peticionDiv = document.getElementById(`peticion-${peticionId}`);
      const items = JSON.parse(peticionDiv.dataset.items);
      const nombre = peticionDiv.dataset.nombre;
      const payload = {
          user: nombre,
          items: items.map(i => ({
              id: i.id, nombre: i.nombre, cantidad: i.cantidad,
              precio_unitario: i.precio_unitario * 0.97 * 1.10,
              subtotal: i.cantidad * (i.precio_unitario * 0.97 * 1.10)
        })),
        total: 0, fecha: new Date().toISOString()
      };
      payload.total = payload.items.reduce((s, i) => s + i.subtotal, 0);
      const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
          method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json(); if(data.pdf) window.open(data.pdf, '_blank');
  }

  // --- INIT ---
  async function cargarProductos() {
    try {
        const res = await fetch(`${apiBase}/productos`);
        productos = await res.json();
    } catch(e) { console.error(e); }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    cleanOldCache(); // Limpiar cach√© vieja (1 semana)
    await cargarProductos();
    await cargarUsuarios();
    await cargarPeticiones();
  });

  </script>
</body>
</html>
