<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Funaz</title>
    
    <!-- Vue 3 + Tailwind + Iconos -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Scrollbar m√°s visible y c√≥modo */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilos del Switch de Estado */
        .switch-checkbox { display: none; }
        .switch-label {
            width: 44px; height: 24px;
            background-color: #fb923c; /* Orange default */
            border-radius: 999px; position: relative; cursor: pointer;
            transition: background-color 0.2s;
        }
        .switch-label::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background-color: white; border-radius: 50%;
            transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .switch-checkbox:checked + .switch-label { background-color: #65a30d; /* Lime/Green */ }
        .switch-checkbox:checked + .switch-label::after { transform: translateX(20px); }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen pb-20">
        
        <!-- HEADER -->
        <header class="bg-white sticky top-0 z-50 shadow-md border-b border-gray-200">
            <div class="max-w-[1920px] mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <a href="/" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i></a>
                    <h1 class="text-2xl font-bold text-gray-800">Administraci√≥n</h1>
                </div>

                <!-- Buscador -->
                <div class="w-full md:w-1/3 relative">
                    <input v-model="search" type="text" placeholder="Buscar cliente, ID o producto..." 
                        class="w-full pl-11 pr-4 py-3 bg-gray-100 border-2 border-transparent focus:bg-white focus:border-blue-500 rounded-xl text-lg outline-none transition shadow-inner">
                    <i data-lucide="search" class="w-6 h-6 text-gray-400 absolute left-3 top-3.5"></i>
                </div>

                <!-- M√©tricas R√°pidas -->
                <div class="flex gap-4 text-sm font-semibold">
                    <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg border border-blue-200 shadow-sm flex flex-col items-center">
                        <span>Peticiones</span>
                        <span class="text-xl leading-none">{{ peticiones.length }}</span>
                    </div>
                    <div class="bg-orange-50 text-orange-700 px-4 py-2 rounded-lg border border-orange-200 shadow-sm flex flex-col items-center">
                        <span>Armando</span>
                        <span class="text-xl leading-none">{{ ordersArmando }}</span>
                    </div>
                    <div class="bg-green-50 text-green-700 px-4 py-2 rounded-lg border border-green-200 shadow-sm flex flex-col items-center">
                        <span>Preparados</span>
                        <span class="text-xl leading-none">{{ ordersPreparado }}</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1920px] mx-auto px-4 py-6 space-y-8">
            
            <!-- Notificaci√≥n Flotante -->
            <div v-if="mensaje" :class="`fixed top-24 right-5 z-[100] p-4 rounded-xl shadow-2xl flex items-center gap-3 border-l-8 text-lg font-medium animate-bounce ${mensajeTipo === 'error' ? 'bg-red-100 text-red-800 border-red-500' : 'bg-green-100 text-green-800 border-green-500'}`">
                <span>{{ mensaje }}</span>
            </div>

            <!-- SECCI√ìN PETICIONES (Nuevos) -->
            <section v-if="peticiones.length > 0" class="bg-blue-50/50 p-4 rounded-2xl border border-blue-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-900 flex items-center gap-2">
                        <i data-lucide="bell" class="w-6 h-6"></i> Nuevas Peticiones ({{peticiones.length}})
                    </h2>
                    <div class="flex gap-2">
                        <button v-if="selectedPeticiones.length" @click="procesarPeticionesMasivo(false)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow transition">Aceptar Selecc.</button>
                        <button v-if="selectedPeticiones.length" @click="procesarPeticionesMasivo(true)" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold shadow transition">Aceptar -10%</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div v-for="peticion in peticiones" :key="peticion.id" class="bg-white rounded-xl shadow border border-blue-100 overflow-hidden">
                        <div class="bg-blue-100 p-3 flex justify-between items-center">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <input type="checkbox" v-model="selectedPeticiones" :value="peticion.id" class="w-5 h-5 cursor-pointer">
                                <h3 class="font-bold text-gray-800 truncate">{{ peticion.nombre }}</h3>
                            </div>
                            <span class="text-xs font-mono text-blue-600 bg-white px-2 py-0.5 rounded">#{{ peticion.id }}</span>
                        </div>
                        <div class="p-3">
                            <div class="flex justify-between text-sm mb-2 font-medium">
                                <span>{{ peticion.telefono }}</span>
                                <span class="text-blue-700 font-bold text-base">{{ formatMoney(peticion.total) }}</span>
                            </div>
                            <div class="bg-gray-50 p-2 rounded border max-h-40 overflow-y-auto custom-scroll text-sm mb-3">
                                <div v-for="item in parseItems(peticion.items)" class="flex justify-between border-b border-gray-200 py-1">
                                    <span class="truncate pr-2"><b>{{ item.cantidad }}</b> x {{ item.nombre }}</span>
                                    <span>{{ formatMoney(item.subtotal) }}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm font-bold">
                                <button @click="confirmarPeticion(peticion, false)" class="bg-white border-2 border-green-500 text-green-600 py-2 rounded hover:bg-green-50">Confirmar</button>
                                <button @click="confirmarPeticion(peticion, true)" class="bg-white border-2 border-teal-500 text-teal-600 py-2 rounded hover:bg-teal-50">-10%</button>
                                <button @click="previewPDFPeticion(peticion)" class="bg-white border-2 border-orange-400 text-orange-600 py-2 rounded hover:bg-orange-50">Ver PDF</button>
                                <button @click="eliminarPeticion(peticion.id)" class="bg-red-50 border border-red-200 text-red-600 py-2 rounded hover:bg-red-100">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCI√ìN CLIENTES (ACORDE√ìN OPTIMIZADO) -->
            <section>
                <div class="flex items-center justify-between mb-4 sticky top-20 z-40 bg-gray-100/90 py-2 backdrop-blur">
                    <h2 class="text-2xl font-bold text-gray-800">Clientes</h2>
                    <!-- Acciones Masivas -->
                    <div v-if="selectedOrders.length > 0" class="flex items-center gap-3 bg-gray-900 text-white px-6 py-2 rounded-full shadow-lg animate-fade-in">
                        <span class="font-bold text-orange-300">{{ selectedOrders.length }} pedidos</span>
                        <div class="h-4 w-px bg-gray-600"></div>
                        <button @click="accionMasivaPedidos('cloud')" class="hover:text-green-300 font-bold transition">Guardar Cloud</button>
                        <button @click="accionMasivaPedidos('pdf')" class="hover:text-orange-300 font-bold transition">Ver PDF</button>
                        <button @click="selectedOrders = []" class="ml-2 bg-gray-700 rounded-full p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-6">
                    
                    <!-- TARJETA DE CLIENTE -->
                    <div v-for="(orders, clientName) in filteredClients" :key="clientName" 
                         class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-lg">
                        
                        <!-- Cabecera Cliente (Siempre visible) -->
                        <div @click="toggleClient(clientName)" 
                             :class="['p-4 cursor-pointer flex justify-between items-center transition-colors select-none', activeClient === clientName ? 'bg-gray-800 text-white' : 'bg-white text-gray-800 hover:bg-gray-50']">
                            <div>
                                <h3 class="font-bold text-lg truncate">{{ clientName }}</h3>
                                <div :class="['text-xs font-bold px-2 py-0.5 rounded inline-block mt-1', activeClient === clientName ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-500']">
                                    {{ orders.length }} pedidos
                                </div>
                            </div>
                            <i :data-lucide="activeClient === clientName ? 'chevron-up' : 'chevron-down'" class="w-6 h-6"></i>
                        </div>

                        <!-- CUERPO CLIENTE (Lazy Load con v-if para rendimiento) -->
                        <div v-if="activeClient === clientName" class="p-3 bg-gray-100 border-t border-gray-200">
                            <!-- GRID DE PEDIDOS DEL CLIENTE -->
                            <div class="grid grid-cols-1 gap-4">
                                <div v-for="(pedido, idx) in orders" :key="pedido.uid"
                                     :class="['rounded-lg border-l-8 shadow-sm transition-all duration-300 bg-white', 
                                              getEstado(pedido.uid).recibido ? 'border-l-green-500 border border-green-200' : 'border-l-orange-500 border border-orange-200']">
                                    
                                    <!-- Cabecera Pedido -->
                                    <div :class="['p-3 border-b flex justify-between items-start rounded-t-lg', getEstado(pedido.uid).recibido ? 'bg-green-50 border-green-100' : 'bg-orange-50 border-orange-100']">
                                        <div class="flex gap-3 w-full">
                                            <input type="checkbox" v-model="selectedOrders" :value="pedido.uid" class="mt-1 w-5 h-5 cursor-pointer accent-gray-800">
                                            <div>
                                                <div v-if="pedido.nombre_negocio" class="text-xs font-bold text-orange-700 bg-white px-1 rounded border border-orange-200 mb-1 inline-block">üè¢ {{ pedido.nombre_negocio }}</div>
                                                <div v-if="pedido.user !== clientName" class="text-xs font-bold text-teal-700 bg-white px-1 rounded border border-teal-200 mb-1 inline-block">üë§ {{ pedido.user }}</div>
                                                <div class="text-sm text-gray-500 font-mono">{{ formatDate(pedido.fecha) }}</div>
                                                <div class="text-2xl font-bold text-gray-800 mt-1">{{ formatMoney(calculateTotal(pedido)) }}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-gray-400 font-mono mb-1">ID: {{ String(pedido.id).slice(-4) }}</div>
                                            <div v-if="estadosPedidos[pedido.uid]?.guardado" class="text-xl" title="Guardado Cloud">‚òÅÔ∏è</div>
                                        </div>
                                    </div>

                                    <!-- Lista Items -->
                                    <div class="p-2 max-h-[250px] overflow-y-auto custom-scroll bg-white">
                                        <div v-for="(item, iIdx) in getItemsToShow(pedido)" :key="iIdx" class="flex justify-between items-center py-2 border-b border-gray-100 text-sm hover:bg-gray-50 px-1">
                                            <div class="flex-1 pr-2">
                                                <div class="font-medium text-gray-800">
                                                    <span class="bg-gray-200 px-2 py-0.5 rounded font-bold mr-1">{{ item.cantidad }}</span>
                                                    {{ item.nombre }}
                                                </div>
                                                <div class="text-xs text-gray-400 pl-1">{{ formatMoney(item.precio_unitario) }}</div>
                                            </div>
                                            <div class="flex flex-col items-end gap-1">
                                                <span class="font-bold text-gray-700">{{ formatMoney(item.subtotal) }}</span>
                                                <!-- Botones edici√≥n r√°pida -->
                                                <div v-if="!isOriginalView(pedido.uid)" class="flex gap-1">
                                                    <button @click="modItem(pedido.uid, iIdx, 1)" class="w-6 h-6 flex items-center justify-center bg-green-100 text-green-700 rounded hover:bg-green-200 font-bold">+</button>
                                                    <button @click="modItem(pedido.uid, iIdx, -1)" class="w-6 h-6 flex items-center justify-center bg-orange-100 text-orange-700 rounded hover:bg-orange-200 font-bold">-</button>
                                                    <button @click="delItem(pedido.uid, iIdx)" class="w-6 h-6 flex items-center justify-center bg-red-100 text-red-700 rounded hover:bg-red-200 font-bold">√ó</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer Controles -->
                                    <div class="p-3 bg-gray-50 border-t border-gray-200 rounded-b-lg space-y-3">
                                        
                                        <!-- SWITCH ARMANDO / PREPARADO -->
                                        <div class="flex items-center justify-between bg-white p-2 rounded-lg border shadow-sm">
                                            <span :class="['text-sm font-bold uppercase', getEstado(pedido.uid).recibido ? 'text-green-600' : 'text-orange-500']">
                                                {{ getEstado(pedido.uid).recibido ? 'Preparado' : 'Armando' }}
                                            </span>
                                            
                                            <div class="flex items-center gap-2">
                                                <input type="checkbox" :id="'sw-'+pedido.uid" class="switch-checkbox"
                                                       :checked="getEstado(pedido.uid).recibido"
                                                       @change="toggleEstado(pedido.uid, $event.target.checked)">
                                                <label :for="'sw-'+pedido.uid" class="switch-label"></label>
                                            </div>
                                        </div>

                                        <!-- Botones Acci√≥n -->
                                        <div class="grid grid-cols-2 gap-2 text-sm font-bold">
                                            <button @click="guardarCloud(pedido)" class="bg-gray-800 text-white py-2 rounded hover:bg-black transition">Guardar PDF</button>
                                            <button @click="previewPDF(pedido)" class="bg-orange-500 text-white py-2 rounded hover:bg-orange-600 transition">PDF + 10%</button>
                                            
                                            <button @click="openAddModal(pedido.uid)" class="bg-white border-2 border-blue-200 text-blue-600 py-2 rounded hover:bg-blue-50">+ Prod</button>
                                            <button @click="toggleOriginal(pedido.uid)" :class="['py-2 rounded border-2 transition', isOriginalView(pedido.uid) ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-purple-600 border-purple-200']">
                                                {{ isOriginalView(pedido.uid) ? 'Volver' : 'Original' }}
                                            </button>
                                            
                                            <button @click="actualizarPrecios(pedido.uid, false)" class="text-gray-600 bg-white border border-gray-300 py-2 rounded hover:bg-gray-100">$ Actualizar</button>
                                            <button @click="actualizarPrecios(pedido.uid, true)" class="text-teal-600 bg-white border border-teal-200 py-2 rounded hover:bg-teal-50">$ -10%</button>
                                        </div>

                                        <div class="flex gap-2 pt-2 border-t border-gray-200">
                                            <button @click="guardarCambios(pedido.uid)" :disabled="isOriginalView(pedido.uid)" class="flex-1 bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 shadow disabled:opacity-50">
                                                Confirmar Cambios
                                            </button>
                                            <button @click="eliminarPedido(pedido)" class="px-3 bg-red-50 text-red-500 border border-red-200 rounded hover:bg-red-100">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </main>

        <!-- MODAL AGREGAR PRODUCTO -->
        <div v-if="modalOpen" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 p-4" @click.self="modalOpen = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">A√±adir Productos</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">IDs x Cantidad (Ej: 353x5, 24x1)</label>
                        <input v-model="modalInput" type="text" ref="modalInputRef" class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg font-mono focus:border-blue-500 outline-none" @keyup.enter="addProducts">
                    </div>
                    <label class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer">
                        <input type="checkbox" v-model="modalApplyDiscount" class="w-5 h-5 text-green-600">
                        <span class="font-bold text-gray-700">Aplicar -10% descuento</span>
                    </label>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="modalOpen = false" class="px-5 py-2.5 font-bold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                    <button @click="addProducts" class="px-5 py-2.5 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700">A√±adir</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, nextTick } = Vue;
        const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        // Check Login
        if (localStorage.getItem('loggedUser') !== 'admin') window.location.href = 'index.html';

        createApp({
            data() {
                return {
                    // Datos
                    rawPedidos: [],
                    peticiones: [],
                    productos: [],
                    
                    // Estado Local
                    estadosPedidos: JSON.parse(localStorage.getItem('estadosPedidos') || '{}'),
                    originalCache: JSON.parse(localStorage.getItem('originalPedidosCache') || '{}'),
                    usedButtons: JSON.parse(localStorage.getItem('usedButtons') || '{}'),
                    
                    // UI
                    search: '',
                    activeClient: null, // SOLO UNO ABIERTO A LA VEZ (Rendimiento clave)
                    selectedOrders: [],
                    selectedPeticiones: [],
                    
                    // Modals
                    mensaje: '',
                    mensajeTipo: 'info',
                    loadingOrders: {},
                    modalOpen: false,
                    modalPedidoId: null,
                    modalInput: '',
                    modalApplyDiscount: false
                }
            },
            computed: {
                ordersArmando() { return this.rawPedidos.filter(p => !this.estadosPedidos[p.uid]?.recibido).length; },
                ordersPreparado() { return this.rawPedidos.filter(p => this.estadosPedidos[p.uid]?.recibido).length; },
                
                filteredClients() {
                    // Agrupar por usuario
                    const groups = {};
                    this.rawPedidos.forEach((p, index) => {
                        p.uid = p.id ? String(p.id) : `${p.user}-${index}`;
                        const name = p.user || 'Invitado';
                        if (!groups[name]) groups[name] = [];
                        groups[name].push(p);
                    });

                    // Ordenar por fecha dentro del grupo
                    for(const key in groups) groups[key].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

                    // Filtrar si hay busqueda
                    if (!this.search) return groups;
                    const q = this.search.toLowerCase();
                    const result = {};
                    for (const [name, orders] of Object.entries(groups)) {
                        if (name.toLowerCase().includes(q) || orders.some(o => String(o.id).includes(q) || o.items.some(i => i.nombre.toLowerCase().includes(q)))) {
                            result[name] = orders;
                        }
                    }
                    return result;
                }
            },
            methods: {
                // UTILS
                formatMoney(val) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val || 0); },
                formatDate(iso) { 
                    if (!iso) return ''; const d = new Date(iso);
                    return d.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
                },
                showMsg(msg, type='info') {
                    this.mensaje = msg; this.mensajeTipo = type;
                    setTimeout(() => this.mensaje = '', 3000);
                },
                saveStorage() {
                    localStorage.setItem('estadosPedidos', JSON.stringify(this.estadosPedidos));
                    localStorage.setItem('originalPedidosCache', JSON.stringify(this.originalCache));
                    localStorage.setItem('usedButtons', JSON.stringify(this.usedButtons));
                },
                
                // DATA
                async loadAll() {
                    try {
                        const [resProd, resPed, resPet] = await Promise.all([
                            fetch(`${apiBase}/productos`), fetch(`${apiBase}/pedidos`), fetch(`${apiBase}/peticiones`)
                        ]);
                        this.productos = await resProd.json();
                        this.rawPedidos = await resPed.json();
                        this.peticiones = await resPet.json();
                        
                        const parser = (list) => list.forEach(p => { 
                             if(typeof p.items === 'string') { try { p.items = JSON.parse(p.items); } catch { p.items = []; } }
                        });
                        parser(this.rawPedidos); parser(this.peticiones);
                        nextTick(() => lucide.createIcons());
                    } catch (e) { console.error(e); }
                },

                // LOGICA UI CLIENTES (ACORDEON UNICO)
                toggleClient(name) {
                    // Si toco el mismo, lo cierro. Si toco otro, abro ese y cierro el anterior.
                    this.activeClient = this.activeClient === name ? null : name;
                    nextTick(() => lucide.createIcons()); // Refrescar iconos al abrir
                },

                // ESTADOS
                getEstado(uid) {
                    if (!this.estadosPedidos[uid]) this.estadosPedidos[uid] = { recibido: false, guardado: false };
                    return this.estadosPedidos[uid];
                },
                toggleEstado(uid, val) {
                    this.getEstado(uid).recibido = val;
                    this.saveStorage();
                },

                // VISTA ORIGINAL
                isOriginalView(uid) { return this.estadosPedidos[uid]?.viewOriginal || false; },
                toggleOriginal(uid) {
                    const st = this.getEstado(uid);
                    st.viewOriginal = !st.viewOriginal;
                    if (st.viewOriginal && !this.originalCache[uid]) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) { this.originalCache[uid] = JSON.parse(JSON.stringify(p.items)); this.saveStorage(); }
                    }
                },
                getItemsToShow(pedido) {
                    return (this.isOriginalView(pedido.uid) && this.originalCache[pedido.uid]) ? this.originalCache[pedido.uid] : pedido.items;
                },
                calculateTotal(pedido) {
                    return this.getItemsToShow(pedido).reduce((acc, item) => acc + (Number(item.subtotal)||0), 0);
                },

                // ACCIONES
                async guardarCloud(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        const res = await fetch(`${apiBase}/pedidos/${pedido.id}/pdf`);
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                        this.getEstado(pedido.uid).guardado = true; this.saveStorage();
                    } catch(e) { this.showMsg('Error PDF', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                // LOGICA PDF +10%
                async previewPDF(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        // Aumento del 10% al total visual (o item por item si lo prefieres, aqui es item por item)
                        const itemsModified = pedido.items.map(i => ({
                            ...i, precio_unitario: i.precio_unitario * 1.10, subtotal: i.subtotal * 1.10
                        }));
                        const payload = {
                            user: pedido.user, items: itemsModified,
                            total: itemsModified.reduce((a,b)=>a+b.subtotal,0),
                            fecha: new Date().toISOString(), nombre_negocio: pedido.nombre_negocio
                        };
                        const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                    } catch(e) { this.showMsg('Error Generando', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                
                // GUARDAR CAMBIOS (DELTA)
                async guardarCambios(uid) {
                    if(!confirm('¬øGuardar cambios en BD?')) return;
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const estado = this.getEstado(uid);

                    if(!this.originalCache[uid]) this.originalCache[uid] = JSON.parse(JSON.stringify(pedido.items));

                    const deltaMap = new Map();
                    const oldItems = this.originalCache[uid];
                    const newItems = pedido.items;
                    
                    oldItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) - Number(i.cantidad))); 
                    newItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) + Number(i.cantidad))); 
                    
                    const stockUpdates = [];
                    // Logica Clave: Si NO est√° recibido (Armando), permite devolver stock (negativos).
                    // Si est√° recibido (Verde), NO devuelve stock (ignora negativos).
                    for(const [id, delta] of deltaMap.entries()) {
                         if(delta > 0) stockUpdates.push({id, cantidad: delta});
                         else if (delta < 0 && !estado.recibido) stockUpdates.push({id, cantidad: delta});
                    }

                    try {
                        await fetch(`${apiBase}/actualizar-pedido/${pedido.id}`, {
                            method: 'PUT', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ items: newItems, stockUpdates })
                        });
                        this.originalCache[uid] = JSON.parse(JSON.stringify(newItems)); this.saveStorage();
                        this.showMsg('Guardado OK', 'success');
                    } catch(e) { this.showMsg('Error guardando', 'error'); }
                },

                async eliminarPedido(pedido) {
                    const estado = this.getEstado(pedido.uid);
                    // Solo devuelve stock si NO est√° recibido (Verde)
                    const msg = estado.recibido 
                        ? 'EST√Å EN PREPARADO (VERDE). NO SE DEVOLVER√Å STOCK.' 
                        : 'EST√Å EN ARMANDO (NARANJA). SE DEVOLVER√Å EL STOCK.';
                    
                    if(!confirm(`¬øEliminar pedido?\n\n${msg}`)) return;

                    await fetch(`${apiBase}/eliminar-pedido/${pedido.id}`, {
                        method: 'DELETE', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ recibido: estado.recibido })
                    });
                    this.rawPedidos = this.rawPedidos.filter(p => p.uid !== pedido.uid);
                    // Si el cliente se queda vacio, cerrar acordeon
                    if(this.filteredClients[pedido.user]?.length === 0) this.activeClient = null;
                },

                // EDICION RAPIDA
                modItem(uid, idx, chg) {
                    const item = this.rawPedidos.find(p => p.uid === uid).items[idx];
                    item.cantidad = Math.max(1, Number(item.cantidad) + chg);
                    item.subtotal = item.cantidad * item.precio_unitario;
                },
                delItem(uid, idx) {
                    if(!confirm('¬øBorrar item?')) return;
                    this.rawPedidos.find(p => p.uid === uid).items.splice(idx, 1);
                },
                async actualizarPrecios(uid, discount) {
                    if(this.isOriginalView(uid)) return alert('Sal de original');
                    if(!confirm('¬øActualizar precios?')) return;
                    
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const precioMap = new Map(this.productos.map(p => [p.id, p.precio]));
                    const mult = discount ? 1.10 * 0.90 : 1.10; // -10% sobre lista nueva
                    
                    pedido.items.forEach(i => {
                        const base = precioMap.get(i.id);
                        if(base) {
                            i.precio_unitario = Number((base * mult).toFixed(2));
                            i.subtotal = i.cantidad * i.precio_unitario;
                        }
                    });
                    this.showMsg('Precios Actualizados', 'success');
                },

                // ADD MODAL
                openAddModal(uid) { this.modalPedidoId = uid; this.modalInput = ''; this.modalOpen = true; nextTick(()=>this.$refs.modalInputRef.focus()); },
                addProducts() {
                    const pedido = this.rawPedidos.find(p => p.uid === this.modalPedidoId);
                    const parts = this.modalInput.split(',').map(s=>s.trim());
                    parts.forEach(part => {
                        const [idStr, qtyStr] = part.split('x');
                        const p = this.productos.find(pr => pr.id == idStr);
                        if(p) {
                            let precio = p.precio * 1.10;
                            if(this.modalApplyDiscount) precio *= 0.90; // -10%
                            const qty = parseInt(qtyStr)||1;
                            const exist = pedido.items.find(i => i.id == p.id);
                            if(exist) {
                                exist.cantidad += qty; exist.precio_unitario = precio; exist.subtotal = exist.cantidad * precio;
                            } else {
                                pedido.items.push({ id: p.id, nombre: p.nombre, cantidad: qty, precio_unitario: precio, subtotal: qty*precio });
                            }
                        }
                    });
                    this.modalOpen = false;
                },

                // PETICIONES
                parseItems(items) { return Array.isArray(items) ? items : JSON.parse(items || '[]'); },
                getStockWarning(item) { const p = this.productos.find(pr => pr.id === item.id); return p && item.cantidad > (p.stock||0); },
                
                async confirmarPeticion(peticion, discount) {
                    if(!confirm('¬øAceptar petici√≥n?')) return;
                    const items = this.parseItems(peticion.items).map(i => ({
                        id: i.id, cantidad: i.cantidad, precio: discount ? i.precio_unitario * 0.90 : i.precio_unitario
                    }));
                    await fetch(`${apiBase}/guardar-pedidos`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ user: peticion.nombre, pedido: items, user_id: peticion.user_id, nombre_negocio: peticion.nombre_negocio })
                    });
                    await fetch(`${apiBase}/peticiones/${peticion.id}`, { method: 'DELETE' });
                    this.peticiones = this.peticiones.filter(p => p.id !== peticion.id);
                    this.usedButtons[peticion.id] = discount ? 'plus10' : 'normal'; this.saveStorage();
                    this.loadAll(); 
                },
                async eliminarPeticion(id) { if(confirm('¬øBorrar?')) { await fetch(`${apiBase}/peticiones/${id}`, { method:'DELETE' }); this.peticiones=this.peticiones.filter(p=>p.id!==id); } },
                previewPDFPeticion(p) { this.previewPDF({ user:p.nombre, items:this.parseItems(p.items), fecha:p.fecha, nombre_negocio:p.nombre_negocio }); },
                copiarFaltantesIndividual(p) {
                    const items = this.parseItems(p.items);
                    let txt = "";
                    items.forEach(i => {
                        const pr = this.productos.find(x => x.id === i.id);
                        const falt = Math.max(0, i.cantidad - (pr ? pr.stock : 0));
                        if(falt>0) txt += `${falt} ${i.nombre}\n`;
                    });
                    navigator.clipboard.writeText(txt || "Hay stock");
                    this.showMsg('Copiado', 'success');
                },

                // MASIVO
                copiarFaltantesGlobal() {
                    const pending = this.rawPedidos.filter(p => !this.getEstado(p.uid).recibido);
                    const agg = {};
                    pending.forEach(p => p.items.forEach(i => {
                        if(!agg[i.id]) agg[i.id] = {name:i.nombre, qty:0};
                        agg[i.id].qty += Number(i.cantidad);
                    }));
                    let txt = "FALTANTES ARMANDO:\n";
                    Object.values(agg).forEach(v => txt += `${v.qty} ${v.name}\n`);
                    navigator.clipboard.writeText(txt);
                    this.showMsg('Lista Global Copiada', 'success');
                },
                async accionMasivaPedidos(mode) {
                    if(!this.selectedOrders.length) return;
                    if(!confirm(`¬øProcesar ${this.selectedOrders.length} pedidos?`)) return;
                    for(const uid of this.selectedOrders) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) {
                            if(mode==='cloud') await this.guardarCloud(p); else await this.previewPDF(p);
                            await new Promise(r=>setTimeout(r,500));
                        }
                    }
                    this.selectedOrders = [];
                },
                async procesarPeticionesMasivo(discount) {
                    if(!confirm(`¬øProcesar ${this.selectedPeticiones.length}?`)) return;
                    for(const pid of this.selectedPeticiones) {
                        const p = this.peticiones.find(x => x.id === pid);
                        if(p) await this.confirmarPeticion(p, discount);
                    }
                    this.selectedPeticiones = [];
                }
            },
            mounted() { this.loadAll(); }
        }).mount('#app');
    </script>
</body>
</html>
