<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Funaz</title>
    
    <!-- Vue 3 + Tailwind + Iconos -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF-Lib para concatenar PDFs en el cliente -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Scrollbar Fina */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Switch Toggle */
        .toggle-switch {
            position: relative; width: 36px; height: 20px;
            background-color: #fb923c; /* Orange default */
            border-radius: 9999px; cursor: pointer; transition: background-color 0.3s ease;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 16px; height: 16px; background-color: white; border-radius: 50%;
            transition: transform 0.3s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .toggle-input:checked + .toggle-switch { background-color: #65a30d; /* Lime/Green */ }
        .toggle-input:checked + .toggle-switch::after { transform: translateX(16px); }
        .toggle-input { display: none; }

        /* Animaciones */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(20px); }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen pb-32 text-slate-800">
        
        <!-- HEADER -->
        <header class="bg-white sticky top-0 z-50 border-b border-slate-200 shadow-sm backdrop-blur-md bg-opacity-95">
            <div class="max-w-[1920px] mx-auto px-6 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <a href="/" class="p-2 -ml-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-full transition">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </a>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800">Panel de Control</h1>
                </div>

                <!-- Buscador -->
                <div class="w-full md:w-[600px] relative group" v-if="!focusMode">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    </div>
                    <input v-model="search" type="text" placeholder="Buscar cliente, ID, producto..." 
                        class="w-full pl-11 pr-4 py-2.5 bg-slate-100 border border-transparent rounded-xl text-base focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all shadow-sm">
                    <button v-if="search" @click="search = ''" class="absolute right-3 top-2.5 text-slate-400 hover:text-red-500 transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Botón Volver de Foco/Cliente -->
                <div v-else class="flex-1 flex justify-center">
                    <button @click="clearFocus" class="bg-slate-800 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-slate-700 transition flex items-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i> Cerrar Vista Enfocada
                    </button>
                </div>

                <!-- Acciones Globales -->
                <div class="flex items-center gap-3" v-if="!focusMode">
                    <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg font-bold border border-blue-100 flex items-center gap-2 text-sm">
                        <i data-lucide="inbox" class="w-4 h-4"></i>
                        <span>{{ peticiones.length }} Peticiones</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1920px] mx-auto px-6 py-6 space-y-8">
            
            <!-- Notificaciones -->
            <transition enter-active-class="transition ease-out duration-300" enter-from-class="transform opacity-0 translate-y-2" enter-to-class="transform opacity-100 translate-y-0" leave-active-class="transition ease-in duration-200" leave-from-class="transform opacity-100 translate-y-0" leave-to-class="transform opacity-0 translate-y-2">
                <div v-if="mensaje" :class="`fixed bottom-6 right-6 z-[100] px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 border-l-4 font-medium text-lg ${mensajeTipo === 'error' ? 'bg-white text-red-600 border-red-500' : 'bg-slate-800 text-white border-green-500'}`">
                    <i :data-lucide="mensajeTipo === 'error' ? 'alert-circle' : 'check-circle'" class="w-6 h-6"></i>
                    <span>{{ mensaje }}</span>
                </div>
            </transition>

            <!-- VISTA ENFOCADA (ITEM INDIVIDUAL) -->
            <section v-if="focusMode && focusedItem" class="flex justify-center">
                <div class="w-full max-w-3xl">
                    <!-- Renderizado condicional del item enfocado (reutilizando componentes lógicos) -->
                    <div v-if="focusType === 'pedido'" 
                         :class="['bg-white rounded-2xl shadow-2xl border-4 overflow-hidden flex flex-col relative transform scale-100 transition-all', 
                                  getEstado(focusedItem.uid).recibido ? 'border-green-400 bg-green-50/20' : 'border-orange-400 bg-orange-50/20']">
                         <!-- (Contenido del Pedido Enfocado - Reutilizado abajo) -->
                         <div class="p-6 border-b border-slate-200 bg-white flex justify-between items-start">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 text-center w-full">{{ focusedItem.user }}</h2>
                                <div class="text-slate-500 font-mono text-center w-full mt-1">{{ formatDate(focusedItem.fecha) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-slate-800">{{ formatMoney(calculateTotal(focusedItem)) }}</div>
                                <span class="text-sm font-mono text-slate-400">#{{ String(focusedItem.id).slice(-4) }}</span>
                            </div>
                         </div>
                         <div class="p-4 bg-white max-h-[60vh] overflow-y-auto custom-scroll">
                             <!-- Lista Items Enfocados -->
                             <div v-for="(item, iIdx) in getItemsToShow(focusedItem)" :key="iIdx" class="flex justify-between items-center py-3 border-b border-dashed border-slate-200 last:border-0 text-lg px-2">
                                <div class="flex-1 pr-4">
                                    <span class="font-bold bg-slate-100 border border-slate-200 px-2 py-1 rounded text-slate-900 mr-2">{{ item.cantidad }}</span>
                                    {{ item.nombre }}
                                </div>
                                <div class="font-bold text-slate-700">{{ formatMoney(item.subtotal) }}</div>
                             </div>
                         </div>
                         <div class="p-4 bg-slate-50 border-t border-slate-200 grid grid-cols-2 gap-4">
                             <!-- Controles Enfocados -->
                             <button @click="guardarCloud(focusedItem)" class="bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900">Guardar Cloud (PDF)</button>
                             <button @click="previewPDF(focusedItem)" class="bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600">PDF +10%</button>
                             <div class="col-span-2 flex justify-between items-center bg-white p-3 rounded-xl border shadow-sm">
                                <span class="font-bold uppercase">{{ getEstado(focusedItem.uid).recibido ? 'Preparado' : 'Armando' }}</span>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" :id="'sw-f-'+focusedItem.uid" class="toggle-input"
                                           :checked="getEstado(focusedItem.uid).recibido"
                                           @change="toggleEstado(focusedItem.uid, $event.target.checked)">
                                    <label :for="'sw-f-'+focusedItem.uid" class="toggle-switch"></label>
                                </div>
                             </div>
                         </div>
                    </div>

                    <div v-else-if="focusType === 'peticion'" class="bg-white rounded-2xl shadow-2xl border border-blue-200 overflow-hidden">
                        <!-- (Contenido Petición Enfocada) -->
                        <div class="p-6 border-b border-blue-100 bg-blue-50 text-center">
                            <h2 class="text-3xl font-bold text-slate-800">{{ focusedItem.nombre }}</h2>
                            <div class="text-slate-500 mt-1">{{ focusedItem.telefono }}</div>
                        </div>
                        <div class="p-4 bg-white max-h-[60vh] overflow-y-auto">
                             <div v-for="item in parseItems(focusedItem.items)" class="flex justify-between py-2 border-b border-slate-100 text-lg">
                                <span><b>{{ item.cantidad }}</b> x {{ item.nombre }}</span>
                                <span>{{ formatMoney(item.subtotal) }}</span>
                             </div>
                        </div>
                        <div class="p-4 bg-slate-50 grid grid-cols-2 gap-4">
                            <button @click="confirmarPeticion(focusedItem, false)" class="bg-green-600 text-white py-3 rounded-xl font-bold">Confirmar</button>
                            <button @click="confirmarPeticion(focusedItem, true)" class="bg-teal-600 text-white py-3 rounded-xl font-bold">Confirmar -3%</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISTA NORMAL (LISTAS) -->
            <div v-else>
                <!-- SECCIÓN PETICIONES -->
                <section v-if="peticiones.length > 0 && !activeClient" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                    <div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex flex-wrap justify-between items-center gap-2">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg"><i data-lucide="bell" class="w-4 h-4"></i></span>
                            Solicitudes Nuevas
                        </h2>
                        <div class="flex gap-2">
                            <transition name="fade">
                                <div v-if="selectedPeticiones.length > 0" class="flex gap-2 flex-wrap">
                                    <button @click="copiarFaltantesPeticionesMasivo" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Copiar Faltantes
                                    </button>
                                    <button @click="procesarPeticionesMasivo(false)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1">
                                        <i data-lucide="check" class="w-3 h-3"></i> Aceptar
                                    </button>
                                    <button @click="procesarPeticionesMasivo(true)" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1">
                                        <i data-lucide="percent" class="w-3 h-3"></i> Aceptar -3%
                                    </button>
                                </div>
                            </transition>
                        </div>
                    </div>
                    
                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 bg-slate-50/50">
                        <div v-for="peticion in peticiones" :key="peticion.id" class="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow duration-200 flex flex-col group relative">
                            <!-- Botón Enfocar Petición -->
                            <button @click="enfocarItem(peticion, 'peticion')" class="absolute top-2 right-2 p-1.5 bg-white rounded-full shadow border border-slate-200 text-slate-400 hover:text-blue-600 hover:border-blue-300 z-10 transition" title="Enfocar Petición">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>

                            <!-- Header Petición -->
                            <div class="p-3 border-b border-slate-100 bg-white rounded-t-xl pr-10">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2 overflow-hidden w-full">
                                        <input type="checkbox" v-model="selectedPeticiones" :value="peticion.id" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0">
                                        <div class="w-full text-center">
                                            <h3 class="font-bold text-slate-900 text-base truncate" :title="peticion.nombre">{{ peticion.nombre }}</h3>
                                            <div class="text-[10px] text-slate-500 mt-0.5 flex items-center justify-center gap-1">
                                                <i data-lucide="clock" class="w-3 h-3"></i> {{ formatDate(peticion.fecha) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span v-if="peticion.telefono" class="text-slate-600 font-medium flex items-center gap-1">
                                        <i data-lucide="phone" class="w-3 h-3"></i> {{ peticion.telefono }}
                                    </span>
                                    <span class="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{{ formatMoney(peticion.total) }}</span>
                                </div>
                            </div>

                            <!-- Body Petición -->
                            <div class="p-2 flex-1 bg-white relative">
                                <div class="bg-slate-50 rounded-lg p-2 max-h-[150px] overflow-y-auto custom-scroll border border-slate-100 space-y-1">
                                    <div v-for="item in parseItems(peticion.items)" class="flex justify-between text-xs py-1 border-b border-slate-100 last:border-0 border-dashed">
                                        <span class="truncate pr-2 text-slate-700 flex-1">
                                            <span class="font-bold bg-white border border-slate-200 px-1 rounded text-slate-900 mr-1">{{ item.cantidad }}</span> 
                                            {{ item.nombre }}
                                            <span v-if="getStockWarning(item)" class="text-red-500 ml-1 font-bold" title="Sin stock">!</span>
                                        </span>
                                        <span class="text-slate-500 font-medium">{{ formatMoney(item.subtotal) }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Petición -->
                            <div class="p-2 bg-slate-50 border-t border-slate-100 rounded-b-xl grid grid-cols-2 gap-2">
                                <button @click="confirmarPeticion(peticion, false)" class="bg-white border border-green-200 text-green-700 hover:bg-green-50 py-1 rounded text-[10px] font-bold transition">Confirmar</button>
                                <button @click="confirmarPeticion(peticion, true)" class="bg-white border border-teal-200 text-teal-700 hover:bg-teal-50 py-1 rounded text-[10px] font-bold transition">-3% Desc</button>
                                <button @click="copiarFaltantesIndividual(peticion)" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 py-1 rounded text-[10px] font-bold transition">Faltantes</button>
                                <button @click="eliminarPeticion(peticion.id)" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 py-1 rounded text-[10px] font-bold transition">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN CLIENTES Y PEDIDOS -->
                <section>
                    <!-- Header Clientes (Oculto si hay un cliente activo para maximizar espacio) -->
                    <div class="flex items-center justify-between mb-4 px-2" v-if="!activeClient">
                        <h2 class="text-xl font-bold text-slate-800">Clientes Activos</h2>
                    </div>
                    <!-- Botón Volver cuando hay Cliente Activo -->
                    <div v-else class="mb-4 flex items-center justify-between">
                        <button @click="toggleClient(null)" class="flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold transition bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> Volver a Clientes
                        </button>
                        <h2 class="text-3xl font-bold text-slate-800 text-center flex-1">{{ activeClient }}</h2>
                        <div class="w-32"></div> <!-- Spacer para centrar el titulo -->
                    </div>

                    <!-- GRID DE CLIENTES -->
                    <!-- Si hay cliente activo, solo se muestra ese contenedor expandido -->
                    <div :class="activeClient ? 'w-full' : 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6'">
                        
                        <div v-for="(orders, clientName) in filteredClients" :key="clientName" 
                             v-show="!activeClient || activeClient === clientName"
                             :class="['bg-white rounded-xl shadow-sm border border-slate-200 transition-all duration-300 flex flex-col', activeClient === clientName ? 'shadow-none border-0 bg-transparent' : 'hover:shadow-md']">
                            
                            <!-- Header Cliente (Solo visible en lista) -->
                            <div v-if="!activeClient" @click="toggleClient(clientName)" 
                                 class="p-4 cursor-pointer flex justify-between items-center transition-colors select-none rounded-xl bg-white hover:bg-slate-50">
                                <div class="flex items-center gap-3 overflow-hidden w-full">
                                    <div class="truncate w-full text-center">
                                        <h3 class="font-bold text-xl leading-tight truncate text-slate-800">{{ clientName }}</h3>
                                        <span class="text-xs font-medium text-slate-500">{{ orders.length }} pedidos</span>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400 absolute right-4"></i>
                            </div>

                            <!-- Cuerpo Cliente (Visible solo si activo) -->
                            <div v-if="activeClient === clientName" class="flex-1">
                                
                                <!-- GRID DE PEDIDOS DEL CLIENTE (FULL SCREEN) -->
                                <!-- Aquí ajustamos las columnas para ocupar toda la pantalla -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    
                                    <div v-for="(pedido, idx) in getItemsSlice(clientName, orders)" :key="pedido.uid"
                                         :class="['bg-white rounded-xl shadow-sm border-2 transition-all duration-200 overflow-hidden flex flex-col relative', 
                                                  getEstado(pedido.uid).recibido ? 'border-green-400 bg-green-50/20' : 'border-orange-400 bg-orange-50/20']">
                                        
                                        <!-- Botón Enfocar Pedido -->
                                        <button @click="enfocarItem(pedido, 'pedido')" class="absolute top-2 right-2 p-1.5 bg-white/80 backdrop-blur rounded-full shadow border border-slate-200 text-slate-400 hover:text-blue-600 hover:border-blue-300 z-10 transition" title="Enfocar Pedido">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                        </button>

                                        <!-- Header Pedido -->
                                        <div class="p-3 border-b border-slate-100 flex justify-between items-start bg-white/90 backdrop-blur-sm pr-10">
                                            <div class="flex gap-2 w-full overflow-hidden">
                                                <input type="checkbox" v-model="selectedOrders" :value="pedido.uid" class="mt-1 w-4 h-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500 cursor-pointer shrink-0">
                                                <div class="flex-1 min-w-0 flex flex-col items-center">
                                                    <div class="flex flex-wrap gap-1 mb-1 justify-center w-full">
                                                        <!-- NOMBRE NEGOCIO MÁS GRANDE (CORREGIDO) -->
                                                        <span v-if="pedido.nombre_negocio" class="text-xl font-bold uppercase tracking-wide text-orange-900 bg-orange-100 px-3 py-1 rounded truncate max-w-full border border-orange-200 shadow-sm block w-full text-center">{{ pedido.nombre_negocio }}</span>
                                                        <span v-if="pedido.user !== clientName" class="text-[10px] font-bold uppercase tracking-wide text-teal-700 bg-teal-100 px-1.5 py-0.5 rounded truncate max-w-full">{{ pedido.user }}</span>
                                                    </div>
                                                    <div class="text-[10px] text-slate-500 font-mono mb-0.5">{{ formatDate(pedido.fecha) }}</div>
                                                    <div class="text-xl font-bold text-slate-800">{{ formatMoney(calculateTotal(pedido)) }}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Estado y Switch (Arriba, visible) -->
                                        <div class="px-3 py-2 bg-white/50 border-b border-slate-100 flex justify-between items-center">
                                            <span :class="['text-[10px] font-bold uppercase', getEstado(pedido.uid).recibido ? 'text-green-700' : 'text-orange-600']">
                                                {{ getEstado(pedido.uid).recibido ? 'Preparado' : 'Armando' }}
                                            </span>
                                            <div class="flex items-center gap-2">
                                                <i v-if="estadosPedidos[pedido.uid]?.guardado" data-lucide="cloud" class="w-4 h-4 text-blue-500"></i>
                                                <div class="flex items-center">
                                                    <input type="checkbox" :id="'sw-'+pedido.uid" class="toggle-input"
                                                           :checked="getEstado(pedido.uid).recibido"
                                                           @change="toggleEstado(pedido.uid, $event.target.checked)">
                                                    <label :for="'sw-'+pedido.uid" class="toggle-switch scale-75 origin-right"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Lista Items (Scrollable) -->
                                        <div class="p-2 flex-1 max-h-[220px] overflow-y-auto custom-scroll bg-white relative">
                                            <div v-if="loadingOrders[pedido.uid]" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                                                <div class="animate-spin text-orange-500"><i data-lucide="loader-2" class="w-6 h-6"></i></div>
                                            </div>
                                            <div v-for="(item, iIdx) in getItemsToShow(pedido)" :key="iIdx" class="flex justify-between items-center py-1.5 border-b border-dashed border-slate-100 last:border-0 hover:bg-slate-50 px-1 group/item text-xs">
                                                <div class="flex-1 pr-2 leading-snug">
                                                    <div class="font-medium text-slate-700">
                                                        <span class="bg-slate-100 border border-slate-200 px-1 py-0.5 rounded font-bold text-slate-800 mr-1">{{ item.cantidad }}</span>
                                                        {{ item.nombre }}
                                                    </div>
                                                    <div class="text-[10px] text-slate-400 pl-1 mt-0.5">{{ formatMoney(item.precio_unitario) }} u.</div>
                                                </div>
                                                <div class="flex flex-col items-end gap-0.5 shrink-0">
                                                    <span class="font-bold text-slate-700">{{ formatMoney(item.subtotal) }}</span>
                                                    <!-- Botones flotantes -->
                                                    <div v-if="!isOriginalView(pedido.uid)" class="flex gap-1 opacity-0 group-hover/item:opacity-100 transition-opacity bg-white shadow-sm rounded border border-slate-100 p-0.5 origin-right">
                                                        <button @click="modItem(pedido.uid, iIdx, 1)" class="w-4 h-4 flex items-center justify-center bg-green-50 text-green-600 rounded hover:bg-green-100"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                                        <button @click="modItem(pedido.uid, iIdx, -1)" class="w-4 h-4 flex items-center justify-center bg-orange-50 text-orange-600 rounded hover:bg-orange-100"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                                        <button @click="delItem(pedido.uid, iIdx)" class="w-4 h-4 flex items-center justify-center bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Footer Controles -->
                                        <div class="p-2 bg-slate-50 border-t border-slate-200 space-y-2">
                                            <div class="grid grid-cols-2 gap-1.5">
                                                <button @click="guardarCloud(pedido)" class="bg-slate-800 text-white py-1.5 rounded hover:bg-slate-900 transition text-[10px] font-bold flex items-center justify-center gap-1">
                                                    <i data-lucide="cloud" class="w-3 h-3"></i> Guardar Cloud
                                                </button>
                                                <button @click="previewPDF(pedido)" class="bg-orange-500 text-white py-1.5 rounded hover:bg-orange-600 transition text-[10px] font-bold flex items-center justify-center gap-1">
                                                    <i data-lucide="file-search" class="w-3 h-3"></i> PDF +10%
                                                </button>
                                                
                                                <button @click="openAddModal(pedido.uid)" class="bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 py-1.5 rounded text-[10px] font-bold transition">
                                                    + Prod
                                                </button>
                                                <button @click="toggleOriginal(pedido.uid)" :class="['py-1.5 rounded text-[10px] font-bold transition border', isOriginalView(pedido.uid) ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50']">
                                                    {{ isOriginalView(pedido.uid) ? 'Volver' : 'Original' }}
                                                </button>
                                                
                                                <button @click="actualizarPrecios(pedido.uid, false)" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 py-1.5 rounded text-[10px] font-bold transition">$ Act</button>
                                                <button @click="actualizarPrecios(pedido.uid, true)" class="bg-white border border-teal-300 text-teal-600 hover:bg-teal-50 py-1.5 rounded text-[10px] font-bold transition">$ -3%</button>
                                            </div>

                                            <div class="flex gap-1 pt-1">
                                                <button @click="guardarCambios(pedido.uid)" :disabled="isOriginalView(pedido.uid)" class="flex-1 bg-green-600 text-white py-1.5 rounded text-[10px] font-bold hover:bg-green-700 shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
                                                    Confirmar
                                                </button>
                                                <button @click="eliminarPedido(pedido)" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 px-2 rounded transition" title="Eliminar Pedido">
                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botón Cargar Más -->
                                <button v-if="shouldShowLoadMore(clientName, orders)" @click="loadMore(clientName)" class="w-full mt-6 py-3 bg-white border border-slate-200 text-slate-500 font-bold text-sm rounded-xl hover:bg-slate-50 hover:text-slate-700 transition shadow-sm flex items-center justify-center gap-2">
                                    <i data-lucide="arrow-down-circle" class="w-5 h-5"></i> Cargar más...
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- TOOLBAR FLOTANTE FIJA -->
        <transition name="fade">
            <div v-if="selectedOrders.length > 0" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700">
                <span class="font-bold text-orange-300 text-sm whitespace-nowrap">{{ selectedOrders.length }} seleccionados</span>
                <div class="h-6 w-px bg-slate-700"></div>
                <button @click="accionMasivaPedidos('cloud')" class="hover:text-green-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="cloud" class="w-4 h-4"></i> Guardar Cloud (PDF Normal)
                </button>
                <button @click="accionMasivaPedidos('pdf')" class="hover:text-orange-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Ver PDF +10%
                </button>
                <!-- Botón PDF GIGANTE -->
                <button @click="accionMasivaPedidos('pdf-giant')" class="hover:text-purple-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="file-plus" class="w-4 h-4"></i> PDF GIGANTE
                </button>
                <div class="h-6 w-px bg-slate-700"></div>
                <button @click="selectedOrders = []" class="hover:text-red-400 hover:bg-slate-800 p-1 rounded-full transition" title="Cancelar selección">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </transition>

        <!-- MODAL: AÑADIR PRODUCTO -->
        <div v-if="modalOpen" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" @click.self="modalOpen = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-5 transform transition-all scale-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="package-plus" class="w-5 h-5 text-blue-600"></i> Añadir
                    </h3>
                    <button @click="modalOpen = false" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1 rounded transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IDs x Cantidad</label>
                        <input v-model="modalInput" type="text" ref="modalInputRef" class="w-full border-2 border-slate-200 rounded-lg p-2 text-base font-mono focus:border-blue-500 outline-none transition-all placeholder:text-slate-300" placeholder="Ej: 353x5, 102x1" @keyup.enter="addProducts">
                    </div>
                    <label class="flex items-center gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition select-none">
                        <input type="checkbox" v-model="modalApplyDiscount" class="w-4 h-4 rounded border-slate-300 text-green-600 focus:ring-green-500">
                        <span class="text-sm font-bold text-slate-700">Aplicar -3% descuento</span>
                    </label>
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button @click="modalOpen = false" class="px-4 py-2 font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition text-sm">Cancelar</button>
                    <button @click="addProducts" class="px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md transition text-sm">Añadir</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, nextTick } = Vue;
        const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        // Check Login
        if (localStorage.getItem('loggedUser') !== 'admin') window.location.href = 'index.html';

        createApp({
            data() {
                return {
                    // Datos
                    rawPedidos: [],
                    peticiones: [],
                    productos: [],
                    
                    // Estado Local
                    estadosPedidos: JSON.parse(localStorage.getItem('estadosPedidos') || '{}'),
                    originalCache: JSON.parse(localStorage.getItem('originalPedidosCache') || '{}'),
                    usedButtons: JSON.parse(localStorage.getItem('usedButtons') || '{}'),
                    
                    // UI State
                    search: '',
                    activeClient: null,
                    loadedCounts: {},
                    selectedOrders: [],
                    selectedPeticiones: [],
                    
                    // Focus Mode State
                    focusMode: false,
                    focusedItem: null,
                    focusType: null, // 'pedido' o 'peticion'
                    
                    // Modals
                    mensaje: '',
                    mensajeTipo: 'info',
                    loadingOrders: {},
                    modalOpen: false,
                    modalPedidoId: null,
                    modalInput: '',
                    modalApplyDiscount: false
                }
            },
            computed: {
                filteredClients() {
                    const groups = {};
                    this.rawPedidos.forEach((p, index) => {
                        p.uid = p.id ? String(p.id) : `${p.user}-${index}`;
                        const name = p.user || 'Invitado';
                        if (!groups[name]) groups[name] = [];
                        groups[name].push(p);
                    });

                    for(const key in groups) groups[key].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

                    if (!this.search) return groups;
                    
                    const q = this.search.toLowerCase();
                    const result = {};
                    for (const [name, orders] of Object.entries(groups)) {
                        if (name.toLowerCase().includes(q) || orders.some(o => String(o.id).includes(q) || o.items.some(i => i.nombre.toLowerCase().includes(q)))) {
                            result[name] = orders;
                        }
                    }
                    return result;
                }
            },
            methods: {
                // UTILS
                formatMoney(val) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val || 0); },
                formatDate(iso) { 
                    if (!iso) return ''; const d = new Date(iso);
                    return d.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
                },
                showMsg(msg, type='info') {
                    this.mensaje = msg; this.mensajeTipo = type;
                    setTimeout(() => this.mensaje = '', 3000);
                },
                saveStorage() {
                    localStorage.setItem('estadosPedidos', JSON.stringify(this.estadosPedidos));
                    localStorage.setItem('originalPedidosCache', JSON.stringify(this.originalCache));
                    localStorage.setItem('usedButtons', JSON.stringify(this.usedButtons));
                },
                
                // DATA
                async loadAll() {
                    try {
                        const [resProd, resPed, resPet] = await Promise.all([
                            fetch(`${apiBase}/productos`), fetch(`${apiBase}/pedidos`), fetch(`${apiBase}/peticiones`)
                        ]);
                        this.productos = await resProd.json();
                        this.rawPedidos = await resPed.json();
                        this.peticiones = await resPet.json();
                        
                        const parser = (list) => list.forEach(p => { 
                             if(typeof p.items === 'string') { try { p.items = JSON.parse(p.items); } catch { p.items = []; } }
                        });
                        parser(this.rawPedidos); parser(this.peticiones);
                        nextTick(() => lucide.createIcons());
                    } catch (e) { console.error(e); }
                },

                // UI LOGIC
                toggleClient(name) {
                    this.activeClient = this.activeClient === name ? null : name;
                    if (this.activeClient) this.loadedCounts[name] = 12;
                    nextTick(() => lucide.createIcons());
                },
                shouldShowLoadMore(name, group) { return group.length > (this.loadedCounts[name] || 12); },
                loadMore(name) { this.loadedCounts[name] = (this.loadedCounts[name] || 12) + 12; },
                getItemsSlice(name, group) { return group.slice(0, this.loadedCounts[name] || 12); },

                // FOCUS LOGIC
                enfocarItem(item, type) {
                    this.focusedItem = item;
                    this.focusType = type;
                    this.focusMode = true;
                    window.scrollTo({top: 0, behavior: 'smooth'});
                },
                clearFocus() {
                    this.focusMode = false;
                    this.focusedItem = null;
                    this.focusType = null;
                    nextTick(() => lucide.createIcons());
                },

                // ESTADOS
                getEstado(uid) {
                    if (!this.estadosPedidos[uid]) this.estadosPedidos[uid] = { recibido: false, guardado: false };
                    return this.estadosPedidos[uid];
                },
                toggleEstado(uid, val) {
                    this.getEstado(uid).recibido = val;
                    this.saveStorage();
                },

                // ORIGINAL
                isOriginalView(uid) { return this.estadosPedidos[uid]?.viewOriginal || false; },
                toggleOriginal(uid) {
                    const st = this.getEstado(uid);
                    st.viewOriginal = !st.viewOriginal;
                    if (st.viewOriginal && !this.originalCache[uid]) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) { this.originalCache[uid] = JSON.parse(JSON.stringify(p.items)); this.saveStorage(); }
                    }
                },
                getItemsToShow(pedido) {
                    return (this.isOriginalView(pedido.uid) && this.originalCache[pedido.uid]) ? this.originalCache[pedido.uid] : pedido.items;
                },
                calculateTotal(pedido) {
                    return this.getItemsToShow(pedido).reduce((acc, item) => acc + (Number(item.subtotal)||0), 0);
                },

                // ACCIONES
                async guardarCloud(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        const res = await fetch(`${apiBase}/pedidos/${pedido.id}/pdf`);
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                        this.getEstado(pedido.uid).guardado = true; this.saveStorage();
                    } catch(e) { this.showMsg('Error PDF', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                async previewPDF(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        const itemsModified = pedido.items.map(i => ({
                            ...i, precio_unitario: i.precio_unitario * 1.10, subtotal: i.subtotal * 1.10
                        }));
                        const payload = {
                            user: pedido.user, items: itemsModified,
                            total: itemsModified.reduce((a,b)=>a+b.subtotal,0),
                            fecha: new Date().toISOString(), nombre_negocio: pedido.nombre_negocio
                        };
                        const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                    } catch(e) { this.showMsg('Error Generando', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                
                async guardarCambios(uid) {
                    if(!confirm('¿Guardar cambios permanentemente?')) return;
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const estado = this.getEstado(uid);

                    if(!this.originalCache[uid]) this.originalCache[uid] = JSON.parse(JSON.stringify(pedido.items));

                    const deltaMap = new Map();
                    const oldItems = this.originalCache[uid];
                    const newItems = pedido.items;
                    
                    oldItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) - Number(i.cantidad))); 
                    newItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) + Number(i.cantidad))); 
                    
                    const stockUpdates = [];
                    for(const [id, delta] of deltaMap.entries()) {
                         if(delta > 0) stockUpdates.push({id, cantidad: delta});
                         else if (delta < 0 && !estado.recibido) stockUpdates.push({id, cantidad: delta});
                    }

                    try {
                        await fetch(`${apiBase}/actualizar-pedido/${pedido.id}`, {
                            method: 'PUT', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ items: newItems, stockUpdates })
                        });
                        this.originalCache[uid] = JSON.parse(JSON.stringify(newItems)); this.saveStorage();
                        this.showMsg('Guardado OK', 'success');
                    } catch(e) { this.showMsg('Error guardando', 'error'); }
                },

                async eliminarPedido(pedido) {
                    const estado = this.getEstado(pedido.uid);
                    const msg = estado.recibido 
                        ? 'PREPARADO (VERDE). NO SE DEVOLVERÁ STOCK.' 
                        : 'ARMANDO (NARANJA). SE DEVOLVERÁ EL STOCK.';
                    
                    if(!confirm(`¿Eliminar pedido?\n\n${msg}`)) return;

                    await fetch(`${apiBase}/eliminar-pedido/${pedido.id}`, {
                        method: 'DELETE', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ recibido: estado.recibido })
                    });
                    this.rawPedidos = this.rawPedidos.filter(p => p.uid !== pedido.uid);
                    if(this.filteredClients[pedido.user]?.length === 0) this.activeClient = null;
                    if(this.focusMode) this.clearFocus();
                },

                // EDICION
                modItem(uid, idx, chg) {
                    const item = this.rawPedidos.find(p => p.uid === uid).items[idx];
                    item.cantidad = Math.max(1, Number(item.cantidad) + chg);
                    item.subtotal = item.cantidad * item.precio_unitario;
                },
                delItem(uid, idx) {
                    if(!confirm('¿Borrar item?')) return;
                    this.rawPedidos.find(p => p.uid === uid).items.splice(idx, 1);
                },
                async actualizarPrecios(uid, discount) {
                    if(this.isOriginalView(uid)) return alert('Sal de original');
                    if(!confirm('¿Actualizar precios?')) return;
                    
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const precioMap = new Map(this.productos.map(p => [p.id, p.precio]));
                    const mult = discount ? 1.10 * 0.97 : 1.10;
                    
                    pedido.items.forEach(i => {
                        const base = precioMap.get(i.id);
                        if(base) {
                            i.precio_unitario = Number((base * mult).toFixed(2));
                            i.subtotal = i.cantidad * i.precio_unitario;
                        }
                    });
                    this.showMsg('Precios Actualizados', 'success');
                },

                openAddModal(uid) { this.modalPedidoId = uid; this.modalInput = ''; this.modalOpen = true; nextTick(()=>this.$refs.modalInputRef.focus()); },
                addProducts() {
                    const pedido = this.rawPedidos.find(p => p.uid === this.modalPedidoId);
                    const parts = this.modalInput.split(',').map(s=>s.trim());
                    parts.forEach(part => {
                        const [idStr, qtyStr] = part.split('x');
                        const p = this.productos.find(pr => pr.id == idStr);
                        if(p) {
                            let precio = p.precio * 1.10;
                            if(this.modalApplyDiscount) precio *= 0.97;
                            const qty = parseInt(qtyStr)||1;
                            const exist = pedido.items.find(i => i.id == p.id);
                            if(exist) {
                                exist.cantidad += qty; exist.precio_unitario = precio; exist.subtotal = exist.cantidad * precio;
                            } else {
                                pedido.items.push({ id: p.id, nombre: p.nombre, cantidad: qty, precio_unitario: precio, subtotal: qty*precio });
                            }
                        }
                    });
                    this.modalOpen = false;
                },

                // PETICIONES
                parseItems(items) { return Array.isArray(items) ? items : JSON.parse(items || '[]'); },
                getStockWarning(item) { const p = this.productos.find(pr => pr.id === item.id); return p && item.cantidad > (p.stock||0); },
                
                async confirmarPeticion(peticion, discount) {
                    if(!confirm('¿Aceptar petición?')) return;
                    const items = this.parseItems(peticion.items).map(i => ({
                        id: i.id, cantidad: i.cantidad, precio: discount ? i.precio_unitario * 0.97 : i.precio_unitario
                    }));
                    await fetch(`${apiBase}/guardar-pedidos`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ user: peticion.nombre, pedido: items, user_id: peticion.user_id, nombre_negocio: peticion.nombre_negocio })
                    });
                    await fetch(`${apiBase}/peticiones/${peticion.id}`, { method: 'DELETE' });
                    this.peticiones = this.peticiones.filter(p => p.id !== peticion.id);
                    this.usedButtons[peticion.id] = discount ? 'plus7' : 'normal'; this.saveStorage();
                    this.loadAll(); 
                    if(this.focusMode) this.clearFocus();
                },
                async eliminarPeticion(id) { if(confirm('¿Borrar?')) { await fetch(`${apiBase}/peticiones/${id}`, { method:'DELETE' }); this.peticiones=this.peticiones.filter(p=>p.id!==id); if(this.focusMode) this.clearFocus(); } },
                previewPDFPeticion(p) { this.previewPDF({ user:p.nombre, items:this.parseItems(p.items), fecha:p.fecha, nombre_negocio:p.nombre_negocio }); },
                copiarFaltantesIndividual(p) {
                    const items = this.parseItems(p.items);
                    let txt = "";
                    items.forEach(i => {
                        const pr = this.productos.find(x => x.id === i.id);
                        const falt = Math.max(0, i.cantidad - (pr ? pr.stock : 0));
                        if(falt>0) txt += `${falt} ${i.nombre}\n`;
                    });
                    navigator.clipboard.writeText(txt || "Hay stock");
                    this.showMsg('Copiado', 'success');
                },
                
                copiarFaltantesPeticionesMasivo() {
                    const selected = this.peticiones.filter(p => this.selectedPeticiones.includes(p.id));
                    if(selected.length === 0) return alert('Selecciona peticiones');
                    const agg = {};
                    selected.forEach(p => {
                        this.parseItems(p.items).forEach(i => {
                            if(!agg[i.id]) agg[i.id] = { nombre: i.nombre, cantidad: 0 };
                            agg[i.id].cantidad += Number(i.cantidad);
                        });
                    });
                    let txt = "";
                    for(const id in agg) {
                        const pr = this.productos.find(x => x.id == id);
                        const falt = Math.max(0, agg[id].cantidad - (pr ? pr.stock : 0));
                        if(falt > 0) txt += `${falt} ${agg[id].nombre}\n`;
                    }
                    navigator.clipboard.writeText(txt || "Hay stock");
                    this.showMsg('Faltantes Masivos Copiados', 'success');
                },

                // MASIVO
                async accionMasivaPedidos(mode) {
                    if(!this.selectedOrders.length) return;
                    
                    const pedidos = this.selectedOrders.map(uid => this.rawPedidos.find(p => p.uid === uid)).filter(Boolean);
                    if (mode === 'pdf-giant') {
                        if(!confirm(`¿Generar UN SOLO PDF con ${pedidos.length} pedidos concatenados?`)) return;
                        try {
                            const { PDFDocument } = PDFLib;
                            const mergedPdf = await PDFDocument.create();
                            
                            for (const p of pedidos) {
                                // Obtenemos el PDF individual (usamos preview sin guardar en BD para rapidez, o Cloud si prefieres)
                                // Usamos el endpoint de preview para obtener el binario (necesitaríamos modificar el backend para devolver buffer o blob)
                                // Como el backend devuelve URL firmada, la descargamos.
                                const items = p.items; 
                                const payload = {
                                    user: p.user, items: items,
                                    total: items.reduce((a,b)=>a+(Number(b.subtotal)||0),0),
                                    fecha: new Date().toISOString(), nombre_negocio: p.nombre_negocio
                                };
                                // Generamos PDF temporal en servidor
                                const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
                                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                                });
                                const data = await res.json();
                                if(data.pdf) {
                                    const pdfBytes = await fetch(data.pdf).then(res => res.arrayBuffer());
                                    const pdf = await PDFDocument.load(pdfBytes);
                                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                                }
                            }
                            const mergedPdfBytes = await mergedPdf.save();
                            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                            const url = URL.createObjectURL(blob);
                            window.open(url, '_blank');
                        } catch (e) {
                            console.error(e);
                            this.showMsg('Error generando PDF Gigante', 'error');
                        }
                        this.selectedOrders = [];
                        return;
                    }

                    if(!confirm(`¿Procesar ${this.selectedOrders.length} pedidos?`)) return;
                    for(const uid of this.selectedOrders) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) {
                            if(mode==='cloud') await this.guardarCloud(p); 
                            else if(mode==='pdf') await this.previewPDF(p);
                            await new Promise(r=>setTimeout(r,500));
                        }
                    }
                    this.selectedOrders = [];
                },
                async procesarPeticionesMasivo(discount) {
                    if(!confirm(`¿Procesar ${this.selectedPeticiones.length}?`)) return;
                    for(const pid of this.selectedPeticiones) {
                        const p = this.peticiones.find(x => x.id === pid);
                        if(p) await this.confirmarPeticion(p, discount);
                    }
                    this.selectedPeticiones = [];
                }
            },
            mounted() { this.loadAll(); }
        }).mount('#app');
    </script>
</body>
</html>
