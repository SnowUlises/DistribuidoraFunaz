<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Distribuidora Funaz</title>
  <style>
    :root {
      --primary: #2e7d32;      /* Verde Bosque */
      --primary-hover: #1b5e20;
      --accent: #66bb6a;       /* Verde Suave */
      --bg: #f1f8e9;           /* Fondo muy claro */
      --surface: #ffffff;      /* Tarjetas blancas */
      --text: #1b1b1b;
      --text-sec: #555;
      --danger: #ef5350;
      --warning: #ffa726;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
      --cols: 5; 
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 3rem;
    }

    /* HEADER & CONTROLS (Igual que antes) */
    header {
      background: var(--surface);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); display:flex; gap:0.5rem; align-items:center; }
    .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    input[type="text"], input[type="number"] { padding: 0.6rem 1rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
    input[type="text"]:focus { border-color: var(--primary); }
    button { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #eee; color: #333; display: flex; align-items: center; gap: 0.5rem; }
    button:hover { background: #ddd; }
    button.primary { background: var(--primary); color: white; }
    button.primary:hover { background: var(--primary-hover); }
    button.danger { background: white; color: var(--danger); border: 1px solid var(--danger); }
    button.danger:hover { background: var(--danger); color: white; }
    button.group-mode-btn.active { background: var(--warning); color: white; animation: pulse 2s infinite; }

    /* GRID LAYOUT */
    .grid-controls { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-sec); }
    
    .orders-grid {
      display: grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: 1.5rem;
      padding: 2rem;
      align-items: start; /* Importante para que no se estiren */
    }
    
    @media (max-width: 1400px) { :root { --cols: 4; } }
    @media (max-width: 1100px) { :root { --cols: 3; } }
    @media (max-width: 800px) { :root { --cols: 2; } }
    @media (max-width: 500px) { :root { --cols: 1; } }

    /* CLIENT CARD (Agrupador) */
    .client-card {
      background: var(--surface);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 0; /* Padding interno controlado */
      overflow: hidden;
      border: 2px solid transparent;
      transition: transform 0.2s;
    }
    .client-card:hover { transform: translateY(-3px); }
    .client-card.selected-merge { border-color: var(--warning); background: #fff8e1; }

    .client-header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .client-name { font-size: 1.1rem; font-weight: 700; }
    .client-total-debt { font-size: 0.9rem; opacity: 0.9; }

    /* SUB ORDER (Pedido individual dentro del cliente) */
    .sub-order {
      border-bottom: 1px solid #eee;
      padding: 1rem;
      background: #fff;
    }
    .sub-order:last-child { border-bottom: none; }
    
    .sub-order-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-sec);
      margin-bottom: 0.5rem;
    }
    
    .sub-items { margin-bottom: 0.5rem; font-size: 0.9rem; }
    .sub-item-row { display: flex; justify-content: space-between; padding: 2px 0; }

    .sub-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    
    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
    }

    /* LOAD MORE BUTTON */
    .hidden-orders { display: none; }
    .hidden-orders.show { display: block; animation: fadeIn 0.3s; }
    
    .load-more-container {
      text-align: center;
      padding: 0.5rem;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 600;
      transition: background 0.2s;
    }
    .load-more-container:hover { background: #e0e0e0; }

    /* MODAL (Mismo estilo) */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal-overlay.open { display: flex; }
    .modal { background: white; padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .product-search-results { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-top: 0.5rem; display: none; }
    .product-search-results.active { display: block; }
    .search-result-item { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; }
    .search-result-item:hover { background: #f1f8e9; }
    .badge { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; background: #eee; }
    .badge.guardado { background: #c8e6c9; color: #2e7d32; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 167, 38, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 167, 38, 0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

  <header>
    <div class="brand">
      <span>üåø</span> Distribuidora Funaz
    </div>

    <div class="controls">
      <input type="text" id="searchInput" class="search-bar" placeholder="üîç Buscar por cliente..." onkeyup="filterOrders()">
      
      <div class="grid-controls">
        <span>Grid:</span>
        <input type="range" min="1" max="6" value="5" id="gridSlider" oninput="updateGridCols(this.value)">
        <span id="gridVal">5</span>
      </div>

      <button class="group-mode-btn" id="btnGroupMode" onclick="toggleGroupMode()">
        üîó Modo Agrupar
      </button>

      <button class="primary" onclick="loadAllData()">üîÑ Actualizar</button>
      <button onclick="location.href='index.html'">‚Üê Salir</button>
    </div>
  </header>

  <main>
    <div id="loadingMsg" class="loading">Cargando pedidos...</div>
    <div id="ordersGrid" class="orders-grid"></div>
  </main>

  <div class="modal-overlay" id="productModal">
    <div class="modal">
      <h3>A√±adir Producto</h3>
      <form id="addProductForm" onsubmit="event.preventDefault(); submitAddProduct();">
        <label style="display:block; margin-bottom:0.5rem">Buscar Producto:</label>
        <input type="text" id="prodSearch" placeholder="Escribe nombre..." style="width:100%" autocomplete="off" onkeyup="searchProducts(this.value)">
        
        <div id="prodResults" class="product-search-results"></div>

        <div style="display:flex; gap:1rem; margin-top:1rem;">
            <div style="flex:1">
                <label>Nombre/ID Seleccionado:</label>
                <input type="text" id="selectedProdName" readonly style="background:#f9f9f9; width:100%">
            </div>
            <div style="width: 80px">
                <label>Cant:</label>
                <input type="number" id="prodQty" value="1" min="1" style="width:100%">
            </div>
        </div>

        <div style="display:flex; gap:1rem; margin-top:1rem;">
            <div style="flex:1">
                 <label>Precio Unit:</label>
                 <input type="number" id="prodPrice" step="0.01" style="width:100%">
            </div>
             <div style="padding-top:24px">
                <label><input type="checkbox" id="applyDiscount"> -3%</label>
             </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
          <button type="button" onclick="closeProductModal()">Cancelar</button>
          <button type="submit" class="primary">A√±adir al Pedido</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // ================= CONFIGURACI√ìN =================
  const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  const user = localStorage.getItem('loggedUser');
  if (user !== 'admin') window.location.href = 'index.html';

  // ================= ESTADO =================
  let globalOrders = [];       // Todos los pedidos planos
  let productsCatalog = [];    
  let groupingMode = false;    
  let mergeSelection = [];     // Nombres de usuarios seleccionados para agrupar
  let currentTargetPedidoId = null; 
  let localStates = JSON.parse(localStorage.getItem('estadosPedidos') || '{}');

  // ================= INICIO =================
  document.addEventListener('DOMContentLoaded', () => {
    loadAllData();
    loadProductsCatalog();
    const savedCols = localStorage.getItem('gridCols') || 5;
    updateGridCols(savedCols);
    document.getElementById('gridSlider').value = savedCols;
  });

  // ================= CARGA DE DATOS =================
  async function loadAllData() {
    const msg = document.getElementById('loadingMsg');
    try {
        const res = await fetch(`${apiBase}/pedidos`);
        if (!res.ok) throw new Error('Error API');
        const data = await res.json();
        
        globalOrders = data.map((pedido, idx) => {
            let items = [];
            try { items = typeof pedido.items === 'string' ? JSON.parse(pedido.items) : pedido.items; } catch(e) { items = []; }
            if(!Array.isArray(items)) items = [];
            const uid = pedido.id || `temp-${pedido.user}-${idx}`;
            return {
                ...pedido,
                uid: uid,
                items: items,
                total: items.reduce((acc, i) => acc + (Number(i.subtotal)||0), 0)
            };
        });

        // Ordenar global por fecha m√°s reciente
        globalOrders.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
        msg.style.display = 'none';
        
        renderGroups(); // Llama a la nueva funci√≥n de renderizado por grupos

    } catch (err) {
        msg.textContent = 'Error al cargar. ' + err.message;
        console.error(err);
    }
  }

  async function loadProductsCatalog() {
      try {
          const res = await fetch(`${apiBase}/productos`); 
          if(res.ok) productsCatalog = await res.json();
      } catch(e) {}
  }

  // ================= L√ìGICA DE GRUPOS =================
  function groupOrdersByUser(orders) {
      const groups = {};
      orders.forEach(o => {
          const uName = o.user || 'Invitado';
          if (!groups[uName]) groups[uName] = [];
          groups[uName].push(o);
      });
      return groups;
  }

  function renderGroups(ordersToRender = globalOrders) {
    const grid = document.getElementById('ordersGrid');
    grid.innerHTML = '';

    const grouped = groupOrdersByUser(ordersToRender);
    const userNames = Object.keys(grouped);

    if (userNames.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">No se encontraron pedidos.</p>';
        return;
    }

    userNames.forEach(uName => {
        const userOrders = grouped[uName];
        // Calcular deuda total de este usuario
        const totalDebt = userOrders.reduce((sum, o) => sum + o.total, 0);

        // Crear Tarjeta de Cliente
        const card = document.createElement('div');
        card.className = 'client-card';
        card.dataset.user = uName; // Para seleccionar en modo merge
        card.onclick = (e) => handleGroupClick(e, uName);

        // Header del Cliente
        let html = `
            <div class="client-header">
                <div class="client-name">${uName}</div>
                <div class="client-total-debt">Total: $${formatMoney(totalDebt)}</div>
            </div>
            <div class="client-body">
        `;

        // L√≥gica de "Mostrar solo X"
        const SHOW_LIMIT = 2; // Cantidad a mostrar inicialmente
        const hasMore = userOrders.length > SHOW_LIMIT;

        userOrders.forEach((pedido, index) => {
            const isHidden = index >= SHOW_LIMIT;
            const hiddenClass = isHidden ? 'hidden-orders' : '';
            const localKey = getLocalKey(pedido);
            const state = localStates[localKey] || {};
            const dateStr = new Date(pedido.fecha).toLocaleDateString('es-ES', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});

            html += `
            <div class="sub-order ${hiddenClass}" id="sub-order-${pedido.uid}">
                <div class="sub-order-header">
                    <span>üìÖ ${dateStr} (ID: ${pedido.uid.toString().slice(-4)})</span>
                    ${state.guardado ? '<span class="badge guardado">Guardado</span>' : ''}
                </div>
                
                <div class="sub-items">
                    ${pedido.items.map((it, i) => `
                        <div class="sub-item-row">
                            <span>${it.cantidad}x ${it.nombre}</span>
                            <span>
                                $${formatMoney(it.subtotal)} 
                                <button class="btn-xs danger" style="display:inline; padding:0 4px; margin-left:5px" onclick="event.stopPropagation(); deleteItem('${pedido.uid}', ${i})">x</button>
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align:right; font-weight:bold; font-size:0.9rem; margin-bottom:5px">
                   Subtotal: $${formatMoney(pedido.total)}
                </div>

                <div class="sub-actions">
                    <label style="font-size:0.8rem; display:flex; align-items:center; gap:4px" onclick="event.stopPropagation()">
                        <input type="checkbox" ${state.guardado ? 'checked' : ''} onchange="toggleLocalState('${pedido.uid}', 'guardado', this)"> üíæ
                    </label>
                    <button class="btn-small primary" onclick="event.stopPropagation(); openProductModal('${pedido.uid}')">+ Prod</button>
                    <button class="btn-small" onclick="event.stopPropagation(); saveChanges('${pedido.uid}')">‚úÖ Guardar</button>
                    <button class="btn-small danger" onclick="event.stopPropagation(); deletePedido('${pedido.uid}')">üóëÔ∏è</button>
                    <button class="btn-small" style="background:#607d8b; color:white" onclick="event.stopPropagation(); previewPDF('${pedido.uid}')">üìÑ</button>
                </div>
            </div>`;
        });

        html += `</div>`; // Cerrar client-body

        // Bot√≥n Ver M√°s
        if (hasMore) {
            html += `
            <div class="load-more-container" onclick="event.stopPropagation(); toggleShowMore(this)">
                Ver ${userOrders.length - SHOW_LIMIT} pedidos m√°s ‚ñº
            </div>`;
        }

        card.innerHTML = html;
        grid.appendChild(card);
    });
  }

  function toggleShowMore(btn) {
      const card = btn.closest('.client-card');
      const hidden = card.querySelectorAll('.hidden-orders');
      
      if(hidden.length > 0) {
          // Mostrar
          hidden.forEach(el => el.classList.add('show'));
          btn.innerHTML = 'Ocultar pedidos ‚ñ≤';
      } else {
          // Ocultar (necesitamos quitar la clase show)
          const all = card.querySelectorAll('.sub-order');
          all.forEach((el, idx) => {
              if(idx >= 2) el.classList.remove('show');
          });
          btn.innerHTML = `Ver m√°s pedidos ‚ñº`;
      }
  }

  // ================= FILTRADO =================
  function filterOrders() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      // Filtramos sobre el global, pero renderGroups se encarga de agrupar
      const filtered = globalOrders.filter(o => 
          (o.user && o.user.toLowerCase().includes(query)) || 
          (o.uid && o.uid.toString().includes(query))
      );
      renderGroups(filtered);
  }

  function updateGridCols(val) {
      document.documentElement.style.setProperty('--cols', val);
      document.getElementById('gridVal').textContent = val;
      localStorage.setItem('gridCols', val);
  }

  // ================= AGRUPAMIENTO DE CLIENTES (MERGE) =================
  function toggleGroupMode() {
      groupingMode = !groupingMode;
      mergeSelection = [];
      const btn = document.getElementById('btnGroupMode');
      
      if(groupingMode) {
          btn.classList.add('active');
          btn.innerHTML = '‚ùå Cancelar';
          alert('MODO FUSI√ìN DE CLIENTES:\n1. Selecciona el Cliente DESTINO (el que quedar√°).\n2. Selecciona el Cliente A MOVER (el que desaparecer√°).');
      } else {
          btn.classList.remove('active');
          btn.innerHTML = 'üîó Modo Agrupar';
          document.querySelectorAll('.client-card').forEach(c => c.classList.remove('selected-merge'));
      }
  }

  async function handleGroupClick(e, uName) {
      if (!groupingMode) return;
      
      // Encontrar la carta visualmente para marcarla
      const card = e.currentTarget;
      
      if (mergeSelection.includes(uName)) {
          mergeSelection = mergeSelection.filter(n => n !== uName);
          card.classList.remove('selected-merge');
          return;
      }

      mergeSelection.push(uName);
      card.classList.add('selected-merge');

      if (mergeSelection.length === 2) {
          await executeClientMerge();
      }
  }

  async function executeClientMerge() {
      const targetUser = mergeSelection[0]; // El primero seleccionado es el destino
      const sourceUser = mergeSelection[1]; // El segundo se une al primero
      
      if(!confirm(`¬øUnir todos los pedidos de "${sourceUser}" dentro de "${targetUser}"?\n\n"${sourceUser}" desaparecer√°.`)) {
          toggleGroupMode();
          return;
      }

      // Encontrar todos los pedidos del sourceUser
      const sourceOrders = globalOrders.filter(o => o.user === sourceUser);
      
      try {
          // Para cada pedido del usuario origen, actualizamos su nombre al usuario destino
          // Esto es m√°s eficiente que fusionar arrays gigantes, mantenemos pedidos individuales pero bajo un solo nombre.
          
          for (const order of sourceOrders) {
             const payload = { 
                 items: order.items, 
                 total: order.total,
                 user: targetUser // AQU√ç EL CAMBIO CLAVE
             };

             // Usamos el mismo endpoint de actualizar
             await fetch(`${apiBase}/actualizar-pedido/${order.uid}`, {
                 method: 'PUT',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify(payload)
             });
          }

          alert('Clientes fusionados con √©xito.');
          toggleGroupMode();
          loadAllData();

      } catch (err) {
          console.error(err);
          alert('Error al fusionar clientes.');
          toggleGroupMode();
      }
  }

  // ================= MODAL PRODUCTOS Y UTILS (Sin cambios mayores) =================
  function openProductModal(pedidoId) {
      currentTargetPedidoId = pedidoId;
      document.getElementById('productModal').classList.add('open');
      document.getElementById('prodSearch').value = '';
      document.getElementById('prodSearch').focus();
      document.getElementById('prodResults').innerHTML = '';
      document.getElementById('selectedProdName').value = '';
      document.getElementById('prodQty').value = 1;
      document.getElementById('prodPrice').value = '';
  }

  function closeProductModal() {
      document.getElementById('productModal').classList.remove('open');
      currentTargetPedidoId = null;
  }

  function searchProducts(query) {
      const list = document.getElementById('prodResults');
      list.innerHTML = '';
      if(query.length < 2) { list.classList.remove('active'); return; }
      const matches = productsCatalog.filter(p => p.nombre.toLowerCase().includes(query.toLowerCase()));
      
      if(matches.length > 0) {
          list.classList.add('active');
          matches.slice(0, 10).forEach(p => {
              const div = document.createElement('div');
              div.className = 'search-result-item';
              div.textContent = `${p.nombre} ($${p.precio})`;
              div.onclick = () => selectProduct(p);
              list.appendChild(div);
          });
      } else list.classList.remove('active');
  }

  function selectProduct(prod) {
      document.getElementById('selectedProdName').value = prod.nombre;
      document.getElementById('prodPrice').value = prod.precio;
      document.getElementById('prodResults').classList.remove('active');
      document.getElementById('prodSearch').value = prod.nombre;
  }

  async function submitAddProduct() {
      if(!currentTargetPedidoId) return;
      const name = document.getElementById('prodSearch').value || document.getElementById('selectedProdName').value;
      const qty = parseFloat(document.getElementById('prodQty').value);
      const price = parseFloat(document.getElementById('prodPrice').value);
      const applyDisc = document.getElementById('applyDiscount').checked;

      if(!name || !qty || isNaN(price)) { alert('Datos incompletos'); return; }
      let finalPrice = applyDisc ? price * 0.97 : price;

      const pedido = globalOrders.find(o => o.uid === currentTargetPedidoId);
      if(!pedido) return;

      const newItem = { id: 'manual-'+Date.now(), nombre: name, cantidad: qty, precio_unitario: finalPrice, subtotal: qty * finalPrice };
      pedido.items.push(newItem);
      
      // Al a√±adir producto, nos aseguramos de enviar el user actual para no perder nombre si se renombr√≥
      await savePedidoToApi(pedido); 
      closeProductModal();
      // Recargar solo renderizado visual para rapidez
      renderGroups(); 
  }

  async function deleteItem(pedidoId, itemIndex) {
      if(!confirm('¬øBorrar producto?')) return;
      const pedido = globalOrders.find(o => o.uid === pedidoId);
      if(pedido) {
          pedido.items.splice(itemIndex, 1);
          renderGroups();
      }
  }

  async function saveChanges(pedidoId) {
      const pedido = globalOrders.find(o => o.uid === pedidoId);
      if(!pedido || !confirm(`¬øGuardar cambios en pedido de ${pedido.user}?`)) return;
      await savePedidoToApi(pedido);
      alert('Guardado.');
  }

  async function savePedidoToApi(pedido) {
      const itemsPayload = pedido.items.map(i => ({
          id: i.id, nombre: i.nombre, cantidad: i.cantidad, precio_unitario: i.precio_unitario, subtotal: i.cantidad * i.precio_unitario
      }));
      // Importante: Enviamos el 'user' en el payload para asegurar que el backend sepa de quien es
      const payload = { items: itemsPayload, stockUpdates: [], user: pedido.user };

      await fetch(`${apiBase}/actualizar-pedido/${pedido.uid}`, {
          method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
  }

  async function deletePedido(uid) {
      if(!confirm('¬øEliminar pedido permanentemente?')) return;
      try {
          const res = await fetch(`${apiBase}/eliminar-pedido/${encodeURIComponent(uid)}`, {
              method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ recibido: false })
          });
          if(res.ok) {
              globalOrders = globalOrders.filter(o => o.uid !== uid);
              renderGroups();
          }
      } catch(e) { console.error(e); }
  }

  async function previewPDF(uid) {
      const pedido = globalOrders.find(o => o.uid === uid);
      if(!pedido) return;
      const payload = {
        user: pedido.user, items: pedido.items, total: pedido.items.reduce((s, i) => s + (i.cantidad * i.precio_unitario), 0), fecha: pedido.fecha
      };
      try {
          const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
              method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
          });
          const data = await res.json();
          if(data.ok && data.pdf) window.open(data.pdf, '_blank');
      } catch(e) { console.error(e); }
  }

  function formatMoney(amount) { return parseFloat(amount).toFixed(2); }
  function getLocalKey(pedido) { return pedido.id || `${pedido.user}-${new Date(pedido.fecha).getTime()}`; }
  function toggleLocalState(uid, type, checkbox) {
      const pedido = globalOrders.find(o => o.uid === uid);
      const key = getLocalKey(pedido);
      if(!localStates[key]) localStates[key] = {};
      localStates[key][type] = checkbox.checked;
      localStorage.setItem('estadosPedidos', JSON.stringify(localStates));
      renderGroups();
  }
</script>
</body>
</html>

