<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Funaz (Split View)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; }
        
        /* Scrollbar Fina */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Switch Toggle */
        .toggle-switch {
            position: relative; width: 36px; height: 20px;
            background-color: #fb923c; /* Orange default */
            border-radius: 9999px; cursor: pointer; transition: background-color 0.3s ease;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 16px; height: 16px; background-color: white; border-radius: 50%;
            transition: transform 0.3s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .toggle-input:checked + .toggle-switch { background-color: #16a34a; /* Green */ }
        .toggle-input:checked + .toggle-switch::after { transform: translateX(16px); }
        .toggle-input { display: none; }

        /* Animaciones */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen pb-32 text-slate-800">
        
        <header class="bg-white sticky top-0 z-50 border-b border-red-100 shadow-sm backdrop-blur-md bg-opacity-95">
            <div class="max-w-[1920px] mx-auto px-6 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                        <i data-lucide="gift" class="w-5 h-5 text-red-500"></i> Panel de Control
                    </h1>
                </div>

                <div class="w-full md:w-[600px] relative group" v-if="!focusMode">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-red-500 transition-colors"></i>
                    </div>
                    <input v-model="search" type="text" placeholder="Buscar cliente, ID, producto..." 
                        class="w-full pl-11 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-base focus:bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all shadow-sm">
                    <button v-if="search" @click="search = ''" class="absolute right-3 top-2.5 text-slate-400 hover:text-red-500 transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <div v-else class="flex-1 flex justify-center">
                    <button @click="clearFocus" class="bg-slate-800 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-slate-700 transition flex items-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i> Cerrar Vista Enfocada
                    </button>
                </div>

                <div class="flex items-center gap-3" v-if="!focusMode">
                    <div class="bg-red-50 text-red-700 px-4 py-2 rounded-lg font-bold border border-red-100 flex items-center gap-2 text-sm">
                        <i data-lucide="inbox" class="w-4 h-4"></i>
                        <span>{{ peticiones.length }} Peticiones</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1920px] mx-auto px-6 py-6 space-y-8">
            
            <section v-if="focusMode && focusedItem" class="flex justify-center">
                <div class="w-full max-w-4xl">
                    <div v-if="focusType === 'pedido'" 
                         :class="['bg-white rounded-2xl shadow-2xl border-4 overflow-hidden flex flex-col relative transform scale-100 transition-all', 
                                  getEstado(focusedItem.uid).recibido ? 'border-green-500 bg-green-50/20' : 'border-orange-400 bg-orange-50/20']">
                          
                          <div class="p-6 border-b border-slate-200 bg-white flex justify-between items-start relative">
                             <div class="w-full text-center">
                                <h2 class="text-3xl font-bold text-slate-800">{{ focusedItem.user }}</h2>
                                <div class="text-slate-500 font-mono mt-1">{{ formatDate(focusedItem.fecha) }}</div>
                             </div>
                            <div class="text-right absolute right-6 top-6">
                                <div class="text-3xl font-bold text-slate-800">{{ formatMoney(calculateTotal(focusedItem)) }}</div>
                                <span class="text-sm font-mono text-slate-400">#{{ String(focusedItem.id).slice(-4) }}</span>
                            </div>
                            <div class="absolute left-6 top-6 flex flex-col items-center gap-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Devolución</span>
                                <button @click="toggleDevolucion(focusedItem.uid)" 
                                        :class="['p-2 rounded-full transition-all border shadow-sm', getEstado(focusedItem.uid).modoDevolucion ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-slate-50 text-slate-300 border-slate-200']"
                                        title="Modo Devolución: Si está activo, al borrar items se devuelve el stock">
                                    <i data-lucide="package-open" class="w-5 h-5"></i>
                                </button>
                            </div>
                          </div>

                          <div class="p-4 bg-white max-h-[50vh] overflow-y-auto custom-scroll">
                             <div v-for="(item, iIdx) in getItemsToShow(focusedItem)" :key="iIdx" class="flex justify-between items-center py-3 border-b border-dashed border-slate-200 last:border-0 text-lg px-2 group/focus">
                                <div class="flex-1 pr-4 flex items-center">
                                    <span class="font-bold bg-slate-100 border border-slate-200 px-3 py-1 rounded text-slate-900 mr-3">{{ item.cantidad }}</span>
                                    {{ item.nombre }}
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="font-bold text-slate-700">{{ formatMoney(item.subtotal) }}</div>
                                    <div v-if="!isOriginalView(focusedItem.uid)" class="flex gap-1 bg-slate-50 shadow-sm rounded border border-slate-200 p-1">
                                        <button @click="modItem(focusedItem.uid, iIdx, 1)" class="w-8 h-8 flex items-center justify-center bg-green-50 text-green-600 rounded hover:bg-green-100"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                        <button @click="modItem(focusedItem.uid, iIdx, -1)" class="w-8 h-8 flex items-center justify-center bg-orange-50 text-orange-600 rounded hover:bg-orange-100"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                        <button @click="delItem(focusedItem.uid, iIdx)" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="x" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                             </div>
                          </div>
                          
                          <div class="p-5 bg-slate-50 border-t border-slate-200 space-y-4">
                             <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button @click="guardarCloud(focusedItem)" class="bg-slate-800 text-white py-2 rounded-lg font-bold text-sm hover:bg-slate-900 flex items-center justify-center gap-2">
                                    <i data-lucide="cloud" class="w-4 h-4"></i> Guardar Cloud
                                </button>
                                <button @click="previewPDF(focusedItem)" class="bg-orange-500 text-white py-2 rounded-lg font-bold text-sm hover:bg-orange-600 flex items-center justify-center gap-2">
                                    <i data-lucide="file-search" class="w-4 h-4"></i> PDF +10%
                                </button>
                                <button @click="openAddModal(focusedItem.uid)" class="bg-white border border-blue-300 text-blue-600 hover:bg-blue-50 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                                    <i data-lucide="package-plus" class="w-4 h-4"></i> Añadir Prod
                                </button>
                                <button @click="toggleOriginal(focusedItem.uid)" :class="['py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 border transition', isOriginalView(focusedItem.uid) ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50']">
                                    <i data-lucide="history" class="w-4 h-4"></i> {{ isOriginalView(focusedItem.uid) ? 'Volver' : 'Ver Original' }}
                                </button>
                             </div>

                             <div class="grid grid-cols-2 gap-3">
                                 <button @click="actualizarPrecios(focusedItem.uid, false)" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 py-2 rounded-lg font-bold text-sm">
                                     $ Actualizar Precios (Hoy)
                                 </button>
                                 <button @click="actualizarPrecios(focusedItem.uid, true)" class="bg-white border border-teal-300 text-teal-600 hover:bg-teal-50 py-2 rounded-lg font-bold text-sm">
                                     $ Actualizar con -3% Desc
                                 </button>
                             </div>

                             <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center pt-2 border-t border-slate-200">
                                 <div class="flex-1 flex justify-between items-center bg-white px-4 py-2 rounded-xl border shadow-sm">
                                    <span class="font-bold uppercase text-sm">{{ getEstado(focusedItem.uid).recibido ? 'Preparado' : 'Armando' }}</span>
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" :id="'sw-f-'+focusedItem.uid" class="toggle-input"
                                               :checked="getEstado(focusedItem.uid).recibido"
                                               @change="toggleEstado(focusedItem.uid, $event.target.checked)">
                                        <label :for="'sw-f-'+focusedItem.uid" class="toggle-switch"></label>
                                    </div>
                                 </div>
                                 
                                 <button @click="guardarCambios(focusedItem.uid)" :disabled="isOriginalView(focusedItem.uid)" class="flex-[2] bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-md transition disabled:opacity-50 text-lg">
                                    Confirmar Cambios
                                 </button>

                                 <button @click="eliminarPedido(focusedItem)" class="bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 px-4 py-3 rounded-xl transition shadow-sm" title="Eliminar Pedido Completamente">
                                     <i data-lucide="trash-2" class="w-6 h-6"></i>
                                 </button>
                             </div>
                          </div>
                    </div>
                </div>
            </section>

            <div v-else>
                <section v-if="peticiones.length > 0 && !activeClient" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                    <div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex flex-wrap justify-between items-center gap-2">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <span class="bg-red-100 text-red-600 p-1.5 rounded-lg"><i data-lucide="bell" class="w-4 h-4"></i></span>
                            Solicitudes Nuevas
                        </h2>
                        <div class="flex gap-2">
                            <transition name="fade">
                                <div v-if="selectedPeticiones.length > 0" class="flex gap-2 flex-wrap">
                                    <button @click="copiarFaltantesPeticionesMasivo" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Copiar Faltantes
                                    </button>
                                    <button @click="procesarPeticionesMasivo(false)" :disabled="isMassProcessing" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i v-if="!isMassProcessing" data-lucide="check" class="w-3 h-3"></i> 
                                        <i v-else data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                                        {{ isMassProcessing ? 'Procesando...' : 'Aceptar' }}
                                    </button>
                                    <button @click="procesarPeticionesMasivo(true)" :disabled="isMassProcessing" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                                         <i v-if="!isMassProcessing" data-lucide="percent" class="w-3 h-3"></i> 
                                         <i v-else data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                                         {{ isMassProcessing ? '...' : 'Aceptar -3%' }}
                                    </button>
                                </div>
                            </transition>
                        </div>
                    </div>
                    
                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 bg-slate-50/50">
                        <div v-for="peticion in peticiones" :key="peticion.id" class="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow duration-200 flex flex-col group relative">
                            <button @click="enfocarItem(peticion, 'peticion')" class="absolute top-2 right-2 p-1.5 bg-white rounded-full shadow border border-slate-200 text-slate-400 hover:text-red-600 hover:border-red-300 z-10 transition" title="Enfocar Petición">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>

                            <div class="p-3 border-b border-slate-100 bg-white rounded-t-xl pr-10">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2 overflow-hidden w-full">
                                        <input type="checkbox" v-model="selectedPeticiones" :value="peticion.id" class="w-4 h-4 rounded border-slate-300 text-red-600 focus:ring-red-500 cursor-pointer flex-shrink-0">
                                        <div class="w-full text-center">
                                            <h3 class="font-bold text-slate-900 text-base truncate" :title="peticion.nombre">{{ peticion.nombre }}</h3>
                                            <div class="text-[10px] text-slate-500 mt-0.5 flex items-center justify-center gap-1">
                                                 <i data-lucide="clock" class="w-3 h-3"></i> {{ formatDate(peticion.fecha) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span v-if="peticion.telefono" class="text-slate-600 font-medium flex items-center gap-1">
                                         <i data-lucide="phone" class="w-3 h-3"></i> {{ peticion.telefono }}
                                    </span>
                                    <span class="font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">{{ formatMoney(peticion.total) }}</span>
                                </div>
                            </div>

                            <div class="p-2 flex-1 bg-white relative">
                                <div class="bg-slate-50 rounded-lg p-2 max-h-[150px] overflow-y-auto custom-scroll border border-slate-100 space-y-1">
                                    <div v-for="item in parseItems(peticion.items)" class="flex justify-between text-xs py-1 border-b border-slate-100 last:border-0 border-dashed">
                                        <span class="truncate pr-2 text-slate-700 flex-1">
                                            <span class="font-bold bg-white border border-slate-200 px-1 rounded text-slate-900 mr-1">{{ item.cantidad }}</span> 
                                            {{ item.nombre }}
                                            <span v-if="getStockWarning(item)" class="text-red-500 ml-1 font-bold" title="Sin stock">!</span>
                                        </span>
                                        <span class="text-slate-500 font-medium">{{ formatMoney(item.subtotal) }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2 bg-slate-50 border-t border-slate-100 rounded-b-xl grid grid-cols-2 gap-2">
                                <button @click="confirmarPeticion(peticion, false)" :disabled="processingPeticiones[peticion.id]" class="bg-white border border-green-200 text-green-700 hover:bg-green-50 py-1 rounded text-[10px] font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ processingPeticiones[peticion.id] ? '...' : 'Confirmar' }}
                                </button>
                                <button @click="confirmarPeticion(peticion, true)" :disabled="processingPeticiones[peticion.id]" class="bg-white border border-teal-200 text-teal-700 hover:bg-teal-50 py-1 rounded text-[10px] font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ processingPeticiones[peticion.id] ? '...' : '-3% Desc' }}
                                </button>
                                <button @click="copiarFaltantesIndividual(peticion)" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 py-1 rounded text-[10px] font-bold transition">Faltantes</button>
                                <button @click="eliminarPeticion(peticion.id)" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 py-1 rounded text-[10px] font-bold transition">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="flex items-center justify-between mb-4 px-2" v-if="!activeClient">
                        <h2 class="text-xl font-bold text-slate-800">Clientes Activos</h2>
                    </div>

                    <div v-else class="mb-4 flex items-center justify-between">
                        <button @click="toggleClient(null, null)" class="flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold transition bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> Volver
                        </button>
                        <h2 class="text-3xl font-bold text-slate-800 text-center flex-1">{{ activeClient }}</h2>
                        <div class="w-32"></div>
                    </div>

                    <div v-if="!activeClient">
                        
                        <div class="mb-2 flex items-center gap-2 px-2">
                             <div class="w-3 h-3 rounded-full bg-orange-400"></div>
                             <h3 class="text-md font-bold text-slate-600 uppercase tracking-wide">En Proceso / Armando</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 mb-8">
                            <div v-for="(orders, clientName) in splitClients.armando" :key="'armando-'+clientName" 
                                 class="bg-white rounded-xl shadow-sm border border-slate-200 transition-all duration-300 flex flex-col hover:shadow-md hover:border-orange-300">
                                
                                <div @click="toggleClient(clientName, 'armando')" 
                                     class="p-5 cursor-pointer flex justify-between items-center transition-colors select-none rounded-xl bg-white hover:bg-orange-50/30 border-l-4 border-l-transparent hover:border-l-orange-400">
                                    <div class="flex items-center gap-3 overflow-hidden w-full">
                                        <div class="truncate w-full text-center flex items-center justify-center gap-2">
                                            <i data-lucide="package" class="w-4 h-4 text-orange-400"></i>
                                            <h3 class="font-bold text-lg leading-tight truncate text-slate-800">{{ clientName }}</h3>
                                            <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">{{ orders.length }}</span>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                                </div>
                            </div>
                            
                            <div v-if="Object.keys(splitClients.armando).length === 0" class="col-span-full py-8 text-center text-slate-400 italic">
                                No hay pedidos en proceso de armado.
                            </div>
                        </div>

                        <div class="relative flex py-5 items-center mb-8">
                            <div class="flex-grow border-t-2 border-dashed border-slate-200"></div>
                            <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-bold uppercase tracking-widest bg-white px-2">
                                Estado de Pedidos
                            </span>
                            <div class="flex-grow border-t-2 border-dashed border-slate-200"></div>
                        </div>

                        <div class="mb-2 flex items-center gap-2 px-2">
                             <div class="w-3 h-3 rounded-full bg-green-500"></div>
                             <h3 class="text-md font-bold text-slate-600 uppercase tracking-wide">Finalizados / Entregados</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                            <div v-for="(orders, clientName) in splitClients.preparados" :key="'prep-'+clientName" 
                                 class="bg-white rounded-xl shadow-sm border border-slate-200 transition-all duration-300 flex flex-col hover:shadow-md hover:border-green-300">
                                
                                <div @click="toggleClient(clientName, 'preparados')" 
                                     class="p-5 cursor-pointer flex justify-between items-center transition-colors select-none rounded-xl bg-white hover:bg-green-50/30 border-l-4 border-l-transparent hover:border-l-green-400">
                                    <div class="flex items-center gap-3 overflow-hidden w-full">
                                        <div class="truncate w-full text-center flex items-center justify-center gap-2">
                                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>
                                            <h3 class="font-bold text-lg leading-tight truncate text-slate-800">{{ clientName }}</h3>
                                            <span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded-full">{{ orders.length }}</span>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                                </div>
                            </div>
                             <div v-if="Object.keys(splitClients.preparados).length === 0" class="col-span-full py-8 text-center text-slate-400 italic">
                                No hay pedidos finalizados aun.
                            </div>
                        </div>

                    </div>

                    <div v-else class="w-full">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            
                            <div v-for="(pedido, idx) in getClientOrders(activeClient)" :key="pedido.uid"
                                 :class="['bg-white rounded-xl shadow-sm border-2 transition-all duration-200 overflow-hidden flex flex-col relative', 
                                          getEstado(pedido.uid).recibido ? 'border-green-500 bg-green-50/20' : 'border-orange-400 bg-orange-50/20']">
                                    
                                    <div class="absolute top-2 right-2 z-10 flex gap-2">
                                        <button @click="toggleDevolucion(pedido.uid)" 
                                                :class="['p-1.5 rounded-full shadow border transition-all', getEstado(pedido.uid).modoDevolucion ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-white/80 text-slate-300 border-slate-200 hover:text-blue-400']" 
                                                title="Modo Devolución (Caja Abierta)">
                                            <i data-lucide="package-open" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="enfocarItem(pedido, 'pedido')" class="p-1.5 bg-white/80 backdrop-blur rounded-full shadow border border-slate-200 text-slate-400 hover:text-red-600 hover:border-red-300 transition" title="Enfocar Pedido">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                        </button>
                                    </div>

                                    <div class="p-3 border-b border-slate-100 flex justify-between items-start bg-white/90 backdrop-blur-sm pr-16">
                                        <div class="flex gap-2 w-full overflow-hidden">
                                            <input type="checkbox" v-model="selectedOrders" :value="pedido.uid" class="mt-1 w-4 h-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500 cursor-pointer shrink-0">
                                            <div class="flex-1 min-w-0 flex flex-col items-center">
                                                <div class="flex flex-wrap gap-1 mb-1 justify-center w-full">
                                                    <span v-if="pedido.nombre_negocio" class="text-sm font-bold uppercase tracking-wide text-orange-900 bg-orange-50 px-2 py-0.5 rounded truncate max-w-full border border-orange-100 shadow-sm block w-full text-center mb-1">{{ pedido.nombre_negocio }}</span>
                                                    <span v-if="pedido.user !== activeClient" class="text-[9px] font-bold uppercase tracking-wide text-teal-700 bg-teal-100 px-1.5 py-0.5 rounded truncate max-w-full">{{ pedido.user }}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-500 font-mono mb-0.5">{{ formatDate(pedido.fecha) }}</div>
                                                <div class="text-xl font-bold text-slate-800">{{ formatMoney(calculateTotal(pedido)) }}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="px-3 py-2 bg-white/50 border-b border-slate-100 flex justify-between items-center">
                                        <span :class="['text-[10px] font-bold uppercase', getEstado(pedido.uid).recibido ? 'text-green-700' : 'text-orange-600']">
                                            {{ getEstado(pedido.uid).recibido ? 'Preparado' : 'Armando' }}
                                        </span>
                                        <div class="flex items-center gap-2">
                                            <i v-if="estadosPedidos[pedido.uid]?.guardado" data-lucide="cloud" class="w-4 h-4 text-blue-500"></i>
                                            <div class="flex items-center">
                                                <input type="checkbox" :id="'sw-'+pedido.uid" class="toggle-input"
                                                       :checked="getEstado(pedido.uid).recibido"
                                                       @change="toggleEstado(pedido.uid, $event.target.checked)">
                                                <label :for="'sw-'+pedido.uid" class="toggle-switch scale-75 origin-right"></label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 flex-1 max-h-[220px] overflow-y-auto custom-scroll bg-white relative">
                                        <div v-if="loadingOrders[pedido.uid]" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                                            <div class="animate-spin text-orange-500"><i data-lucide="loader-2" class="w-6 h-6"></i></div>
                                        </div>
                                        <div v-for="(item, iIdx) in getItemsToShow(pedido)" :key="iIdx" class="flex justify-between items-center py-1.5 border-b border-dashed border-slate-100 last:border-0 hover:bg-slate-50 px-1 group/item text-xs">
                                            <div class="flex-1 pr-2 leading-snug">
                                                <div class="font-medium text-slate-700">
                                                    <span class="bg-slate-100 border border-slate-200 px-1 py-0.5 rounded font-bold text-slate-800 mr-1">{{ item.cantidad }}</span>
                                                    {{ item.nombre }}
                                                </div>
                                                <div class="text-[10px] text-slate-400 pl-1 mt-0.5">{{ formatMoney(item.precio_unitario) }} u.</div>
                                            </div>
                                            <div class="flex flex-col items-end gap-0.5 shrink-0">
                                                <span class="font-bold text-slate-700">{{ formatMoney(item.subtotal) }}</span>
                                                <div v-if="!isOriginalView(pedido.uid)" class="flex gap-1 opacity-0 group-hover/item:opacity-100 transition-opacity bg-white shadow-sm rounded border border-slate-100 p-0.5 origin-right">
                                                    <button @click="modItem(pedido.uid, iIdx, 1)" class="w-4 h-4 flex items-center justify-center bg-green-50 text-green-600 rounded hover:bg-green-100"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                                    <button @click="modItem(pedido.uid, iIdx, -1)" class="w-4 h-4 flex items-center justify-center bg-orange-50 text-orange-600 rounded hover:bg-orange-100"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                                    <button @click="delItem(pedido.uid, iIdx)" class="w-4 h-4 flex items-center justify-center bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 bg-slate-50 border-t border-slate-200 space-y-2">
                                        <div class="grid grid-cols-2 gap-1.5">
                                            <button @click="guardarCloud(pedido)" class="bg-slate-800 text-white py-1.5 rounded hover:bg-slate-900 transition text-[10px] font-bold flex items-center justify-center gap-1">
                                                <i data-lucide="cloud" class="w-3 h-3"></i> Guardar Cloud
                                            </button>
                                            <button @click="previewPDF(pedido)" class="bg-orange-500 text-white py-1.5 rounded hover:bg-orange-600 transition text-[10px] font-bold flex items-center justify-center gap-1">
                                                <i data-lucide="file-search" class="w-3 h-3"></i> PDF +10%
                                            </button>
                                            
                                            <button @click="openAddModal(pedido.uid)" class="bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 py-1.5 rounded text-[10px] font-bold transition">
                                                + Prod
                                            </button>
                                            <button @click="toggleOriginal(pedido.uid)" :class="['py-1.5 rounded text-[10px] font-bold transition border', isOriginalView(pedido.uid) ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50']">
                                                {{ isOriginalView(pedido.uid) ? 'Volver' : 'Original' }}
                                            </button>
                                            
                                            <button @click="actualizarPrecios(pedido.uid, false)" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 py-1.5 rounded text-[10px] font-bold transition">$ Act</button>
                                            <button @click="actualizarPrecios(pedido.uid, true)" class="bg-white border border-teal-300 text-teal-600 hover:bg-teal-50 py-1.5 rounded text-[10px] font-bold transition">$ -3%</button>
                                        </div>

                                        <div class="flex gap-1 pt-1">
                                            <button @click="guardarCambios(pedido.uid)" :disabled="isOriginalView(pedido.uid)" class="flex-1 bg-green-600 text-white py-1.5 rounded text-[10px] font-bold hover:bg-green-700 shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
                                                Confirmar
                                            </button>
                                            <button @click="eliminarPedido(pedido)" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 px-2 rounded transition" title="Eliminar Pedido">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>
                             </div>
                        </div>

                        <div v-if="shouldShowLoadMore(activeClient)" class="mt-6 flex justify-center">
                             <button @click="loadMore(activeClient)" class="py-3 px-8 bg-white border border-slate-200 text-slate-500 font-bold text-sm rounded-xl hover:bg-slate-50 hover:text-slate-700 transition shadow-sm flex items-center justify-center gap-2">
                                <i data-lucide="arrow-down-circle" class="w-5 h-5"></i> Cargar más...
                             </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        <transition name="fade">
            <div v-if="mensaje" 
                 style="position: fixed; top: 100px; right: 24px; z-index: 9999;"
                 :class="`px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 border-l-4 font-medium text-lg pointer-events-auto ${mensajeTipo === 'error' ? 'bg-white text-red-600 border-red-500' : 'bg-slate-800 text-white border-green-500'}`">
                <i :data-lucide="mensajeTipo === 'error' ? 'alert-circle' : 'check-circle'" class="w-6 h-6"></i>
                <span>{{ mensaje }}</span>
            </div>
        </transition>
        <transition name="fade">
            <div v-if="selectedOrders.length > 0" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700">
                <span class="font-bold text-orange-300 text-sm whitespace-nowrap">{{ selectedOrders.length }} seleccionados</span>
                <div class="h-6 w-px bg-slate-700"></div>
                <button @click="accionMasivaPedidos('cloud')" class="hover:text-green-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="cloud" class="w-4 h-4"></i> Guardar Cloud (PDF)
                </button>
                <button @click="accionMasivaPedidos('pdf')" class="hover:text-orange-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Ver PDF +10%
                </button>
                <button @click="accionMasivaPedidos('pdf-giant')" class="hover:text-purple-400 font-bold transition flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="file-plus" class="w-4 h-4"></i> PDF GIGANTE
                </button>
                <div class="h-6 w-px bg-slate-700"></div>
                <button @click="selectedOrders = []" class="hover:text-red-400 hover:bg-slate-800 p-1 rounded-full transition" title="Cancelar selección">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </transition>

        <div v-if="modalOpen" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" @click.self="modalOpen = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-5 transform transition-all scale-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="package-plus" class="w-5 h-5 text-blue-600"></i> Añadir
                    </h3>
                    <button @click="modalOpen = false" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1 rounded transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IDs x Cantidad</label>
                        <input v-model="modalInput" type="text" ref="modalInputRef" class="w-full border-2 border-slate-200 rounded-lg p-2 text-base font-mono focus:border-blue-500 outline-none transition-all placeholder:text-slate-300" placeholder="Ej: 353x5, 102x1" @keyup.enter="addProducts">
                    </div>
                    <label class="flex items-center gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition select-none">
                        <input type="checkbox" v-model="modalApplyDiscount" class="w-4 h-4 rounded border-slate-300 text-green-600 focus:ring-green-500">
                        <span class="text-sm font-bold text-slate-700">Aplicar -3% descuento</span>
                    </label>
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button @click="modalOpen = false" class="px-4 py-2 font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition text-sm">Cancelar</button>
                    <button @click="addProducts" class="px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md transition text-sm">Añadir</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, nextTick } = Vue;
        const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        // Check Login
        if (localStorage.getItem('loggedUser') !== 'admin') window.location.href = 'index.html';
        createApp({
            data() {
                return {
                    // Datos
                    rawPedidos: [],
                    peticiones: [],
                    productos: [],
                    savingChanges: {},
                    
                    // Estado Local
                    estadosPedidos: JSON.parse(localStorage.getItem('estadosPedidos') || '{}'),
                    
                    // originalCache: Solo para VISUAL (Histórico, "Lo viejo")
                    originalCache: JSON.parse(localStorage.getItem('originalPedidosCache') || '{}'),
                    
                    // stockReference: Solo para MATEMÁTICA (Lo último guardado en DB)
                    stockReference: {}, 

                    usedButtons: JSON.parse(localStorage.getItem('usedButtons') || '{}'),
                    
                    // UI State
                    search: '',
                    activeClient: null,
                    activeSection: null, // NUEVO: 'armando' o 'preparado'
                    loadedCounts: {},
                    selectedOrders: [],
                    selectedPeticiones: [],
                    
                    // Focus Mode State
                    focusMode: false,
                    focusedItem: null,
                    focusType: null, // 'pedido' o 'peticion'
                    
                    // Modals
                    mensaje: '',
                    mensajeTipo: 'info',
                    loadingOrders: {},
                    modalOpen: false,
                    modalPedidoId: null,
                    modalInput: '',
                    modalApplyDiscount: false,

                    // NUEVOS ESTADOS PARA BLOQUEO
                    processingPeticiones: {},
                    isMassProcessing: false
                }
            },
            computed: {
                // NUEVA LÓGICA DE DIVISIÓN
                splitClients() {
                    const armando = {};
                    const preparados = {};
                    
                    // Primero ordenamos los pedidos por fecha
                    const sortedPedidos = [...this.rawPedidos].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

                    sortedPedidos.forEach(p => {
                        const name = p.user || 'Invitado';
                        // Filtrado por búsqueda global
                        if (this.search) {
                            const q = this.search.toLowerCase();
                            const match = name.toLowerCase().includes(q) || 
                                          String(p.id).includes(q) || 
                                          p.items.some(i => i.nombre.toLowerCase().includes(q));
                            if (!match) return;
                        }

                        // Obtenemos el estado (mezclando DB y LocalStorage)
                        const st = this.getEstado(p.uid);
                        
                        if (st.recibido || name.toLowerCase() === 'cliente') {
                            if (!preparados[name]) preparados[name] = [];
                            preparados[name].push(p);
                        } else {
                            if (!armando[name]) armando[name] = [];
                            armando[name].push(p);
                        }
                    });

                    return { armando, preparados };
                },
                // Mantenemos filteredClients solo por si acaso, pero ya no se usa en el template principal
                filteredClients() {
                     // Legacy helper
                     return {}; 
                }
            },
            updated() {
                this.$nextTick(() => lucide.createIcons());
            },
            methods: {
                // UTILS
                formatMoney(val) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val || 0); },
                formatDate(iso) { 
                    if (!iso) return '';
                    const d = new Date(iso);
                    return d.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
                },
                showMsg(msg, type='info') {
                    this.mensaje = msg;
                    this.mensajeTipo = type;
                    setTimeout(() => this.mensaje = '', 3000);
                },
                saveStorage() {
                    localStorage.setItem('estadosPedidos', JSON.stringify(this.estadosPedidos));
                    localStorage.setItem('usedButtons', JSON.stringify(this.usedButtons));
                    localStorage.setItem('originalPedidosCache', JSON.stringify(this.originalCache));
                },
                
                // DATA
                async loadAll() {
                    try {
                        const [resProd, resPed, resPet] = await Promise.all([
                            fetch(`${apiBase}/productos`), fetch(`${apiBase}/pedidos`), fetch(`${apiBase}/peticiones`)
                        ]);
                        this.productos = await resProd.json();
                        this.rawPedidos = await resPed.json();
                        this.peticiones = await resPet.json();
                        const parser = (list) => list.forEach(p => { 
                             if(typeof p.items === 'string') { try { p.items = JSON.parse(p.items); } catch { p.items = []; } }
                        });
                        parser(this.rawPedidos); parser(this.peticiones);

                        this.rawPedidos.forEach((p, index) => {
                            p.uid = p.id ? String(p.id) : `${p.user}-${index}`;
                            if (!this.originalCache[p.uid]) {
                                this.originalCache[p.uid] = JSON.parse(JSON.stringify(p.items));
                            }
                            this.stockReference[p.uid] = JSON.parse(JSON.stringify(p.items));
                        });
                        this.saveStorage(); 
                        nextTick(() => lucide.createIcons());
                    } catch (e) { console.error(e); }
                },

                // UI LOGIC (MODIFICADO)
                toggleClient(name, section) {
                    // Si hacemos click en el mismo cliente y misma sección, cerramos.
                    if (this.activeClient === name && this.activeSection === section) {
                         this.activeClient = null;
                         this.activeSection = null;
                    } else {
                        // Abrimos
                        this.activeClient = name;
                        this.activeSection = section;
                        if (name) this.loadedCounts[name] = 12;
                    }
                    nextTick(() => lucide.createIcons());
                },
                // NUEVO HELPER PARA OBTENER PEDIDOS DE LA SECCION ACTIVA
                getClientOrders(clientName) {
                    if (!this.activeSection || !clientName) return [];
                    const fullList = this.splitClients[this.activeSection][clientName] || [];
                    return fullList.slice(0, this.loadedCounts[clientName] || 12);
                },
                shouldShowLoadMore(name) { 
                    if (!name || !this.activeSection) return false;
                    const fullList = this.splitClients[this.activeSection][name] || [];
                    return fullList.length > (this.loadedCounts[name] || 12); 
                },
                loadMore(name) { this.loadedCounts[name] = (this.loadedCounts[name] || 12) + 12; },
                
                // FOCUS LOGIC
                enfocarItem(item, type) {
                    this.focusedItem = item;
                    this.focusType = type;
                    this.focusMode = true;
                    window.scrollTo({top: 0, behavior: 'smooth'});
                },
                clearFocus() {
                    this.focusMode = false;
                    this.focusedItem = null;
                    this.focusType = null;
                    nextTick(() => lucide.createIcons());
                },

                // ESTADOS
                getEstado(uid) {
                    if (!this.estadosPedidos[uid]) {
                         this.estadosPedidos[uid] = { guardado: false, modoDevolucion: false };
                    }
                    const localState = this.estadosPedidos[uid];
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    // Regla: si estado es 'Preparado' O es NULL -> se considera recibido/preparado
                    const isPreparado = pedido ? (pedido.estado === 'Preparado' || pedido.estado === null) : false;
                    return {
                        ...localState,
                        recibido: isPreparado 
                    };
                },
                async toggleEstado(uid, val) {
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    if (!pedido) return;

                    const nuevoEstadoStr = val ? 'Preparado' : 'Armando';
                    // Optimistic update
                    pedido.estado = nuevoEstadoStr;
                    // Forzar reactividad reasignando el array (Vue 3 a veces necesita empujoncito en deep arrays)
                    // this.rawPedidos = [...this.rawPedidos]; 

                    try {
                        await fetch(`${apiBase}/actualizar-estado-pedido/${pedido.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ estado: nuevoEstadoStr })
                        });
                        
                        // Si cambiamos el estado, el pedido va a "saltar" de lista (de Armando a Preparado o viceversa)
                        // Si estamos dentro de la vista de un cliente, podría desaparecer de la vista actual.
                        // Opcional: Cerrar vista si se queda sin pedidos en esa sección.
                    } catch (e) {
                        console.error(e);
                        this.showMsg('Error al cambiar estado', 'error');
                        pedido.estado = val ? 'Armando' : 'Preparado';
                    }
                },
                toggleDevolucion(uid) {
                    if (!this.estadosPedidos[uid]) {
                        this.estadosPedidos[uid] = { guardado: false, modoDevolucion: false };
                    }
                    this.estadosPedidos[uid].modoDevolucion = !this.estadosPedidos[uid].modoDevolucion;
                    this.saveStorage();
                },

                // ORIGINAL
                isOriginalView(uid) { return this.estadosPedidos[uid]?.viewOriginal || false; },
                toggleOriginal(uid) {
                    if (!this.estadosPedidos[uid]) this.getEstado(uid); 
                    this.estadosPedidos[uid].viewOriginal = !this.estadosPedidos[uid].viewOriginal;
                    if (this.estadosPedidos[uid].viewOriginal && !this.originalCache[uid]) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) { this.originalCache[uid] = JSON.parse(JSON.stringify(p.items)); this.saveStorage(); }
                    }
                },
                getItemsToShow(pedido) {
                    return (this.isOriginalView(pedido.uid) && this.originalCache[pedido.uid]) ? this.originalCache[pedido.uid] : pedido.items;
                },
                calculateTotal(pedido) {
                    return this.getItemsToShow(pedido).reduce((acc, item) => acc + (Number(item.subtotal)||0), 0);
                },

                // ACCIONES
                async guardarCloud(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        const res = await fetch(`${apiBase}/pedidos/${pedido.id}/pdf`);
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                        this.getEstado(pedido.uid).guardado = true; this.saveStorage();
                    } catch(e) { this.showMsg('Error PDF', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                async previewPDF(pedido) { 
                    this.loadingOrders[pedido.uid] = true;
                    try {
                        const itemsModified = pedido.items.map(i => ({
                            ...i, precio_unitario: i.precio_unitario * 1.10 * 1.02, subtotal: i.subtotal * 1.10 * 1.02
                        }));
                        const payload = {
                            user: pedido.user, items: itemsModified,
                            total: itemsModified.reduce((a,b)=>a+b.subtotal,0),
                            fecha: new Date().toISOString(), nombre_negocio: pedido.nombre_negocio
                        };
                        const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if(data.pdf) window.open(data.pdf, '_blank');
                    } catch(e) { this.showMsg('Error Generando', 'error'); } 
                    finally { this.loadingOrders[pedido.uid] = false; }
                },
                
                async guardarCambios(uid) {
                    if(!confirm('¿Guardar cambios permanentemente?')) return;
                    
                    if (this.savingChanges[uid]) return; 
                    this.savingChanges[uid] = true; 
                
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const estado = this.getEstado(uid);
                
                    if(!this.originalCache[uid]) this.originalCache[uid] = JSON.parse(JSON.stringify(pedido.items));
                
                    const deltaMap = new Map();
                    
                    const oldItems = this.stockReference[uid]; 
                    const newItems = pedido.items;
                    
                    oldItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) - Number(i.cantidad)));
                    newItems.forEach(i => deltaMap.set(i.id, (deltaMap.get(i.id)||0) + Number(i.cantidad))); 
                    
                    const stockUpdates = [];
                    for(const [id, delta] of deltaMap.entries()) {
                            if(delta > 0) {
                                stockUpdates.push({id, cantidad: delta});
                            } else if (delta < 0 && estado.modoDevolucion) {
                                stockUpdates.push({id, cantidad: delta});
                            }
                    }
                
                    try {
                        await fetch(`${apiBase}/actualizar-pedido/${pedido.id}`, {
                            method: 'PUT', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ items: newItems, stockUpdates })
                        });
                
                        this.stockReference[uid] = JSON.parse(JSON.stringify(newItems));        
                        this.saveStorage(); 
                        this.showMsg('Guardado OK', 'success');
                
                    } catch(e) { 
                        this.showMsg('Error guardando', 'error'); 
                    } finally {
                        this.savingChanges[uid] = false;
                    }
                },
                async eliminarPedido(pedido) {
                    const estado = this.getEstado(pedido.uid);
                    const msg = estado.recibido 
                        ? 'PREPARADO (VERDE). NO SE DEVOLVERÁ STOCK.' 
                        : 'ARMANDO (NARANJA). SE DEVOLVERÁ EL STOCK.';
                    
                    if(!confirm(`¿Eliminar pedido?\n\n${msg}`)) return;
                    await fetch(`${apiBase}/eliminar-pedido/${pedido.id}`, {
                        method: 'DELETE', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ recibido: estado.recibido })
                    });
                    this.rawPedidos = this.rawPedidos.filter(p => p.uid !== pedido.uid);
                    // Si se elimina el último pedido, cerramos vista
                    if(this.splitClients[this.activeSection]?.[pedido.user]?.length === 0) {
                        this.activeClient = null;
                        this.activeSection = null;
                    }
                    if(this.focusMode) this.clearFocus();
                },

                // EDICION
                modItem(uid, idx, chg) {
                    const item = this.rawPedidos.find(p => p.uid === uid).items[idx];
                    const oldQty = item.cantidad;
                    const newQty = Math.max(1, Number(oldQty) + chg);
                    
                    if (oldQty !== newQty) {
                        item.cantidad = newQty;
                        item.subtotal = item.cantidad * item.precio_unitario;
                        const signo = chg > 0 ? '+' : '';
                        this.showMsg(`${signo}${chg} ${item.nombre}`, 'success');
                    }
                },
                delItem(uid, idx) {
                    if(!confirm('¿Borrar item?')) return;
                    const item = this.rawPedidos.find(p => p.uid === uid).items[idx];
                    this.showMsg(`Eliminado: ${item.nombre}`, 'error');
                    this.rawPedidos.find(p => p.uid === uid).items.splice(idx, 1);
                },
                async actualizarPrecios(uid, discount) {
                    if(this.isOriginalView(uid)) return alert('Sal de original');
                    if(!confirm('¿Actualizar precios?')) return;
                    
                    const pedido = this.rawPedidos.find(p => p.uid === uid);
                    const precioMap = new Map(this.productos.map(p => [p.id, p.precio]));
                    const mult = discount ? 1.122 * 0.97 : 1.122;
                    pedido.items.forEach(i => {
                        const base = precioMap.get(i.id);
                        if(base) {
                            i.precio_unitario = Number((base * mult).toFixed(2));
                            i.subtotal = i.cantidad * i.precio_unitario;
                        }
                    });
                    this.showMsg('Precios Actualizados', 'success');
                },

                openAddModal(uid) { this.modalPedidoId = uid; this.modalInput = ''; this.modalOpen = true; nextTick(()=>this.$refs.modalInputRef.focus()); },
                addProducts() {
                    const pedido = this.rawPedidos.find(p => p.uid === this.modalPedidoId);
                    const parts = this.modalInput.split(',').map(s=>s.trim());
                    let addedCount = 0;
                    
                    parts.forEach(part => {
                        const [idStr, qtyStr] = part.split('x');
                        const p = this.productos.find(pr => pr.id == idStr);
                        if(p) {
                            addedCount++;
                            let precio = p.precio * 1.10 * 1.02;
                            if(this.modalApplyDiscount) precio *= 0.97;
                            const qty = parseInt(qtyStr)||1;
                            const exist = pedido.items.find(i => i.id == p.id);
                            if(exist) {
                                exist.cantidad += qty; exist.precio_unitario = precio; exist.subtotal = exist.cantidad * precio;
                            } else {
                                pedido.items.push({ id: p.id, nombre: p.nombre, cantidad: qty, precio_unitario: precio, subtotal: qty*precio });
                            }
                        }
                    });
                    if(addedCount > 0) this.showMsg(`Se añadieron ${addedCount} productos`, 'success');
                    this.modalOpen = false;
                },

                // PETICIONES
                parseItems(items) { return Array.isArray(items) ? items : JSON.parse(items || '[]'); },
                getStockWarning(item) { const p = this.productos.find(pr => pr.id === item.id); return p && item.cantidad > (p.stock||0); },
                
                async confirmarPeticion(peticion, discount) {
                    if (this.processingPeticiones[peticion.id]) return;
                    this.processingPeticiones[peticion.id] = true;

                    try {
                        const items = this.parseItems(peticion.items).map(i => ({
                            id: i.id, cantidad: i.cantidad, precio: discount ? i.precio_unitario * 0.97 : i.precio_unitario
                        }));
                        await fetch(`${apiBase}/guardar-pedidos`, {
                            method: 'POST', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ user: peticion.nombre, pedido: items, user_id: peticion.user_id, nombre_negocio: peticion.nombre_negocio })
                        });
                        await fetch(`${apiBase}/peticiones/${peticion.id}`, { method: 'DELETE' });
                        this.peticiones = this.peticiones.filter(p => p.id !== peticion.id);
                        this.usedButtons[peticion.id] = discount ? 'plus7' : 'normal';
                        this.saveStorage();
                        this.loadAll(); 
                        if(this.focusMode) this.clearFocus();
                    } catch (e) {
                        console.error(e);
                        this.showMsg('Error al confirmar petición', 'error');
                    } finally {
                        this.processingPeticiones[peticion.id] = false;
                    }
                },
                async eliminarPeticion(id) { if(confirm('¿Borrar?')) { await fetch(`${apiBase}/peticiones/${id}`, { method:'DELETE' }); this.peticiones=this.peticiones.filter(p=>p.id!==id); if(this.focusMode) this.clearFocus(); } },
                previewPDFPeticion(p) { this.previewPDF({ user:p.nombre, items:this.parseItems(p.items), fecha:p.fecha, nombre_negocio:p.nombre_negocio }); },
                
                async copiarFaltantesIndividual(p) {
                    this.showMsg('Verificando stock actualizado...', 'info');
                    try {
                        const res = await fetch(`${apiBase}/productos`);
                        this.productos = await res.json();
                    } catch(e) { console.error(e); }

                    const items = this.parseItems(p.items);
                    let txt = "";
                    items.forEach(i => {
                        const pr = this.productos.find(x => x.id === i.id);
                        const stockReal = pr ? Math.max(0, Number(pr.stock)) : 0;
                        const falt = Math.max(0, i.cantidad - stockReal);
                        if(falt > 0) txt += `${falt} ${i.nombre}\n`;
                    });
                    navigator.clipboard.writeText(txt || "Hay stock de todo");
                    this.showMsg('Faltantes copiados (Stock actualizado)', 'success');
                },
                
                async copiarFaltantesPeticionesMasivo() {
                    const selected = this.peticiones.filter(p => this.selectedPeticiones.includes(p.id));
                    if(selected.length === 0) return alert('Selecciona peticiones');
                    
                    this.showMsg('Verificando stock actualizado...', 'info');
                    try {
                        const res = await fetch(`${apiBase}/productos`);
                        this.productos = await res.json();
                    } catch(e) { console.error(e); }

                    const agg = {};
                    selected.forEach(p => {
                        this.parseItems(p.items).forEach(i => {
                            if(!agg[i.id]) agg[i.id] = { nombre: i.nombre, cantidad: 0 };
                            agg[i.id].cantidad += Number(i.cantidad);
                        });
                    });
                    let txt = "";
                    for(const id in agg) {
                        const pr = this.productos.find(x => x.id == id);
                        const stockReal = pr ? Math.max(0, Number(pr.stock)) : 0;
                        const falt = Math.max(0, agg[id].cantidad - stockReal);
                        if(falt > 0) txt += `${falt} ${agg[id].nombre}\n`;
                    }
                    navigator.clipboard.writeText(txt || "Hay stock de todo");
                    this.showMsg('Faltantes Masivos Copiados', 'success');
                },

                // MASIVO
                async accionMasivaPedidos(mode) {
                    if(!this.selectedOrders.length) return;
                    const pedidos = this.selectedOrders.map(uid => this.rawPedidos.find(p => p.uid === uid)).filter(Boolean);
                    if (mode === 'pdf-giant') {
                        if(!confirm(`¿Generar UN SOLO PDF con ${pedidos.length} pedidos concatenados?`)) return;
                        
                        const pdfWindow = window.open('', '_blank');
                        
                        if (pdfWindow) {
                            pdfWindow.document.write(`
                                <div style="font-family:sans-serif;text-align:center;margin-top:20%;">
                                    <h1>⏳ Generando PDF...</h1>
                                    <p>Por favor espera, estamos procesando ${pedidos.length} pedidos.</p>
                                </div>
                            `);
                        } else {
                            alert("⚠️ Habilita las ventanas emergentes para ver el PDF.");
                            return;
                        }
                    
                        try {
                            const itemsForGiant = pedidos.map(p => ({
                                user: p.user, 
                                items: p.items,
                                total: p.items.reduce((a,b)=>a+(Number(b.subtotal)||0),0),
                                fecha: p.fecha || new Date().toISOString(), 
                                nombre_negocio: p.nombre_negocio,
                                id: p.id
                            }));
                    
                            const res = await fetch(`${apiBase}/generar-pdf-masivo`, {
                                method: 'POST', 
                                headers: {'Content-Type': 'application/json'}, 
                                body: JSON.stringify({ pedidos: itemsForGiant })
                            });
                    
                            if (!res.ok) throw new Error("Error generando PDF en servidor");
                    
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            
                            if (pdfWindow) {
                                pdfWindow.location.href = url; 
                            }
                    
                        } catch (e) {
                            console.error(e);
                            this.showMsg('Error: ' + e.message, 'error');
                            if (pdfWindow) pdfWindow.close(); 
                        }
                        
                        this.selectedOrders = [];
                        return;
                    }

                    if(!confirm(`¿Procesar ${this.selectedOrders.length} pedidos?`)) return;
                    for(const uid of this.selectedOrders) {
                        const p = this.rawPedidos.find(x => x.uid === uid);
                        if(p) {
                            if(mode==='cloud') await this.guardarCloud(p);
                            else if(mode==='pdf') await this.previewPDF(p);
                            await new Promise(r=>setTimeout(r,500));
                        }
                    }
                    this.selectedOrders = [];
                },
                async procesarPeticionesMasivo(discount) {
                    if (this.selectedPeticiones.length === 0) return;
                    this.isMassProcessing = true;
                    try {
                        for(const pid of this.selectedPeticiones) {
                            const p = this.peticiones.find(x => x.id === pid);
                            if(p) await this.confirmarPeticion(p, discount);
                        }
                        this.selectedPeticiones = [];
                    } finally {
                        this.isMassProcessing = false;
                    }
                }
            },
            mounted() { this.loadAll(); }
        }).mount('#app');
    </script>
</body>
</html>



