<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Producto | Distribuidora Funaz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:0;background:#f6f7fb;color:#222}
    header{background:#4a90e2;color:#fff;padding:18px;text-align:center;font-weight:700}
    main{max-width:980px;margin:20px auto;padding:16px}
    .volver{display:inline-block;margin-bottom:16px;background:#4a90e2;color:#fff;text-decoration:none;padding:10px 14px;border-radius:8px;font-weight:600}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,.08);padding:18px;display:grid;grid-template-columns:320px 1fr;gap:20px}
    .card img{width:100%;height:auto;border-radius:10px;background:#eee;object-fit:contain}
    .title{font-size:1.6rem;margin:0 0 8px}
    .price{font-size:1.4rem;font-weight:700;margin:0 0 8px}
    .meta{color:#555;margin:6px 0}
    .stock{margin:10px 0;font-weight:600}
    .notfound{background:#fff3f3;border:1px solid #ffc9c9;color:#a33;padding:14px;border-radius:10px}
    .hidden{display:none}
    .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    button{background:#4a90e2;border:none;color:#fff;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>Detalle de producto</header>
  <main>
    <a class="volver" href="index.html">← Volver a la tienda</a>

    <div id="error" class="notfound hidden"></div>

    <section id="prodCard" class="card hidden">
      <img id="prodImg" alt="Imagen del producto" />
      <div>
        <h1 id="prodNombre" class="title"></h1>
        <p id="prodPrecio" class="price"></p>
        <p id="prodCat" class="meta"></p>
        <p id="prodStock" class="stock"></p>
        <div class="actions">
          <button id="btnAgregar">Agregar al carrito</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // =============== Utils de red ===============
    async function tryFetchSequential(paths, opts) {
      for (const p of paths) {
        try {
          const r = await fetch(p, opts);
          if (r && r.ok) return r;
        } catch (e) {
          // pasa al siguiente
        }
      }
      return null;
    }
    function apiPaths(suffix){ return [`..${suffix}`, `${suffix}`]; } // desde /public/ hacia raíz y absoluta

    // =============== Lógica de página ===============
    const q = new URLSearchParams(location.search);
    const id = Number(q.get('id'));

    const $ = sel => document.querySelector(sel);
    const elCard   = $('#prodCard');
    const elError  = $('#error');
    const elImg    = $('#prodImg');
    const elNom    = $('#prodNombre');
    const elPrecio = $('#prodPrecio');
    const elCat    = $('#prodCat');
    const elStock  = $('#prodStock');
    const btnAdd   = $('#btnAgregar');

    if (!Number.isFinite(id)) {
      showError('ID de producto inválido.');
    } else {
      cargarProducto(id);
    }

    function showError(msg){
      elError.textContent = msg;
      elError.classList.remove('hidden');
      elCard.classList.add('hidden');
    }

    async function cargarProducto(pid){
      // 1) intentar API por ID
      let res = await tryFetchSequential(apiPaths(`/api/productos/${encodeURIComponent(pid)}`), {cache:'no-store'});
      if (res) {
        const p = await res.json();
        if (p && (p.id==pid || p.id===String(pid))) return renderProducto(p);
      }

      // 2) API listado completo y buscar
      res = await tryFetchSequential(apiPaths('/api/productos'), {cache:'no-store'});
      if (res) {
        const lista = await res.json();
        const p = (lista || []).find(x => Number(x.id) === Number(pid));
        if (p) return renderProducto(p);
      }

      // 3) Fallback a JSON estático en raíz (repo/public puede estar en subcarpeta)
      res = await tryFetchSequential(['../productos.json','/productos.json','productos.json'], {cache:'no-store'});
      if (res) {
        const lista = await res.json();
        const p = (lista || []).find(x => Number(x.id) === Number(pid));
        if (p) return renderProducto(p);
      }

      showError('Producto no encontrado o no disponible.');
    }

    function renderProducto(p){
      // nombre, precio, categoria, stock
      elNom.textContent = p.nombre || `Producto #${p.id}`;
      elPrecio.textContent = (typeof p.precio === 'number')
        ? `$${p.precio.toFixed(2)}`
        : (p.precio ? `$${Number(p.precio).toFixed(2)}` : '—');

      elCat.textContent = p.categoria ? `Categoría: ${p.categoria}` : 'Categoría: —';
      const stockNum = Number(p.stock || 0);
      elStock.textContent = `Stock: ${stockNum}`;
      btnAdd.disabled = stockNum <= 0;

      // imagen: intentos relativos y absolutos
      // si tus imágenes están en /public/imagenes/ID.jpg, la ruta relativa simple funciona desde /public/producto.html
      const candidates = [
        `imagenes/${p.id}.jpg`,        // /public/imagenes (cuando estás dentro de /public)
        `/imagenes/${p.id}.jpg`,       // raíz /imagenes
        `../imagenes/${p.id}.jpg`      // subir un nivel por si el deploy expone raíz con subcarpeta
      ];
      setImageWithFallback(elImg, candidates);

      // carrito local (simple)
      btnAdd.onclick = () => {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const idx = cart.findIndex(i => Number(i.id) === Number(p.id));
        if (idx === -1) {
          cart.push({ id: p.id, nombre: p.nombre, precio: Number(p.precio)||0, cantidad: 1 });
        } else {
          cart[idx].cantidad = Number(cart[idx].cantidad || 0) + 1;
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        alert('Producto agregado al carrito.');
      };

      elCard.classList.remove('hidden');
      elError.classList.add('hidden');
    }

    function setImageWithFallback(imgEl, urls){
      let i = 0;
      function tryNext(){
        if (i >= urls.length) {
          imgEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">
              <rect width="100%" height="100%" fill="#eee"/>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#888" font-size="20">Sin imagen</text>
            </svg>`
          );
          return;
        }
        const url = urls[i++];
        const test = new Image();
        test.onload = () => { imgEl.src = url; };
        test.onerror = tryNext;
        test.src = url;
      }
      tryNext();
    }
  </script>
</body>
</html>
