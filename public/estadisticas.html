<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funaz Manager - Intelligence</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --sidebar-bg: #1e1e2d;
      --sidebar-text: #9899ac;
      --sidebar-active: #3699ff;
      --bg-body: #f5f8fa;
      --card-bg: #ffffff;
      --text-main: #3f4254;
      --border: #ebedf3;
      --success: #1bc5bd;
    }

    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      display: flex; flex-direction: column;
      flex-shrink: 0;
    }

    .brand {
      height: 70px; display: flex; align-items: center; padding: 0 25px;
      color: white; font-weight: 700; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .nav-menu { padding: 20px 0; list-style: none; margin: 0; flex: 1; }
    .nav-item {
      padding: 12px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px;
      color: var(--sidebar-text); transition: 0.2s; font-weight: 500;
    }
    .nav-item:hover { color: white; background: rgba(255,255,255,0.02); }
    .nav-item.active { background: rgba(54, 153, 255, 0.1); color: var(--sidebar-active); border-right: 3px solid var(--sidebar-active); }

    /* Global Date Filter in Sidebar */
    .global-filter { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); }
    .filter-label { font-size: 0.75rem; text-transform: uppercase; color: #5d5f77; font-weight: 700; margin-bottom: 8px; display: block; }
    .date-select {
      width: 100%; background: #151521; border: 1px solid #2b2b40; color: white;
      padding: 8px; border-radius: 6px; margin-bottom: 10px; outline: none;
    }

    /* --- MAIN CONTENT --- */
    .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
    
    .section-view { display: none; animation: fadeIn 0.3s ease; }
    .section-view.active { display: block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

    h1 { margin: 0 0 25px 0; font-size: 1.5rem; }

    /* --- CARDS & GRIDS --- */
    .card { background: var(--card-bg); border-radius: 10px; box-shadow: 0 0 20px 0 rgba(76, 87, 125, 0.02); padding: 25px; margin-bottom: 25px; }
    .row-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }
    .kpi-title { font-size: 0.9rem; color: #b5b5c3; font-weight: 600; }

    .chart-container { position: relative; height: 350px; width: 100%; }

    /* --- CLIENT FILTER UI --- */
    .client-control-panel { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 500px; }
    .client-list-box { border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
    .search-bar { padding: 10px; border-bottom: 1px solid var(--border); }
    .search-bar input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
    
    .list-scroll { flex: 1; overflow-y: auto; padding: 5px; }
    .client-row { display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px; gap: 8px; font-size: 0.9rem; }
    .client-row:hover { background: #f0f0f0; }

    .mode-switch { display: flex; gap: 10px; margin-bottom: 15px; }
    .btn-mode { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; text-align: center; font-weight: 600; }
    .btn-mode.active.include { background: #d7f9f1; color: #00684a; border-color: #d7f9f1; }
    .btn-mode.active.exclude { background: #ffe2e5; color: #890c18; border-color: #ffe2e5; }

    /* --- HEATMAP --- */
    .heatmap-grid { display: grid; grid-template-columns: 40px repeat(24, 1fr); gap: 2px; overflow-x: auto; }
    .hm-cell { height: 35px; border-radius: 4px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; color: transparent; transition: 0.2s; }
    .hm-cell:hover { color: white; transform: scale(1.1); z-index: 10; cursor: default; }
    .hm-day { display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-weight: 600; font-size: 0.8rem; color: #b5b5c3; }

    /* --- LOADER --- */
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

<div id="loader">
  <div style="width: 40px; height: 40px; border: 4px solid #ebedf3; border-top-color: var(--sidebar-active); border-radius: 50%; animation: spin 1s linear infinite;"></div>
  <p style="margin-top: 15px; font-weight: 600; color: var(--text-main);">Cargando Sistema...</p>
</div>

<div class="sidebar">
  <div class="brand">FUNAZ BI</div>
  
  <ul class="nav-menu">
    <li class="nav-item active" onclick="switchTab('tab-resumen', this)">
      <span class="material-icons-round">dashboard</span> Resumen
    </li>
    <li class="nav-item" onclick="switchTab('tab-clientes', this)">
      <span class="material-icons-round">people</span> Clientes & Filtros
    </li>
    <li class="nav-item" onclick="switchTab('tab-estacional', this)">
      <span class="material-icons-round">calendar_month</span> Estacionalidad
    </li>
    <li class="nav-item" onclick="switchTab('tab-heatmap', this)">
      <span class="material-icons-round">local_fire_department</span> Horarios
    </li>
  </ul>

  <div class="global-filter">
    <span class="filter-label">Filtro Global de Tiempo</span>
    <select id="filterMonth" class="date-select" onchange="updateDashboard()">
      </select>
    <select id="filterYear" class="date-select" onchange="updateDashboard()">
      </select>
    <small style="color: #5d5f77; display:block; margin-top:5px;">
      *Nota: "Estacionalidad" ignora el mes.
    </small>
  </div>
  
  <div style="padding: 20px;">
    <button onclick="location.href='admin.txt'" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); border:none; color:white; cursor:pointer; border-radius:6px;">Volver Admin</button>
  </div>
</div>

<div class="main">

  <div id="tab-resumen" class="section-view active">
    <h1>Resumen del Periodo</h1>
    
    <div class="row-kpi">
      <div class="card">
        <div class="kpi-title">Facturación Total</div>
        <div class="kpi-val" id="kpi-total">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Pedidos Totales</div>
        <div class="kpi-val" id="kpi-orders">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-val" id="kpi-ticket">$0</div>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
      <div class="card">
        <h3 style="margin-top:0">Top Productos (Ingresos $)</h3>
        <div class="chart-container">
          <canvas id="chartTopMoney"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Evolución Diaria (Mes Seleccionado)</h3>
        <div class="chart-container">
          <canvas id="chartDaily"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-clientes" class="section-view">
    <h1>Análisis y Filtro de Clientes</h1>
    <p style="color:var(--sidebar-text)">Configura aquí a quién ver. Esta configuración afecta a la pestaña "Resumen" y "Horarios".</p>

    <div class="client-control-panel">
      <div class="card" style="padding:15px; display:flex; flex-direction:column; height:100%; box-sizing:border-box;">
        <div class="mode-switch">
          <div class="btn-mode active include" id="btn-include" onclick="setFilterMode('include')">Ver Solo a...</div>
          <div class="btn-mode" id="btn-exclude" onclick="setFilterMode('exclude')">Ocultar a...</div>
        </div>
        
        <div class="search-bar">
          <input type="text" id="clientSearch" placeholder="Buscar nombre..." onkeyup="renderClientList()">
        </div>

        <div class="list-scroll" id="clientListContainer">
          </div>
        
        <div style="margin-top:10px; font-size:0.8rem; display:flex; justify-content:space-between;">
           <a href="#" onclick="toggleAllClients(true); return false;">Seleccionar Todos</a>
           <a href="#" onclick="toggleAllClients(false); return false;">Deseleccionar Todos</a>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px;">
        <div class="card" style="flex:1;">
          <h3 style="margin-top:0">Ticket Promedio por Cliente (Top 10)</h3>
          <div class="chart-container" style="height: 250px;">
            <canvas id="chartClientTicket"></canvas>
          </div>
        </div>
        <div class="card" style="flex:1;">
           <h3 style="margin-top:0">Volumen de Compra ($)</h3>
           <div class="chart-container" style="height: 250px;">
             <canvas id="chartClientVolume"></canvas>
           </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-estacional" class="section-view">
    <h1>Estacionalidad de Producto</h1>
    <p>Mira cómo se comporta un producto a lo largo de todo el año (Ignora el filtro de Mes).</p>
    
    <div class="card">
      <div style="display:flex; gap:15px; align-items:center; margin-bottom:20px;">
        <span class="material-icons-round">search</span>
        <input list="productsList" id="productInput" placeholder="Escribe el nombre del producto (ej: Coca Cola)..." 
               style="padding:10px; width:300px; border:1px solid #ccc; border-radius:6px;">
        <datalist id="productsList"></datalist>
        <button onclick="renderSeasonality()" style="padding:10px 20px; background:var(--sidebar-active); color:white; border:none; border-radius:6px; cursor:pointer;">Analizar</button>
      </div>

      <div class="chart-container" style="height:400px;">
        <canvas id="chartSeason"></canvas>
      </div>
    </div>
  </div>

  <div id="tab-heatmap" class="section-view">
    <h1>Mapa de Calor (Horarios)</h1>
    <p>Intensidad de ventas según día y hora. (Afectado por filtros de Mes y Clientes).</p>
    
    <div class="card">
      <div class="heatmap-grid" id="heatmapGrid"></div>
      <div style="display:flex; justify-content:space-between; margin-top:10px; color:#888; font-size:0.8rem;">
        <span>00:00 hs</span>
        <span>12:00 hs</span>
        <span>23:00 hs</span>
      </div>
    </div>
  </div>

</div>

<script>
  // CONFIG
  const API_URL = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  const moneyFmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });

  // DATOS GLOBALES
  let RAW_DATA = { pedidos: [], productos: [] };
  let FILTERED_DATA = [];
  
  // ESTADO DE FILTROS
  const state = {
    month: new Date().getMonth(),
    year: new Date().getFullYear(),
    clientMode: 'include', // 'include' (whitelist) | 'exclude' (blacklist)
    selectedClients: new Set(),
    allClientNames: []
  };

  // CHARTS REF
  const chartRefs = {};

  // --- INICIO ---
  window.addEventListener('DOMContentLoaded', async () => {
    initDateSelects();
    await loadData();
    initClientFilter();
    updateDashboard(); // Render inicial
  });

  // 1. CARGA DE DATOS
  async function loadData() {
    try {
      const res = await fetch(`${API_URL}/analytics/dump`);
      if(!res.ok) throw new Error("Error cargando datos");
      RAW_DATA = await res.json();

      // Extraer nombres únicos de clientes
      const names = new Set();
      RAW_DATA.pedidos.forEach(p => {
        if(p.user) names.add(p.user.trim());
      });
      state.allClientNames = Array.from(names).sort();
      
      // Default: Seleccionar todos (para que 'include' muestre todo)
      state.allClientNames.forEach(n => state.selectedClients.add(n));

      // Llenar datalist de productos
      const dl = document.getElementById('productsList');
      RAW_DATA.productos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nombre;
        dl.appendChild(opt);
      });

      document.getElementById('loader').style.display = 'none';
    } catch(e) {
      alert("Error: " + e.message);
    }
  }

  // 2. LOGICA DE FILTRO CENTRAL
  function updateDashboard() {
    // Leer selects fecha
    state.month = parseInt(document.getElementById('filterMonth').value);
    state.year = parseInt(document.getElementById('filterYear').value);

    // Filtrar RAW_DATA -> FILTERED_DATA
    FILTERED_DATA = RAW_DATA.pedidos.filter(p => {
      const d = new Date(p.fecha);
      // 1. Filtro Fecha
      if(d.getMonth() !== state.month) return false;
      if(d.getFullYear() !== state.year) return false;

      // 2. Filtro Cliente
      const u = p.user ? p.user.trim() : 'Invitado';
      const isSelected = state.selectedClients.has(u);
      
      if(state.clientMode === 'include') return isSelected; // Whitelist
      return !isSelected; // Blacklist
    });

    // Renderizar Vistas
    renderResumen();
    renderClientStats(); // Gráficos pestaña clientes
    renderHeatmap();
    // Nota: Estacionalidad se renderiza bajo demanda (botón)
  }

  // --- RENDERIZADORES ---

  function renderResumen() {
    let total = 0;
    const prodMap = {};
    const dailyMap = {}; 
    const daysInMonth = new Date(state.year, state.month+1, 0).getDate();
    for(let i=1; i<=daysInMonth; i++) dailyMap[i] = 0;

    FILTERED_DATA.forEach(p => {
      const t = Number(p.total) || 0;
      total += t;
      
      // Diario
      const d = new Date(p.fecha).getDate();
      dailyMap[d] += t;

      // Productos ($)
      const items = (typeof p.items === 'string') ? JSON.parse(p.items) : p.items;
      if(Array.isArray(items)) {
        items.forEach(it => {
          const sub = (Number(it.cantidad) * Number(it.precio_unitario||it.precio||0));
          prodMap[it.nombre] = (prodMap[it.nombre] || 0) + sub;
        });
      }
    });

    // KPIs
    const count = FILTERED_DATA.length;
    document.getElementById('kpi-total').textContent = moneyFmt.format(total);
    document.getElementById('kpi-orders').textContent = count;
    document.getElementById('kpi-ticket').textContent = moneyFmt.format(count ? total/count : 0);

    // Chart: Top Productos
    const sortedProd = Object.entries(prodMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
    createChart('chartTopMoney', 'bar', {
      labels: sortedProd.map(x=>x[0]),
      datasets: [{
        label: 'Ingresos ($)', data: sortedProd.map(x=>x[1]), backgroundColor: '#3699ff', borderRadius: 4
      }]
    }, { indexAxis: 'y' });

    // Chart: Diario
    createChart('chartDaily', 'line', {
      labels: Object.keys(dailyMap),
      datasets: [{
        label: 'Venta Diaria', data: Object.values(dailyMap), borderColor: '#1bc5bd', backgroundColor: 'rgba(27, 197, 189, 0.1)', fill: true, tension: 0.3
      }]
    });
  }

  function renderClientStats() {
    // Calculos basados en FILTERED_DATA (Lo del mes) o RAW_DATA?
    // Generalmente para análisis de cliente queremos ver el filtro global. Usamos FILTERED_DATA.
    
    const clientMap = {};
    FILTERED_DATA.forEach(p => {
      const u = p.user || 'Desc';
      if(!clientMap[u]) clientMap[u] = { total: 0, count: 0 };
      clientMap[u].total += Number(p.total);
      clientMap[u].count++;
    });

    const list = Object.entries(clientMap).map(([k,v]) => ({
      user: k, total: v.total, ticket: v.total/v.count
    }));

    // 1. Chart Ticket Promedio (Top 10 highest tickets)
    const sortedTicket = [...list].sort((a,b)=>b.ticket - a.ticket).slice(0,10);
    createChart('chartClientTicket', 'bar', {
      labels: sortedTicket.map(x=>x.user),
      datasets: [{ label: 'Ticket Promedio ($)', data: sortedTicket.map(x=>x.ticket), backgroundColor: '#8950fc' }]
    });

    // 2. Chart Volumen (Top 10 money)
    const sortedVol = [...list].sort((a,b)=>b.total - a.total).slice(0,10);
    createChart('chartClientVolume', 'bar', {
      labels: sortedVol.map(x=>x.user),
      datasets: [{ label: 'Total Comprado ($)', data: sortedVol.map(x=>x.total), backgroundColor: '#ffa800' }]
    });
  }

  function renderSeasonality() {
    const prodName = document.getElementById('productInput').value.trim();
    if(!prodName) return;

    // Ignoramos filtro de mes, usamos filtro de AÑO (state.year) y TODOS los meses
    const months = Array(12).fill(0);
    
    RAW_DATA.pedidos.forEach(p => {
      const d = new Date(p.fecha);
      if(d.getFullYear() !== state.year) return; // Solo año seleccionado

      const items = (typeof p.items === 'string') ? JSON.parse(p.items) : p.items;
      if(Array.isArray(items)) {
        const found = items.find(it => it.nombre.toLowerCase() === prodName.toLowerCase());
        if(found) {
          // Sumamos cantidad vendida
          months[d.getMonth()] += Number(found.cantidad);
        }
      }
    });

    createChart('chartSeason', 'line', {
      labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
      datasets: [{
        label: `Unidades vendidas de "${prodName}" (${state.year})`,
        data: months,
        borderColor: '#f64e60',
        backgroundColor: 'rgba(246, 78, 96, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 5
      }]
    });
  }

  function renderHeatmap() {
    const matrix = Array(7).fill(0).map(()=>Array(24).fill(0));
    let max = 0;

    FILTERED_DATA.forEach(p => {
      const d = new Date(p.fecha);
      let day = d.getDay() - 1; if(day===-1) day=6; // 0=Lun
      const h = d.getHours();
      matrix[day][h] += Number(p.total);
      if(matrix[day][h] > max) max = matrix[day][h];
    });

    const grid = document.getElementById('heatmapGrid');
    grid.innerHTML = '';
    const dayLabels = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];

    // Render Rows
    for(let d=0; d<7; d++) {
      // Label
      const lbl = document.createElement('div');
      lbl.className = 'hm-day';
      lbl.textContent = dayLabels[d];
      grid.appendChild(lbl);

      // Cells
      for(let h=0; h<24; h++) {
        const cell = document.createElement('div');
        cell.className = 'hm-cell';
        const val = matrix[d][h];
        const pct = max > 0 ? val/max : 0;
        
        // Color scale (Green intensity)
        cell.style.backgroundColor = val === 0 ? '#f0f2f5' : `rgba(27, 197, 189, ${0.15 + (pct*0.85)})`;
        if(val > 0) {
          cell.textContent = moneyFmt.format(val);
          cell.title = `${dayLabels[d]} ${h}:00hs - ${moneyFmt.format(val)}`;
        }
        grid.appendChild(cell);
      }
    }
  }

  // --- UI HELPERS ---
  
  function switchTab(tabId, navEl) {
    document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    navEl.classList.add('active');
  }

  function createChart(canvasId, type, data, options={}) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if(chartRefs[canvasId]) chartRefs[canvasId].destroy();
    
    chartRefs[canvasId] = new Chart(ctx, {
      type: type,
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: type !== 'bar' && type !== 'line' } }, // Ocultar legend en barras simples
        ...options
      }
    });
  }

  function initDateSelects() {
    const selM = document.getElementById('filterMonth');
    const selY = document.getElementById('filterYear');
    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    
    months.forEach((m,i) => {
      const opt = document.createElement('option');
      opt.value = i; opt.text = m;
      if(i === new Date().getMonth()) opt.selected = true;
      selM.add(opt);
    });

    const y = new Date().getFullYear();
    [y, y-1].forEach(yr => {
      const opt = document.createElement('option');
      opt.value = yr; opt.text = yr;
      selY.add(opt);
    });
  }

  // --- CLIENT FILTER LOGIC ---
  function initClientFilter() {
    renderClientList();
  }

  function renderClientList() {
    const container = document.getElementById('clientListContainer');
    const q = document.getElementById('clientSearch').value.toLowerCase();
    container.innerHTML = '';

    state.allClientNames.forEach(name => {
      if(!name.toLowerCase().includes(q)) return;
      
      const div = document.createElement('div');
      div.className = 'client-row';
      const isChecked = state.selectedClients.has(name);
      
      div.innerHTML = `
        <input type="checkbox" ${isChecked?'checked':''}>
        <span>${name}</span>
      `;
      
      div.addEventListener('click', (e) => {
        if(e.target.tagName !== 'INPUT') {
          const cb = div.querySelector('input');
          cb.checked = !cb.checked;
          toggleClient(name, cb.checked);
        }
      });
      div.querySelector('input').addEventListener('change', (e) => toggleClient(name, e.target.checked));
      
      container.appendChild(div);
    });
  }

  function toggleClient(name, checked) {
    if(checked) state.selectedClients.add(name);
    else state.selectedClients.delete(name);
    updateDashboard(); // Recalcular todo en tiempo real
  }

  function toggleAllClients(check) {
    if(check) state.allClientNames.forEach(n => state.selectedClients.add(n));
    else state.selectedClients.clear();
    renderClientList();
    updateDashboard();
  }

  function setFilterMode(mode) {
    state.clientMode = mode;
    document.getElementById('btn-include').classList.toggle('active', mode==='include');
    document.getElementById('btn-exclude').classList.toggle('active', mode==='exclude');
    updateDashboard();
  }

  // Animación loader
  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
  document.head.appendChild(styleSheet);

</script>
</body>
</html>
