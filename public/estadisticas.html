<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Funaz - Analytics v2</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      /* Colores Funaz */
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --accent: #e8f5e9;
      
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      
      /* Estados */
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --purple: #8b5cf6;

      /* UI */
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: var(--bg-body);
      color: var(--text-main);
      padding-bottom: 4rem;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    
    .btn-glass {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-glass:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }

    /* NAVIGATION TABS */
    .nav-tabs {
        display: flex;
        justify-content: center;
        background: white;
        padding: 1rem;
        gap: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }
    .tab-btn {
        padding: 10px 24px;
        border: none;
        background: transparent;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 50px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tab-btn.active {
        background: var(--accent);
        color: var(--primary);
    }
    .tab-btn:hover:not(.active) { background: #f3f4f6; }

    /* CONTENT DISPLAY */
    .tab-content { display: none; animation: fadeIn 0.4s; }
    .tab-content.active { display: block; }

    main { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }

    /* FILTROS Y CONTROLES */
    .filter-bar {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .filter-label { font-weight: 700; color: var(--primary); text-transform: uppercase; font-size: 0.85rem; }
    
    select {
      padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db;
      font-size: 0.95rem; background: #f9fafb; outline: none; cursor: pointer;
    }
    select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--accent); }
    
    /* SELECTOR CLIENTE ESPECIFICO */
    .client-selector {
        width: 100%; max-width: 400px;
        font-size: 1.1rem; padding: 10px;
        border: 2px solid var(--primary);
    }

    /* KPIs */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }
    .kpi-card {
      background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius);
      box-shadow: var(--shadow); border-left: 4px solid transparent;
      transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); }
    
    .kpi-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 0.5rem 0; }
    .kpi-sub { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

    .border-green { border-color: var(--success); }
    .border-blue { border-color: var(--info); }
    .border-orange { border-color: var(--warning); }
    .border-purple { border-color: var(--purple); }

    /* GRÁFICOS */
    .charts-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }
    .chart-box {
      background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius);
      box-shadow: var(--shadow); height: 400px; display: flex; flex-direction: column;
    }
    .chart-header { margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .chart-content { flex: 1; position: relative; min-height: 0; }

    /* ALERTA DE RIESGO */
    .alert-box {
      background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;
      padding: 1rem; border-radius: var(--radius); margin-bottom: 2rem; display: none;
    }
    .alert-box.visible { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    /* TABLA */
    .table-container {
      background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden; margin-bottom: 2rem;
    }
    .table-top {
      padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;
    }
    .search-input {
      padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 250px;
    }
    
    .table-scroll { overflow-x: auto; max-height: 500px; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th {
      background: #f9fafb; padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);
      position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e5e7eb;
    }
    td { padding: 1rem; border-bottom: 1px solid #f3f4f6; color: var(--text-main); }
    tr:hover { background: #f8fafc; }
    
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-low { background: #ffedd5; color: #9a3412; }
    .badge-out { background: #fee2e2; color: #991b1b; }

    @media(max-width: 768px) {
      .header-btns { display: none; }
      .charts-row { grid-template-columns: 1fr; }
      .client-selector { max-width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1><span class="material-icons-round">analytics</span> Funaz Dashboard</h1>
  <div class="header-btns">
    <button class="btn-glass" onclick="exportarExcel()"><span class="material-icons-round">download</span> Excel</button>
    <button class="btn-glass" onclick="location.href='admin.txt'"><span class="material-icons-round">arrow_back</span> Volver</button>
  </div>
</header>

<nav class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('general', this)">
        <span class="material-icons-round">dashboard</span> Visión General
    </button>
    <button class="tab-btn" onclick="switchTab('clientes', this)">
        <span class="material-icons-round">person_search</span> Análisis por Cliente
    </button>
</nav>

<main>

  <div id="tab-general" class="tab-content active">
      <div class="filter-bar">
        <span class="material-icons-round" style="color:var(--primary)">filter_alt</span>
        <span class="filter-label">Filtrar Datos:</span>
        <select id="mesSelect" onchange="actualizarDashboard()"></select>
        <select id="anioSelect" onchange="actualizarDashboard()"></select>
        
        <div style="flex:1"></div>
        <small style="color:var(--text-muted)">Última act: <span id="lastSync">--:--</span></small>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card border-green">
          <div class="kpi-title">Facturación Total</div>
          <div class="kpi-val" id="kpi-total">$0</div>
          <div class="kpi-sub" id="trend-total">--</div>
        </div>
        <div class="kpi-card border-purple">
          <div class="kpi-title">Proyección (Fin de Mes)</div>
          <div class="kpi-val" id="kpi-project">$0</div>
          <div class="kpi-sub">Basado en ritmo actual</div>
        </div>
        <div class="kpi-card border-blue">
          <div class="kpi-title">Ticket Promedio</div>
          <div class="kpi-val" id="kpi-ticket">$0</div>
          <div class="kpi-sub" id="trend-ticket">--</div>
        </div>
        <div class="kpi-card border-orange">
          <div class="kpi-title">Pedidos Confirmados</div>
          <div class="kpi-val" id="kpi-orders">0</div>
          <div class="kpi-sub" id="trend-orders">--</div>
        </div>
      </div>

      <div class="charts-row">
        <div class="chart-box">
          <div class="chart-header">
            <span class="material-icons-round" style="color:var(--warning)">schedule</span>
            Horarios "Calientes" (Ventas por Hora)
          </div>
          <div class="chart-content">
            <canvas id="chartHourly"></canvas>
          </div>
        </div>
        
        <div class="chart-box">
          <div class="chart-header">
            <span class="material-icons-round" style="color:var(--primary)">show_chart</span>
            Evolución de Ventas (Día a día)
          </div>
          <div class="chart-content">
            <canvas id="chartDaily"></canvas>
          </div>
        </div>
      </div>

      <div class="charts-row">
        <div class="chart-box">
          <div class="chart-header">
            <span class="material-icons-round" style="color:var(--purple)">person</span>
            Top Clientes (Por Usuario)
          </div>
          <div class="chart-content">
            <canvas id="chartClients"></canvas>
          </div>
        </div>
        
        <div class="chart-box">
          <div class="chart-header">
            <span class="material-icons-round" style="color:var(--success)">monetization_on</span>
            Productos que más generan ($)
          </div>
          <div class="chart-content">
            <canvas id="chartMoneyProd"></canvas>
          </div>
        </div>
      </div>
      
      <div class="charts-row">
          <div class="chart-box">
          <div class="chart-header">
            <span class="material-icons-round" style="color:var(--info)">inventory_2</span>
            Top Productos (Unidades)
          </div>
          <div class="chart-content">
            <canvas id="chartQtyProd"></canvas>
          </div>
        </div>
        <div class="chart-box">
            <div class="chart-header">
              <span class="material-icons-round" style="color:var(--danger)">attach_money</span>
              Ingresos "cliente" (>10k vs &lt;10k)
            </div>
            <div class="chart-content">
              <canvas id="chartCliente10k"></canvas>
            </div>
          </div>
      </div>

      <div id="churnAlert" class="alert-box">
        <h3 style="margin-top:0; display:flex; align-items:center; gap:8px;">
          <span class="material-icons-round">warning_amber</span> Clientes en Riesgo
        </h3>
        <p style="margin:0 0 10px;">Clientes habituales que no compran hace más de 30 días:</p>
        <ul id="churnList" style="margin:0; padding-left:20px; font-weight:600;"></ul>
      </div>

      <div class="table-container">
        <div class="table-top">
          <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
            <span class="material-icons-round" style="color:var(--primary)">table_chart</span>
            Detalle de Productos
          </h3>
          <input type="text" id="searchInput" class="search-input" placeholder="Buscar producto..." onkeyup="filtrarTabla()">
        </div>
        <div class="table-scroll">
          <table id="mainTable">
            <thead>
              <tr>
                <th>Producto</th>
                <th>U. Vendidas</th>
                <th>Ingresos ($)</th>
                <th>Precio Unit.</th>
                <th>Stock</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <details style="margin: 1rem 0; cursor: pointer; color: var(--text-muted);">
        <summary>Ver productos sin movimiento ("Huesos")</summary>
        <div style="background:white; padding:1rem; border-radius:12px; margin-top:10px;">
            <ul id="boneList" style="column-count:3; font-size:0.85rem;"></ul>
        </div>
      </details>
  </div>

  <div id="tab-clientes" class="tab-content">
      
      <div style="background: var(--bg-card); padding:2rem; border-radius: var(--radius); text-align:center; box-shadow:var(--shadow); margin-bottom:2rem;">
          <h2 style="margin-top:0; color:var(--primary)">Seleccionar Cliente</h2>
          <select id="clientSelect" class="client-selector" onchange="renderClientView()">
              <option value="">-- Elige un cliente para analizar --</option>
          </select>
      </div>

      <div id="client-stats" style="display:none">
          <div class="kpi-grid">
              <div class="kpi-card border-green">
                  <div class="kpi-title">Total Comprado (Histórico)</div>
                  <div class="kpi-val" id="cli-total">$0</div>
              </div>
              <div class="kpi-card border-blue">
                  <div class="kpi-title">Ticket Promedio</div>
                  <div class="kpi-val" id="cli-ticket">$0</div>
                  <div class="kpi-sub">Promedio por pedido</div>
              </div>
              <div class="kpi-card border-purple">
                  <div class="kpi-title">Total Pedidos</div>
                  <div class="kpi-val" id="cli-orders">0</div>
                  <div class="kpi-sub" id="cli-last">Última: --</div>
              </div>
          </div>

          <div class="charts-row">
              <div class="chart-box">
                  <div class="chart-header">
                      <span class="material-icons-round" style="color:var(--primary)">calendar_month</span>
                      Historial de Compras (Por Mes)
                  </div>
                  <div class="chart-content">
                      <canvas id="cliChartHistory"></canvas>
                  </div>
              </div>
              <div class="chart-box">
                  <div class="chart-header">
                      <span class="material-icons-round" style="color:var(--warning)">pie_chart</span>
                      Top Productos (Más pedidos)
                  </div>
                  <div class="chart-content">
                      <canvas id="cliChartProducts"></canvas>
                  </div>
              </div>
          </div>

          <div class="table-container">
            <div class="table-top">
              <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
                <span class="material-icons-round" style="color:var(--info)">shopping_bag</span>
                Desglose de productos comprados
              </h3>
            </div>
            <div class="table-scroll">
              <table id="clientTable">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cant. Total</th>
                    <th>Invertido ($)</th>
                    <th>% del Gasto</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
      </div>
  </div>

</main>

<script>
  // CONFIG
  const API_BASE = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  const moneyFmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
  
  // STATE
  let allPedidos = [];
  let allProductos = [];
  let charts = {}; // Store chart instances

  // INIT
  window.addEventListener('DOMContentLoaded', async () => {
    initFilters();
    await loadData();
    actualizarDashboard();
    initClientSelector(); // Cargar lista de clientes
  });

  async function loadData() {
    try {
      const [resPed, resProd] = await Promise.all([
        fetch(`${API_BASE}/pedidos`),
        fetch(`${API_BASE}/productos`)
      ]);
      allPedidos = await resPed.json();
      allProductos = await resProd.json();
      document.getElementById('lastSync').textContent = new Date().toLocaleTimeString().slice(0,5);
      checkChurn();
    } catch(e) { console.error(e); alert('Error cargando datos'); }
  }

  // --- TABS LOGIC ---
  function switchTab(tabId, btn) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      document.getElementById('tab-' + tabId).classList.add('active');
      btn.classList.add('active');
  }

  // --- GENERAL DASHBOARD FUNCTIONS ---
  function initFilters() {
    const today = new Date();
    const selMes = document.getElementById('mesSelect');
    const selAnio = document.getElementById('anioSelect');
    
    ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].forEach((m, i) => {
      const opt = document.createElement('option');
      opt.value = i; opt.text = m;
      if(i === today.getMonth()) opt.selected = true;
      selMes.add(opt);
    });

    [today.getFullYear(), today.getFullYear()-1].forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.text = y;
      selAnio.add(opt);
    });
  }

  function actualizarDashboard() {
    const mes = parseInt(document.getElementById('mesSelect').value);
    const anio = parseInt(document.getElementById('anioSelect').value);

    // Filter Current Month
    const currentOrders = allPedidos.filter(p => {
      const d = new Date(p.fecha);
      if (isNaN(d.getTime())) return false; 
      return d.getMonth() === mes && d.getFullYear() === anio;
    });

    // Filter Previous Month
    const prevDate = new Date(anio, mes - 1, 1); 
    const prevOrders = allPedidos.filter(p => {
      const d = new Date(p.fecha);
      if (isNaN(d.getTime())) return false;
      return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
    });

    renderKPIs(currentOrders, prevOrders, mes, anio);
    
    // Gráficos Generales
    renderChartHourly(currentOrders);
    renderChartDaily(currentOrders, mes, anio);
    renderChartClients(currentOrders);
    renderChartMoneyProd(currentOrders);
    renderChartQtyProd(currentOrders);
    renderChartCliente10k(currentOrders); 

    // Tablas Generales
    renderTable(currentOrders);
    renderBones(currentOrders);
  }

  // --- CLIENT VIEW LOGIC ---

  function initClientSelector() {
      // Extraer usuarios únicos de todos los pedidos
      const clients = [...new Set(allPedidos.map(p => p.user).filter(Boolean))].sort();
      const sel = document.getElementById('clientSelect');
      
      clients.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          sel.appendChild(opt);
      });
  }

  function renderClientView() {
      const clientName = document.getElementById('clientSelect').value;
      const container = document.getElementById('client-stats');
      
      if(!clientName) {
          container.style.display = 'none';
          return;
      }
      
      container.style.display = 'block';

      // 1. Filtrar pedidos solo de este cliente (histórico completo)
      const cliOrders = allPedidos.filter(p => p.user === clientName);
      
      // 2. Calcular KPIs
      const totalSpent = cliOrders.reduce((sum, p) => sum + (Number(p.total)||0), 0);
      const totalOrders = cliOrders.length;
      const avgTicket = totalOrders > 0 ? totalSpent / totalOrders : 0;
      
      // Fecha ultimo pedido
      const dates = cliOrders.map(p => new Date(p.fecha)).sort((a,b) => b-a);
      const lastDate = dates.length > 0 ? dates[0].toLocaleDateString() : 'N/A';

      document.getElementById('cli-total').textContent = moneyFmt.format(totalSpent);
      document.getElementById('cli-ticket').textContent = moneyFmt.format(avgTicket);
      document.getElementById('cli-orders').textContent = totalOrders;
      document.getElementById('cli-last').textContent = `Última compra: ${lastDate}`;

      // 3. Renderizar Gráficos Cliente
      renderCliHistory(cliOrders);
      renderCliTopProds(cliOrders, totalSpent);
  }

  function renderCliHistory(orders) {
      // Agrupar por Mes-Año
      const map = {};
      orders.forEach(p => {
          const d = new Date(p.fecha);
          if(isNaN(d.getTime())) return;
          const key = `${d.getMonth()+1}/${d.getFullYear()}`; // e.g. "1/2025"
          // Usamos una clave ordenable internamente YYYYMM
          const sortKey = d.getFullYear() * 100 + (d.getMonth()+1);
          
          if(!map[sortKey]) map[sortKey] = { label: key, total: 0 };
          map[sortKey].total += Number(p.total);
      });

      // Convertir a array y ordenar cronológicamente
      const sortedKeys = Object.keys(map).sort();
      const labels = sortedKeys.map(k => map[k].label);
      const values = sortedKeys.map(k => map[k].total);

      const ctx = getChartCtx('cliChartHistory');
      charts['cliChartHistory'] = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Gasto Mensual ($)',
                  data: values,
                  backgroundColor: '#2e7d32',
                  borderRadius: 4
              }]
          },
          options: { responsive:true, maintainAspectRatio:false }
      });
  }

  function renderCliTopProds(orders, totalSpentGrand) {
      const prodMap = {};
      
      orders.forEach(p => {
          const items = parseItems(p.items);
          items.forEach(i => {
              const money = Number(i.subtotal) || (Number(i.cantidad)*Number(i.precio_unitario));
              if(!prodMap[i.nombre]) prodMap[i.nombre] = { qty:0, money:0 };
              prodMap[i.nombre].qty += Number(i.cantidad);
              prodMap[i.nombre].money += money;
          });
      });

      // Ordenar por cantidad para el gráfico
      const sortedByQty = Object.entries(prodMap).sort((a,b) => b[1].qty - a[1].qty).slice(0, 5);
      
      // Chart
      const ctx = getChartCtx('cliChartProducts');
      charts['cliChartProducts'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: sortedByQty.map(x=>x[0]),
              datasets: [{
                  data: sortedByQty.map(x=>x[1].qty),
                  backgroundColor: ['#2e7d32','#43a047','#66bb6a','#81c784','#a5d6a7'],
                  borderWidth: 0
              }]
          },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
      });

      // Tabla Detalle
      const sortedByMoney = Object.entries(prodMap).sort((a,b) => b[1].money - a[1].money);
      const tbody = document.querySelector('#clientTable tbody');
      tbody.innerHTML = '';
      
      sortedByMoney.forEach(([name, data]) => {
          const pct = totalSpentGrand > 0 ? (data.money / totalSpentGrand)*100 : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td><b>${name}</b></td>
              <td>${data.qty} u.</td>
              <td>${moneyFmt.format(data.money)}</td>
              <td><div style="background:#e8f5e9; width:${pct}%; height:10px; border-radius:4px; min-width:2px;"></div> <small>${pct.toFixed(1)}%</small></td>
          `;
          tbody.appendChild(tr);
      });
  }


  // --- SHARED HELPERS ---
  function renderKPIs(curr, prev, mesIdx, year) {
    const sum = (arr) => arr.reduce((acc, p) => acc + (Number(p.total)||0), 0);
    const totCurr = sum(curr);
    const totPrev = sum(prev);
    const countCurr = curr.length;
    const countPrev = prev.length;
    const tickCurr = countCurr ? totCurr/countCurr : 0;
    const tickPrev = countPrev ? totPrev/countPrev : 0;

    document.getElementById('kpi-total').textContent = moneyFmt.format(totCurr);
    document.getElementById('kpi-orders').textContent = countCurr;
    document.getElementById('kpi-ticket').textContent = moneyFmt.format(tickCurr);

    setTrend('trend-total', totCurr, totPrev);
    setTrend('trend-orders', countCurr, countPrev, false);
    setTrend('trend-ticket', tickCurr, tickPrev);

    const now = new Date();
    if(mesIdx === now.getMonth() && year === now.getFullYear()) {
      const day = now.getDate();
      const daysInMonth = new Date(year, mesIdx+1, 0).getDate();
      if(day > 0) {
        const proj = (totCurr / day) * daysInMonth;
        document.getElementById('kpi-project').textContent = moneyFmt.format(proj);
      }
    } else {
      document.getElementById('kpi-project').textContent = '---';
    }
  }

  function setTrend(id, curr, prev, money=true) {
    const el = document.getElementById(id);
    if(prev === 0) { el.innerHTML = '<small>Sin datos previos</small>'; return; }
    const pct = ((curr - prev)/prev)*100;
    const color = pct >= 0 ? '#166534' : '#991b1b';
    const bg = pct >= 0 ? '#dcfce7' : '#fee2e2';
    const icon = pct >= 0 ? 'north_east' : 'south_east';
    el.innerHTML = `<span style="background:${bg}; color:${color}; padding:2px 6px; border-radius:10px; font-weight:bold; font-size:0.8rem; display:inline-flex; align-items:center;">
      <span class="material-icons-round" style="font-size:10px">${icon}</span> ${Math.abs(pct).toFixed(1)}%
    </span> <small>vs mes ant.</small>`;
  }

  function getChartCtx(id) {
    if(charts[id]) charts[id].destroy(); 
    return document.getElementById(id).getContext('2d');
  }

  // --- CHARTS GENERIC ---
  function renderChartHourly(orders) {
    const data = new Array(24).fill(0);
    orders.forEach(p => {
      const h = new Date(p.fecha).getHours();
      data[h] += Number(p.total); 
    });
    
    const ctx = getChartCtx('chartHourly');
    charts['chartHourly'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length:24}, (_,i)=>`${i}hs`),
        datasets: [{
          label: 'Ventas ($)',
          data: data,
          backgroundColor: '#f59e0b',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  function renderChartDaily(orders, mes, year) {
    const days = new Date(year, mes+1, 0).getDate();
    const data = new Array(days).fill(0);
    orders.forEach(p => {
      const d = new Date(p.fecha).getDate();
      data[d-1] += Number(p.total);
    });

    const ctx = getChartCtx('chartDaily');
    charts['chartDaily'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length:days}, (_,i)=>i+1),
        datasets: [{
          label: 'Ventas ($)',
          data: data,
          borderColor: '#2e7d32',
          backgroundColor: 'rgba(46,125,50,0.1)',
          fill: true, tension: 0.3
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
    });
  }

  function renderChartClients(orders) {
    const map = {};
    orders.forEach(p => {
      const clientName = p.user || 'Cliente Desconocido';
      map[clientName] = (map[clientName]||0) + Number(p.total);
    });
    
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
    
    const ctx = getChartCtx('chartClients');
    charts['chartClients'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          data: sorted.map(x=>x[1]),
          backgroundColor: ['#8b5cf6','#a78bfa','#c4b5fd','#ddd6fe','#ede9fe'],
          borderWidth: 0
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{legend:{position:'right'}} }
    });
  }

  function renderChartMoneyProd(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => {
         const money = Number(i.subtotal) || (Number(i.cantidad)*Number(i.precio_unitario));
         map[i.nombre] = (map[i.nombre]||0) + money;
      });
    });
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

    const ctx = getChartCtx('chartMoneyProd');
    charts['chartMoneyProd'] = new Chart(ctx, {
      type: 'bar',
      indexAxis: 'y',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          label: 'Ingresos Generados ($)',
          data: sorted.map(x=>x[1]),
          backgroundColor: '#10b981',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  function renderChartQtyProd(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => map[i.nombre] = (map[i.nombre]||0) + Number(i.cantidad));
    });
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

    const ctx = getChartCtx('chartQtyProd');
    charts['chartQtyProd'] = new Chart(ctx, {
      type: 'bar',
      indexAxis: 'y',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          label: 'Unidades Vendidas',
          data: sorted.map(x=>x[1]),
          backgroundColor: '#3b82f6',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  function renderChartCliente10k(orders) {
    const clienteOrders = orders.filter(p => p.user && p.user.toLowerCase() === 'cliente');
    
    let less10kVal = 0;
    let more10kVal = 0;

    clienteOrders.forEach(p => {
        const t = Number(p.total) || 0;
        if(t > 10000) more10kVal += t;
        else less10kVal += t;
    });

    const totalMoney = less10kVal + more10kVal;

    const ctx = getChartCtx('chartCliente10k');
    charts['chartCliente10k'] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Pedidos Menores ($)', 'Pedidos Mayores ($)'],
        datasets: [{
          data: [less10kVal, more10kVal],
          backgroundColor: ['#ef4444', '#10b981'],
          borderWidth: 1
        }]
      },
      options: { 
        responsive:true, 
        maintainAspectRatio:false, 
        plugins:{
            legend:{position:'right'},
            title: { 
              display: true, 
              text: `Total Generado: ${moneyFmt.format(totalMoney)}` 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) label += ': ';
                  if (context.parsed !== null) {
                    label += moneyFmt.format(context.parsed);
                  }
                  return label;
                }
              }
            }
        } 
      }
    });
  }

  function renderTable(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => {
        if(!map[i.id]) map[i.id] = { nombre: i.nombre, cant: 0, total: 0 };
        map[i.id].cant += Number(i.cantidad);
        map[i.id].total += (Number(i.subtotal) || (Number(i.cantidad)*Number(i.precio_unitario)));
      });
    });

    const list = Object.values(map).map(i => {
      const prod = allProductos.find(p => p.nombre === i.nombre) || { stock:0, precio:0 };
      return { ...i, stock: Number(prod.stock), precio: Number(prod.precio) };
    }).sort((a,b) => b.total - a.total);

    const tbody = document.querySelector('#mainTable tbody');
    tbody.innerHTML = '';
    
    list.forEach(p => {
      let badge = `<span class="badge badge-ok">OK</span>`;
      if(p.stock<=0) badge = `<span class="badge badge-out">AGOTADO</span>`;
      else if(p.stock<10) badge = `<span class="badge badge-low">BAJO</span>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${p.nombre}</b></td>
        <td>${p.cant}</td>
        <td>${moneyFmt.format(p.total)}</td>
        <td>${moneyFmt.format(p.precio)}</td>
        <td>${p.stock}</td>
        <td>${badge}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderBones(orders) {
    const soldNames = new Set();
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => soldNames.add(i.nombre));
    });
    const bones = allProductos.filter(p => !soldNames.has(p.nombre));
    const ul = document.getElementById('boneList');
    ul.innerHTML = '';
    if(bones.length === 0) { ul.innerHTML = '<li>Todo se ha vendido al menos una vez.</li>'; return; }
    bones.forEach(b => {
      const li = document.createElement('li');
      li.textContent = `${b.nombre} (Stock: ${b.stock})`;
      ul.appendChild(li);
    });
  }

  function checkChurn() {
    const lastBuy = {};
    const limit = new Date(); 
    limit.setDate(limit.getDate()-30);
    
    allPedidos.forEach(p => {
      const u = p.user;
      const d = new Date(p.fecha);
      if(u && (!lastBuy[u] || d > lastBuy[u])) lastBuy[u] = d;
    });

    const list = [];
    Object.entries(lastBuy).forEach(([u, date]) => {
      if(date < limit) list.push({ user: u, days: Math.floor((new Date()-date)/(86400000)) });
    });
    list.sort((a,b)=>b.days-a.days);

    if(list.length>0) {
      document.getElementById('churnAlert').classList.add('visible');
      const ul = document.getElementById('churnList');
      list.slice(0,10).forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.user} (Hace ${r.days} días)`;
        ul.appendChild(li);
      });
    }
  }

  function parseItems(items) {
    return Array.isArray(items) ? items : JSON.parse(items || '[]');
  }

  function filtrarTabla() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#mainTable tbody tr');
    rows.forEach(r => {
      r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  }

  function exportarExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), { sheet:"Ventas" });
    XLSX.writeFile(wb, 'Reporte_Funaz.xlsx');
  }
</script>
</body>
</html>
