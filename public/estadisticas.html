<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Funaz - Analytics</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      /* Colores Funaz */
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --accent: #e8f5e9;
      
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      
      /* Estados */
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --purple: #8b5cf6;

      /* UI */
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: var(--bg-body);
      color: var(--text-main);
      padding-bottom: 4rem;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    
    .btn-glass {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-glass:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }

    main { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

    /* FILTROS */
    .filter-bar {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .filter-label { font-weight: 700; color: var(--primary); text-transform: uppercase; font-size: 0.85rem; }
    
    select {
      padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db;
      font-size: 0.95rem; background: #f9fafb; outline: none; cursor: pointer;
    }
    select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--accent); }

    /* KPIs */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }
    .kpi-card {
      background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius);
      box-shadow: var(--shadow); border-left: 4px solid transparent;
      transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); }
    
    .kpi-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 0.5rem 0; }
    .kpi-sub { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

    .border-green { border-color: var(--success); }
    .border-blue { border-color: var(--info); }
    .border-orange { border-color: var(--warning); }
    .border-purple { border-color: var(--purple); }

    /* GRÁFICOS */
    .charts-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }
    .chart-box {
      background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius);
      box-shadow: var(--shadow); height: 400px; display: flex; flex-direction: column;
    }
    .chart-header { margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .chart-content { flex: 1; position: relative; min-height: 0; }

    /* ALERTA DE RIESGO */
    .alert-box {
      background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;
      padding: 1rem; border-radius: var(--radius); margin-bottom: 2rem; display: none;
    }
    .alert-box.visible { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    /* TABLA */
    .table-container {
      background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden; margin-bottom: 2rem;
    }
    .table-top {
      padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;
    }
    .search-input {
      padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 250px;
    }
    
    .table-scroll { overflow-x: auto; max-height: 500px; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th {
      background: #f9fafb; padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);
      position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e5e7eb;
    }
    td { padding: 1rem; border-bottom: 1px solid #f3f4f6; color: var(--text-main); }
    tr:hover { background: #f8fafc; }
    
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-low { background: #ffedd5; color: #9a3412; }
    .badge-out { background: #fee2e2; color: #991b1b; }

    @media(max-width: 768px) {
      .header-btns { display: none; }
      .charts-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1><span class="material-icons-round">analytics</span> Funaz Dashboard</h1>
  <div class="header-btns">
    <button class="btn-glass" onclick="exportarExcel()"><span class="material-icons-round">download</span> Excel</button>
    <button class="btn-glass" onclick="location.href='admin.txt'"><span class="material-icons-round">arrow_back</span> Volver</button>
  </div>
</header>

<main>
  <div class="filter-bar">
    <span class="material-icons-round" style="color:var(--primary)">filter_alt</span>
    <span class="filter-label">Filtrar Datos:</span>
    <select id="mesSelect" onchange="actualizarDashboard()"></select>
    <select id="anioSelect" onchange="actualizarDashboard()"></select>
    
    <div style="flex:1"></div>
    <small style="color:var(--text-muted)">Última act: <span id="lastSync">--:--</span></small>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card border-green">
      <div class="kpi-title">Facturación Total</div>
      <div class="kpi-val" id="kpi-total">$0</div>
      <div class="kpi-sub" id="trend-total">--</div>
    </div>
    <div class="kpi-card border-purple">
      <div class="kpi-title">Proyección (Fin de Mes)</div>
      <div class="kpi-val" id="kpi-project">$0</div>
      <div class="kpi-sub">Basado en ritmo actual</div>
    </div>
    <div class="kpi-card border-blue">
      <div class="kpi-title">Ticket Promedio</div>
      <div class="kpi-val" id="kpi-ticket">$0</div>
      <div class="kpi-sub" id="trend-ticket">--</div>
    </div>
    <div class="kpi-card border-orange">
      <div class="kpi-title">Pedidos Confirmados</div>
      <div class="kpi-val" id="kpi-orders">0</div>
      <div class="kpi-sub" id="trend-orders">--</div>
    </div>
  </div>

  <div class="charts-row">
    <div class="chart-box">
      <div class="chart-header">
        <span class="material-icons-round" style="color:var(--warning)">schedule</span>
        Horarios "Calientes" (Ventas por Hora)
      </div>
      <div class="chart-content">
        <canvas id="chartHourly"></canvas>
      </div>
    </div>
    
    <div class="chart-box">
      <div class="chart-header">
        <span class="material-icons-round" style="color:var(--primary)">show_chart</span>
        Evolución de Ventas (Día a día)
      </div>
      <div class="chart-content">
        <canvas id="chartDaily"></canvas>
      </div>
    </div>
  </div>

  <div class="charts-row">
    <div class="chart-box">
      <div class="chart-header">
        <span class="material-icons-round" style="color:var(--purple)">person</span>
        Top Clientes (Por Usuario)
      </div>
      <div class="chart-content">
        <canvas id="chartClients"></canvas>
      </div>
    </div>
    
    <div class="chart-box">
      <div class="chart-header">
        <span class="material-icons-round" style="color:var(--success)">monetization_on</span>
        Productos que más generan ($)
      </div>
      <div class="chart-content">
        <canvas id="chartMoneyProd"></canvas>
      </div>
    </div>
  </div>
  
  <div class="charts-row">
     <div class="chart-box">
      <div class="chart-header">
        <span class="material-icons-round" style="color:var(--info)">inventory_2</span>
        Top Productos (Unidades)
      </div>
      <div class="chart-content">
        <canvas id="chartQtyProd"></canvas>
      </div>
    </div>
    <div class="chart-box">
        <div class="chart-header">
          <span class="material-icons-round" style="color:var(--danger)">pie_chart</span>
          Salud del Stock
        </div>
        <div class="chart-content">
          <canvas id="chartStock"></canvas>
        </div>
      </div>
  </div>

  <div id="churnAlert" class="alert-box">
    <h3 style="margin-top:0; display:flex; align-items:center; gap:8px;">
      <span class="material-icons-round">warning_amber</span> Clientes en Riesgo
    </h3>
    <p style="margin:0 0 10px;">Clientes habituales que no compran hace más de 30 días:</p>
    <ul id="churnList" style="margin:0; padding-left:20px; font-weight:600;"></ul>
  </div>

  <div class="table-container">
    <div class="table-top">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
        <span class="material-icons-round" style="color:var(--primary)">table_chart</span>
        Detalle de Productos
      </h3>
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar producto..." onkeyup="filtrarTabla()">
    </div>
    <div class="table-scroll">
      <table id="mainTable">
        <thead>
          <tr>
            <th>Producto</th>
            <th>U. Vendidas</th>
            <th>Ingresos ($)</th>
            <th>Precio Unit.</th>
            <th>Stock</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <details style="margin: 1rem 0; cursor: pointer; color: var(--text-muted);">
    <summary>Ver productos sin movimiento ("Huesos")</summary>
    <div style="background:white; padding:1rem; border-radius:12px; margin-top:10px;">
        <ul id="boneList" style="column-count:3; font-size:0.85rem;"></ul>
    </div>
  </details>

</main>

<script>
  // CONFIG
  const API_BASE = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  const moneyFmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
  
  // STATE
  let allPedidos = [];
  let allProductos = [];
  let charts = {}; // Store chart instances

  // INIT
  window.addEventListener('DOMContentLoaded', async () => {
    initFilters();
    await loadData();
    actualizarDashboard();
  });

  async function loadData() {
    try {
      const [resPed, resProd] = await Promise.all([
        fetch(`${API_BASE}/pedidos`),
        fetch(`${API_BASE}/productos`)
      ]);
      allPedidos = await resPed.json();
      allProductos = await resProd.json();
      document.getElementById('lastSync').textContent = new Date().toLocaleTimeString().slice(0,5);
      checkChurn();
    } catch(e) { console.error(e); alert('Error cargando datos'); }
  }

  function initFilters() {
    const today = new Date();
    const selMes = document.getElementById('mesSelect');
    const selAnio = document.getElementById('anioSelect');
    
    ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].forEach((m, i) => {
      const opt = document.createElement('option');
      opt.value = i; opt.text = m;
      if(i === today.getMonth()) opt.selected = true;
      selMes.add(opt);
    });

    [today.getFullYear(), today.getFullYear()-1].forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.text = y;
      selAnio.add(opt);
    });
  }

  // --- MAIN UPDATE FUNCTION ---
  function actualizarDashboard() {
    // 1. Obtener valores del filtro (asegurar enteros)
    const mes = parseInt(document.getElementById('mesSelect').value);
    const anio = parseInt(document.getElementById('anioSelect').value);

    // 2. Filtrar Pedidos (Mes seleccionado)
    const currentOrders = allPedidos.filter(p => {
      const d = new Date(p.fecha);
      // Validar fecha válida
      if (isNaN(d.getTime())) return false; 
      return d.getMonth() === mes && d.getFullYear() === anio;
    });

    // 3. Filtrar Pedidos (Mes anterior para comparación)
    // Calculamos la fecha del mes anterior correctamente (manejando cambio de año)
    const prevDate = new Date(anio, mes - 1, 1); 
    const prevOrders = allPedidos.filter(p => {
      const d = new Date(p.fecha);
      if (isNaN(d.getTime())) return false;
      return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
    });

    // 4. Ejecutar renderizado
    renderKPIs(currentOrders, prevOrders, mes, anio);
    
    // Gráficos
    renderChartHourly(currentOrders); // AÑADIDO: Horarios
    renderChartDaily(currentOrders, mes, anio);
    renderChartClients(currentOrders); // MODIFICADO: Solo Users
    renderChartMoneyProd(currentOrders); // AÑADIDO: Plata
    renderChartQtyProd(currentOrders);
    renderChartStock(); 

    // Tablas
    renderTable(currentOrders);
    renderBones(currentOrders);
  }

  // --- KPIS ---
  function renderKPIs(curr, prev, mesIdx, year) {
    const sum = (arr) => arr.reduce((acc, p) => acc + (Number(p.total)||0), 0);
    const totCurr = sum(curr);
    const totPrev = sum(prev);
    const countCurr = curr.length;
    const countPrev = prev.length;
    const tickCurr = countCurr ? totCurr/countCurr : 0;
    const tickPrev = countPrev ? totPrev/countPrev : 0;

    // Set Values
    document.getElementById('kpi-total').textContent = moneyFmt.format(totCurr);
    document.getElementById('kpi-orders').textContent = countCurr;
    document.getElementById('kpi-ticket').textContent = moneyFmt.format(tickCurr);

    // Set Trends
    setTrend('trend-total', totCurr, totPrev);
    setTrend('trend-orders', countCurr, countPrev, false);
    setTrend('trend-ticket', tickCurr, tickPrev);

    // Projection
    const now = new Date();
    if(mesIdx === now.getMonth() && year === now.getFullYear()) {
      const day = now.getDate();
      const daysInMonth = new Date(year, mesIdx+1, 0).getDate();
      if(day > 0) {
        const proj = (totCurr / day) * daysInMonth;
        document.getElementById('kpi-project').textContent = moneyFmt.format(proj);
      }
    } else {
      document.getElementById('kpi-project').textContent = '---';
    }
  }

  function setTrend(id, curr, prev, money=true) {
    const el = document.getElementById(id);
    if(prev === 0) { el.innerHTML = '<small>Sin datos previos</small>'; return; }
    const pct = ((curr - prev)/prev)*100;
    const color = pct >= 0 ? '#166534' : '#991b1b';
    const bg = pct >= 0 ? '#dcfce7' : '#fee2e2';
    const icon = pct >= 0 ? 'north_east' : 'south_east';
    el.innerHTML = `<span style="background:${bg}; color:${color}; padding:2px 6px; border-radius:10px; font-weight:bold; font-size:0.8rem; display:inline-flex; align-items:center;">
      <span class="material-icons-round" style="font-size:10px">${icon}</span> ${Math.abs(pct).toFixed(1)}%
    </span> <small>vs mes ant.</small>`;
  }

  // --- CHART HELPERS ---
  function getChartCtx(id) {
    if(charts[id]) charts[id].destroy(); // IMPORTANTE: Destruir antes de crear
    return document.getElementById(id).getContext('2d');
  }

  // --- CHARTS ---

  // 1. HORARIOS (Lo que pediste)
  function renderChartHourly(orders) {
    const data = new Array(24).fill(0);
    orders.forEach(p => {
      const h = new Date(p.fecha).getHours();
      data[h] += Number(p.total); // Sumamos dinero, o podría ser cantidad de pedidos (data[h]++)
    });
    
    const ctx = getChartCtx('chartHourly');
    charts['chartHourly'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length:24}, (_,i)=>`${i}hs`),
        datasets: [{
          label: 'Ventas ($)',
          data: data,
          backgroundColor: '#f59e0b',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  // 2. DIARIO
  function renderChartDaily(orders, mes, year) {
    const days = new Date(year, mes+1, 0).getDate();
    const data = new Array(days).fill(0);
    orders.forEach(p => {
      const d = new Date(p.fecha).getDate();
      data[d-1] += Number(p.total);
    });

    const ctx = getChartCtx('chartDaily');
    charts['chartDaily'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length:days}, (_,i)=>i+1),
        datasets: [{
          label: 'Ventas ($)',
          data: data,
          borderColor: '#2e7d32',
          backgroundColor: 'rgba(46,125,50,0.1)',
          fill: true, tension: 0.3
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
    });
  }

  // 3. TOP CLIENTES (SOLO USUARIO)
  function renderChartClients(orders) {
    const map = {};
    orders.forEach(p => {
      // AQUÍ ESTÁ EL CAMBIO: Usamos solo p.user, ignorando nombre_negocio
      const clientName = p.user || 'Cliente Desconocido';
      map[clientName] = (map[clientName]||0) + Number(p.total);
    });
    
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
    
    const ctx = getChartCtx('chartClients');
    charts['chartClients'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          data: sorted.map(x=>x[1]),
          backgroundColor: ['#8b5cf6','#a78bfa','#c4b5fd','#ddd6fe','#ede9fe'],
          borderWidth: 0
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{legend:{position:'right'}} }
    });
  }

  // 4. TOP PRODUCTOS (DINERO) - Lo que pediste
  function renderChartMoneyProd(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => {
         const money = Number(i.subtotal) || (Number(i.cantidad)*Number(i.precio_unitario));
         map[i.nombre] = (map[i.nombre]||0) + money;
      });
    });
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

    const ctx = getChartCtx('chartMoneyProd');
    charts['chartMoneyProd'] = new Chart(ctx, {
      type: 'bar',
      indexAxis: 'y',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          label: 'Ingresos Generados ($)',
          data: sorted.map(x=>x[1]),
          backgroundColor: '#10b981',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  // 5. TOP PRODUCTOS (CANTIDAD)
  function renderChartQtyProd(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => map[i.nombre] = (map[i.nombre]||0) + Number(i.cantidad));
    });
    const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

    const ctx = getChartCtx('chartQtyProd');
    charts['chartQtyProd'] = new Chart(ctx, {
      type: 'bar',
      indexAxis: 'y',
      data: {
        labels: sorted.map(x=>x[0]),
        datasets: [{
          label: 'Unidades Vendidas',
          data: sorted.map(x=>x[1]),
          backgroundColor: '#3b82f6',
          borderRadius: 4
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  // 6. STOCK (Independiente del filtro de mes)
  function renderChartStock() {
    let ok=0, low=0, out=0;
    allProductos.forEach(p => {
      const s = Number(p.stock)||0;
      if(s<=0) out++;
      else if(s<10) low++;
      else ok++;
    });

    const ctx = getChartCtx('chartStock');
    charts['chartStock'] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Normal','Bajo','Agotado'],
        datasets: [{
          data: [ok, low, out],
          backgroundColor: ['#dcfce7','#ffedd5','#fee2e2'],
          borderColor: ['#166534','#9a3412','#991b1b'],
          borderWidth: 1
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
    });
  }

  // --- TABLAS ---
  function renderTable(orders) {
    const map = {};
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => {
        if(!map[i.id]) map[i.id] = { nombre: i.nombre, cant: 0, total: 0 };
        map[i.id].cant += Number(i.cantidad);
        map[i.id].total += (Number(i.subtotal) || (Number(i.cantidad)*Number(i.precio_unitario)));
      });
    });

    const list = Object.values(map).map(i => {
      const prod = allProductos.find(p => p.nombre === i.nombre) || { stock:0, precio:0 };
      return { ...i, stock: Number(prod.stock), precio: Number(prod.precio) };
    }).sort((a,b) => b.total - a.total);

    const tbody = document.querySelector('#mainTable tbody');
    tbody.innerHTML = '';
    
    list.forEach(p => {
      let badge = `<span class="badge badge-ok">OK</span>`;
      if(p.stock<=0) badge = `<span class="badge badge-out">AGOTADO</span>`;
      else if(p.stock<10) badge = `<span class="badge badge-low">BAJO</span>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${p.nombre}</b></td>
        <td>${p.cant}</td>
        <td>${moneyFmt.format(p.total)}</td>
        <td>${moneyFmt.format(p.precio)}</td>
        <td>${p.stock}</td>
        <td>${badge}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderBones(orders) {
    const soldNames = new Set();
    orders.forEach(p => {
      const items = parseItems(p.items);
      items.forEach(i => soldNames.add(i.nombre));
    });
    const bones = allProductos.filter(p => !soldNames.has(p.nombre));
    const ul = document.getElementById('boneList');
    ul.innerHTML = '';
    if(bones.length === 0) { ul.innerHTML = '<li>Todo se ha vendido al menos una vez.</li>'; return; }
    bones.forEach(b => {
      const li = document.createElement('li');
      li.textContent = `${b.nombre} (Stock: ${b.stock})`;
      ul.appendChild(li);
    });
  }

  // --- UTILS ---
  function checkChurn() {
    const lastBuy = {};
    const limit = new Date(); 
    limit.setDate(limit.getDate()-30);
    
    allPedidos.forEach(p => {
      const u = p.user; // Solo usuario
      const d = new Date(p.fecha);
      if(u && (!lastBuy[u] || d > lastBuy[u])) lastBuy[u] = d;
    });

    const list = [];
    Object.entries(lastBuy).forEach(([u, date]) => {
      if(date < limit) list.push({ user: u, days: Math.floor((new Date()-date)/(86400000)) });
    });
    list.sort((a,b)=>b.days-a.days);

    if(list.length>0) {
      document.getElementById('churnAlert').classList.add('visible');
      const ul = document.getElementById('churnList');
      list.slice(0,10).forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.user} (Hace ${r.days} días)`;
        ul.appendChild(li);
      });
    }
  }

  function parseItems(items) {
    return Array.isArray(items) ? items : JSON.parse(items || '[]');
  }

  function filtrarTabla() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#mainTable tbody tr');
    rows.forEach(r => {
      r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  }

  function exportarExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'), { sheet:"Ventas" });
    XLSX.writeFile(wb, 'Reporte_Funaz.xlsx');
  }
</script>
</body>
</html>
