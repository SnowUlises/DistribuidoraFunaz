<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funaz Intelligence - BI Panel</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --primary: #1a1a1a;
      --accent: #2e7d32; /* Verde Funaz */
      --accent-light: #4caf50;
      --bg: #f4f5f7;
      --card-bg: #ffffff;
      --text: #333;
      --text-muted: #888;
      --border: #e0e0e0;
      --danger: #d32f2f;
      
      --sidebar-width: 300px;
    }

    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

    /* LAYOUT */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      padding: 1.5rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      z-index: 10;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }

    /* SIDEBAR FILTERS */
    .sidebar h2 { font-size: 1.2rem; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 10px; color: var(--primary); }
    
    .filter-group { margin-bottom: 2rem; }
    .filter-label { font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; display: block; }
    
    .date-range { display: flex; gap: 5px; }
    .date-range input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

    /* CLIENT FILTER COMPLEX */
    .client-filter-box {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #fafafa;
      height: 400px; /* Altura fija para scroll */
      display: flex; flex-direction: column;
    }

    .search-box {
      padding: 8px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; width: 100%; box-sizing: border-box;
    }

    .toggle-mode {
      display: flex; background: #e0e0e0; border-radius: 6px; padding: 2px; margin-bottom: 10px;
    }
    .toggle-opt {
      flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; font-weight: 600; transition: all 0.2s;
    }
    .toggle-opt.active.whitelist { background: var(--accent); color: white; }
    .toggle-opt.active.blacklist { background: var(--danger); color: white; }

    .client-list {
      flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;
    }
    .client-item {
      display: flex; align-items: center; gap: 8px; font-size: 0.9rem; padding: 4px; cursor: pointer; border-radius: 4px;
    }
    .client-item:hover { background: #eee; }
    .client-item input { cursor: pointer; }

    /* BUTTONS */
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text); }

    /* DASHBOARD GRID */
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .kpi-card { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
    .kpi-val { font-size: 2rem; font-weight: 800; margin: 5px 0; color: var(--primary); }
    .kpi-label { font-size: 0.9rem; color: var(--text-muted); }

    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .chart-card { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); min-height: 350px; }
    .chart-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .chart-title { font-weight: 700; font-size: 1.1rem; }

    /* HEATMAP CSS GRID */
    .heatmap-container { display: grid; grid-template-columns: 40px repeat(24, 1fr); gap: 2px; overflow-x: auto; padding-bottom: 10px; }
    .hm-cell { height: 30px; border-radius: 3px; position: relative; }
    .hm-cell:hover::after {
      content: attr(data-val); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: black; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; pointer-events: none; white-space: nowrap; z-index: 100;
    }
    .hm-label-y { font-size: 0.7rem; color: var(--text-muted); display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; }
    .hm-label-x { grid-column-start: 2; grid-column-end: span 24; display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 5px; }

    /* Loading Overlay */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:1rem; font-weight:600;">Procesando Inteligencia...</p>
</div>

<div class="sidebar">
  <h2><span class="material-icons-round">insights</span> Analytics Pro</h2>
  
  <div class="filter-group">
    <span class="filter-label">Rango de Fechas</span>
    <div class="date-range">
      <input type="date" id="dateStart">
      <input type="date" id="dateEnd">
    </div>
  </div>

  <div class="filter-group" style="flex:1; display:flex; flex-direction:column; min-height:0;">
    <span class="filter-label">Filtro Avanzado de Clientes</span>
    
    <div class="client-filter-box">
      <div class="toggle-mode">
        <div class="toggle-opt active whitelist" id="btnWhitelist" onclick="setFilterMode('include')">
          <span class="material-icons-round" style="font-size:12px">check</span> Incluir
        </div>
        <div class="toggle-opt" id="btnBlacklist" onclick="setFilterMode('exclude')">
          <span class="material-icons-round" style="font-size:12px">block</span> Excluir
        </div>
      </div>

      <input type="text" class="search-box" id="clientSearch" placeholder="Buscar cliente..." onkeyup="renderClientList()">

      <div class="client-list" id="clientListContainer">
        </div>
      
      <div style="margin-top:10px; display:flex; gap:10px; font-size:0.8rem;">
         <a href="#" onclick="toggleAllClients(true)">Todos</a> | <a href="#" onclick="toggleAllClients(false)">Ninguno</a>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" onclick="applyFilters()">
    <span class="material-icons-round" style="vertical-align:middle">filter_alt</span> Aplicar Filtros
  </button>
  <button class="btn btn-outline" onclick="location.href='admin.txt'" style="margin-top:10px">Volver al Admin</button>
</div>

<div class="main-content">
  
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-label">Ingresos Totales (Selección)</div>
      <div class="kpi-val" id="kpiTotal">$0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Pedidos Totales</div>
      <div class="kpi-val" id="kpiCount">0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Ticket Promedio (Selección)</div>
      <div class="kpi-val" id="kpiAvg">$0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Mejor Cliente (Volumen)</div>
      <div class="kpi-val" style="font-size:1.4rem" id="kpiTopClient">--</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Evolución de Ventas</div>
        <select id="timeScale" onchange="renderTimeChart()" style="padding:4px; border-radius:4px;">
          <option value="week">Por Semana (Lun-Dom)</option>
          <option value="month">Por Mes</option>
        </select>
      </div>
      <div style="height: 300px;">
        <canvas id="chartTime"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Ventas por Categoría</div>
      </div>
      <div style="height: 300px;">
        <canvas id="chartCat"></canvas>
      </div>
    </div>
  </div>

  <div class="chart-card" style="min-height: auto;">
    <div class="chart-header">
      <div class="chart-title">
        <span class="material-icons-round" style="color:red; vertical-align:bottom;">local_fire_department</span>
        Mapa de Calor: Horarios de Compra
      </div>
      <small class="text-muted">Basado en usuarios filtrados (Ej: Solo "cliente" para ver local)</small>
    </div>
    <div class="heatmap-container" id="heatmapGrid">
      </div>
    <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.75rem; color:#888;">
      <span>00:00hs</span>
      <span>12:00hs</span>
      <span>23:00hs</span>
    </div>
  </div>

  <div class="charts-grid" style="margin-top: 2rem;">
    <div class="chart-card">
        <div class="chart-title" style="margin-bottom:1rem;">Top 10 Productos ($ Generado)</div>
        <div style="height: 300px;">
            <canvas id="chartTopProd"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-title" style="margin-bottom:1rem;">Ticket Promedio (Evolución)</div>
        <div style="height: 300px;">
            <canvas id="chartAvgTicket"></canvas>
        </div>
    </div>
  </div>

</div>

<script>
  // CONFIG
  const API_URL = 'https://distribuidorafunaz-a2o6.onrender.com/api';
  const moneyFmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });

  // STATE
  let RAW_DATA = { pedidos: [], productos: [] };
  let PROCESSED_DATA = [];
  
  // Filter State
  let filterState = {
    start: null,
    end: null,
    mode: 'include', // 'include' (whitelist) or 'exclude' (blacklist)
    selectedClients: new Set(), // Nombres de clientes seleccionados
    allClientNames: [] // Lista maestra
  };

  // CHARTS INSTANCES
  let charts = {};

  // --- INIT ---
  window.addEventListener('DOMContentLoaded', async () => {
    // Set default dates (This Month)
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('dateStart').valueAsDate = firstDay;
    document.getElementById('dateEnd').valueAsDate = now;

    await loadData();
    initClientFilter();
    applyFilters();
  });

  async function loadData() {
    try {
      const res = await fetch(`${API_URL}/analytics/dump`);
      if(!res.ok) throw new Error('Error API');
      RAW_DATA = await res.json();
      
      // Preparar lista de clientes únicos
      const names = new Set();
      RAW_DATA.pedidos.forEach(p => {
        if(p.user) names.add(p.user.trim());
      });
      filterState.allClientNames = Array.from(names).sort();
      
      // Default: Todos seleccionados para Whitelist (ver todo) o Ninguno para Blacklist (ver todo)
      // Para empezar simple: Mode 'Include' con Todos seleccionados es "Ver Todo"
      filterState.allClientNames.forEach(n => filterState.selectedClients.add(n));

      document.getElementById('loader').style.display = 'none';
    } catch(e) {
      alert("Error cargando datos: " + e.message);
    }
  }

  // --- FILTER LOGIC ---
  function initClientFilter() {
    renderClientList();
  }

  function renderClientList() {
    const container = document.getElementById('clientListContainer');
    const search = document.getElementById('clientSearch').value.toLowerCase();
    container.innerHTML = '';

    filterState.allClientNames.forEach(name => {
      if(!name.toLowerCase().includes(search)) return;

      const isChecked = filterState.selectedClients.has(name);
      
      const div = document.createElement('div');
      div.className = 'client-item';
      div.innerHTML = `
        <input type="checkbox" ${isChecked ? 'checked' : ''} value="${name}">
        <span>${name}</span>
      `;
      
      // Click event
      div.addEventListener('click', (e) => {
        // Evitar doble evento si clickea directo el checkbox
        if(e.target.tagName !== 'INPUT') {
          const cb = div.querySelector('input');
          cb.checked = !cb.checked;
          toggleClient(name, cb.checked);
        }
      });
      div.querySelector('input').addEventListener('change', (e) => {
        toggleClient(name, e.target.checked);
      });

      container.appendChild(div);
    });
  }

  function toggleClient(name, active) {
    if(active) filterState.selectedClients.add(name);
    else filterState.selectedClients.delete(name);
  }

  function toggleAllClients(active) {
    if(active) {
      filterState.allClientNames.forEach(n => filterState.selectedClients.add(n));
    } else {
      filterState.selectedClients.clear();
    }
    renderClientList();
  }

  function setFilterMode(mode) {
    filterState.mode = mode;
    document.getElementById('btnWhitelist').classList.toggle('active', mode === 'include');
    document.getElementById('btnWhitelist').classList.toggle('whitelist', mode === 'include');
    document.getElementById('btnBlacklist').classList.toggle('active', mode === 'exclude');
    document.getElementById('btnBlacklist').classList.toggle('blacklist', mode === 'exclude');
  }

  // --- CORE ENGINE ---
  function applyFilters() {
    const dStart = document.getElementById('dateStart').valueAsDate;
    const dEnd = document.getElementById('dateEnd').valueAsDate;
    
    // Ajustar fin del día
    if(dEnd) dEnd.setHours(23,59,59,999);

    PROCESSED_DATA = RAW_DATA.pedidos.filter(p => {
      // 1. Fecha
      const pDate = new Date(p.fecha);
      if(dStart && pDate < dStart) return false;
      if(dEnd && pDate > dEnd) return false;

      // 2. Cliente (Logic Whitelist/Blacklist)
      const user = p.user ? p.user.trim() : 'Invitado';
      const isSelected = filterState.selectedClients.has(user);

      if(filterState.mode === 'include') {
        return isSelected; // Solo si está en la lista
      } else {
        return !isSelected; // Solo si NO está en la lista
      }
    });

    updateDashboard();
  }

  function updateDashboard() {
    calculateKPIs();
    renderTimeChart();
    renderCategoryChart();
    renderHeatmap();
    renderTopProdChart();
    renderAvgTicketChart();
  }

  // --- CALCULATIONS & RENDERING ---

  function calculateKPIs() {
    let total = 0;
    let count = PROCESSED_DATA.length;
    let clientSales = {};

    PROCESSED_DATA.forEach(p => {
      const t = Number(p.total) || 0;
      total += t;
      const u = p.user || 'Desconocido';
      clientSales[u] = (clientSales[u] || 0) + t;
    });

    const avg = count > 0 ? total / count : 0;
    
    // Top Client
    let topClient = '--';
    let topVal = 0;
    Object.entries(clientSales).forEach(([k,v]) => {
      if(v > topVal) { topVal = v; topClient = k; }
    });

    document.getElementById('kpiTotal').textContent = moneyFmt.format(total);
    document.getElementById('kpiCount').textContent = count;
    document.getElementById('kpiAvg').textContent = moneyFmt.format(avg);
    document.getElementById('kpiTopClient').textContent = topClient;
  }

  // 1. CHART: TIME EVOLUTION
  function renderTimeChart() {
    const scale = document.getElementById('timeScale').value; // 'week' or 'month'
    const grouped = {};

    PROCESSED_DATA.forEach(p => {
        const d = new Date(p.fecha);
        let key;
        
        if (scale === 'month') {
            // Clave: "2023-01" (Año-Mes)
            key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        } else {
            // Clave: Semana ISO
            const onejan = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            key = `${d.getFullYear()}-W${String(week).padStart(2,'0')}`;
        }

        grouped[key] = (grouped[key] || 0) + Number(p.total);
    });

    // Ordenar claves cronológicamente
    const keys = Object.keys(grouped).sort();
    const values = keys.map(k => grouped[k]);

    const ctx = getCtx('chartTime');
    if(charts['time']) charts['time'].destroy();

    charts['time'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: keys,
            datasets: [{
                label: 'Ventas ($)',
                data: values,
                borderColor: '#2e7d32',
                backgroundColor: 'rgba(46,125,50,0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive:true, maintainAspectRatio:false }
    });
  }

  // 2. CHART: CATEGORÍAS
  function renderCategoryChart() {
    // Mapa rápido id -> categoria
    const prodCatMap = {};
    RAW_DATA.productos.forEach(prod => prodCatMap[prod.id] = prod.categoria || 'Sin Categoría');

    const catTotals = {};

    PROCESSED_DATA.forEach(p => {
        const items = (typeof p.items === 'string') ? JSON.parse(p.items) : p.items;
        if(Array.isArray(items)) {
            items.forEach(it => {
                const cat = prodCatMap[it.id] || 'Otros';
                // Calculamos monto aproximado del item
                const sub = (Number(it.cantidad) * Number(it.precio_unitario || 0));
                catTotals[cat] = (catTotals[cat] || 0) + sub;
            });
        }
    });

    const labels = Object.keys(catTotals);
    const data = Object.values(catTotals);

    const ctx = getCtx('chartCat');
    if(charts['cat']) charts['cat'].destroy();

    charts['cat'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0', '#607d8b']
            }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
    });
  }

  // 3. HEATMAP (Custom HTML Grid)
  function renderHeatmap() {
    // Matriz 7 dias x 24 horas
    const matrix = Array(7).fill(0).map(() => Array(24).fill(0));
    let maxVal = 0;

    PROCESSED_DATA.forEach(p => {
        const d = new Date(p.fecha);
        // getDay(): 0=Domingo ... 6=Sabado. 
        // Lo mapeamos a 0=Lunes ... 6=Domingo para mejor visualización
        let day = d.getDay() - 1; 
        if(day === -1) day = 6; 
        
        const hour = d.getHours();
        const total = Number(p.total) || 0;
        
        matrix[day][hour] += total;
        if(matrix[day][hour] > maxVal) maxVal = matrix[day][hour];
    });

    const grid = document.getElementById('heatmapGrid');
    grid.innerHTML = '';
    
    // Header labels (Hours) - Simplified
    // HTML structure: Rows are Days
    const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

    // Para la grid CSS, queremos columnas = Horas, Filas = Días
    // Primero el header de horas (opcional, o simplificado)
    
    days.forEach((dayLabel, dIdx) => {
        // Label Dia
        const lbl = document.createElement('div');
        lbl.className = 'hm-label-y';
        lbl.textContent = dayLabel;
        grid.appendChild(lbl);

        // Celdas Horas
        for(let h=0; h<24; h++) {
            const val = matrix[dIdx][h];
            const cell = document.createElement('div');
            cell.className = 'hm-cell';
            
            // Color Scale (White to Red/Green)
            const intensity = maxVal > 0 ? val / maxVal : 0;
            // Usaremos opacidad de verde
            cell.style.backgroundColor = `rgba(46, 125, 50, ${intensity * 0.9 + 0.1})`;
            if(val === 0) cell.style.backgroundColor = '#f0f0f0';
            
            cell.dataset.val = `${dayLabel} ${h}hs: ${moneyFmt.format(val)}`;
            grid.appendChild(cell);
        }
    });
  }

  // 4. CHART: TOP PRODUCTOS
  function renderTopProdChart() {
    const prodSales = {};
    PROCESSED_DATA.forEach(p => {
        const items = (typeof p.items === 'string') ? JSON.parse(p.items) : p.items;
        if(Array.isArray(items)) {
            items.forEach(it => {
                const sub = (Number(it.cantidad) * Number(it.precio_unitario || 0));
                prodSales[it.nombre] = (prodSales[it.nombre] || 0) + sub;
            });
        }
    });

    const sorted = Object.entries(prodSales).sort((a,b) => b[1] - a[1]).slice(0, 10);
    
    const ctx = getCtx('chartTopProd');
    if(charts['topProd']) charts['topProd'].destroy();

    charts['topProd'] = new Chart(ctx, {
        type: 'bar',
        indexAxis: 'y',
        data: {
            labels: sorted.map(x => x[0]),
            datasets: [{
                label: 'Ingresos ($)',
                data: sorted.map(x => x[1]),
                backgroundColor: '#1976d2',
                borderRadius: 4
            }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }

  // 5. CHART: AVG TICKET EVOLUCION
  function renderAvgTicketChart() {
    const grouped = {}; // Key: Month, Val: {total:0, count:0}

    PROCESSED_DATA.forEach(p => {
        const d = new Date(p.fecha);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        
        if(!grouped[key]) grouped[key] = {total:0, count:0};
        grouped[key].total += Number(p.total);
        grouped[key].count += 1;
    });

    const keys = Object.keys(grouped).sort();
    const avgs = keys.map(k => grouped[k].count ? grouped[k].total / grouped[k].count : 0);

    const ctx = getCtx('chartAvgTicket');
    if(charts['avgTick']) charts['avgTick'].destroy();

    charts['avgTick'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: keys,
            datasets: [{
                label: 'Ticket Promedio ($)',
                data: avgs,
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: { responsive:true, maintainAspectRatio:false }
    });
  }

  function getCtx(id) {
    return document.getElementById(id).getContext('2d');
  }
</script>

</body>
</html>
