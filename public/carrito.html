<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Carrito - Distribuidora Funaz</title>
  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --danger: #e57373;
      --text-dark: #333;
      --text-grey: #666;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif; 
      margin: 0; 
      background: var(--bg-color); 
      color: var(--text-dark); 
      padding-bottom: 160px; /* Espacio para el footer flotante */
    }

    /* HEADER */
    header {
      background: var(--primary-green);
      color: var(--white);
      padding: 1em;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: space-between;
    }
    .btn-volver {
      background: rgba(255,255,255,0.2); color: white; border: none;
      padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
      text-decoration: none; font-size: 0.9em; display: flex; align-items: center; gap: 5px;
    }
    h1 { margin: 0; font-size: 1.2em; font-weight: 600; }

    main { max-width: 800px; margin: auto; padding: 1.5em; }

    /* LISTA PRODUCTOS */
    #listaCarrito { display: flex; flex-direction: column; gap: 1em; margin-bottom: 2em; }

    .producto-card {
      background: var(--white);
      border-radius: 16px;
      padding: 1em;
      display: flex;
      gap: 1em;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      border: 1px solid #f0f0f0;
    }
    
    .producto-card img {
      width: 70px; height: 70px;
      object-fit: cover;
      border-radius: 10px;
      background: #f9f9f9;
      flex-shrink: 0;
    }

    .producto-info { flex: 1; }
    .producto-info h3 { margin: 0 0 5px 0; font-size: 1em; color: var(--text-dark); }
    .producto-info p { margin: 2px 0; font-size: 0.85em; color: var(--text-grey); }
    .producto-info .subtotal { font-weight: bold; color: var(--primary-green); margin-top: 4px; font-size: 0.95em; }

    /* CONTROLES CANTIDAD */
    .controles-cantidad {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .stepper {
      display: flex;
      align-items: center;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 3px;
    }
    .stepper button {
      width: 30px; height: 30px;
      background: var(--white); border: none;
      border-radius: 6px;
      font-weight: bold; color: var(--primary-green);
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stepper span {
      width: 30px; text-align: center;
      font-weight: 600; font-size: 0.9em;
    }

    .btn-eliminar-item {
      background: #ffebee; color: var(--danger);
      border: none; border-radius: 6px;
      width: 100%; padding: 4px; font-size: 0.8em; font-weight: bold; cursor: pointer;
    }

    /* SECCION OPCIONES (CLIENTE) */
    .opciones-container {
      background: var(--white);
      border-radius: 16px;
      padding: 1.5em;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      border: 1px solid #f0f0f0;
      margin-bottom: 2em;
    }

    .input-group { margin-bottom: 1em; }
    
    /* Estilos generales inputs/selects */
    input[type="text"], select {
      width: 100%; padding: 12px;
      border: 1px solid #ddd; border-radius: 10px;
      outline: none; font-size: 1em; transition: border 0.2s;
      background: #fafafa;
    }
    input[type="text"]:focus, select:focus { border-color: var(--light-green); background: white; }

    .checkbox-wrapper {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; background: #f9f9f9; border-radius: 10px;
      cursor: pointer; user-select: none;
    }
    input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary-green); }

    /* FOOTER FLOTANTE ACCIONES */
    .acciones-fixed {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--white);
      padding: 1.5em;
      border-top: 1px solid #eee;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      z-index: 90;
      display: flex; flex-direction: column; gap: 10px;
      max-width: 800px; margin: 0 auto;
    }

    .btn-primary {
      background: var(--primary-green); color: white;
      border: none; padding: 14px; border-radius: 12px;
      font-size: 1.1em; font-weight: bold; cursor: pointer;
      width: 100%; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
      transition: background 0.2s;
    }
    .btn-primary:hover { background: #1b5e20; }

    .btn-secondary {
      background: white; color: var(--primary-green);
      border: 2px solid var(--primary-green);
      padding: 12px; border-radius: 12px;
      font-size: 1em; font-weight: bold; cursor: pointer;
      width: 100%;
    }

    /* MODAL CONFIRMACION */
    #formOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
      display: none; justify-content: center; align-items: center;
      z-index: 10000;
    }
    #formDatos {
      background: var(--white); padding: 2em; border-radius: 20px;
      max-width: 350px; width: 90%; text-align: center; position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #formDatos h3 { margin-top: 0; color: var(--primary-green); }
    
    #btnCerrarFormulario {
      position: absolute; top: 10px; right: 10px;
      background: #f5f5f5; border: none; color: #666;
      width: 30px; height: 30px; border-radius: 50%;
      font-weight: bold; cursor: pointer; font-size: 1.2em;
    }

    footer { text-align: center; color: #999; font-size: 0.9em; margin-top: 2em; display: none; } /* Oculto footer en movil por la barra fija */
    @media (min-width: 800px) {
      .acciones-fixed { position: static; border: 1px solid #eee; border-radius: 16px; padding: 2em; margin-top: 2em; }
      body { padding-bottom: 0; }
      footer { display: block; }
    }
  </style>
</head>
<body>
  
  <header>
    <button onclick="location.href='index.html'" class="btn-volver">â¬… Volver</button>
    <h1>Mi Carrito</h1>
    <div style="width:60px"></div>
  </header>

  <main>
    <div id="modeBanner" style="display:none" class="mode-banner"></div>
    
    <div id="listaCarrito"></div>

    <div class="opciones-container" id="opcionesContainer">
        <h3 style="margin-top:0; font-size:1em; color:var(--text-grey);">Datos del Cliente</h3>
        
        <div class="input-group">
            <label style="font-size:0.85em; color:#666; display:block; margin-bottom:5px;">Seleccionar Cliente (Opcional):</label>
            <select id="selectorCliente">
                <option value="">-- Cliente Manual / Nuevo --</option>
            </select>
        </div>

        <div class="input-group">
            <input type="text" id="nombreCliente" placeholder="Nombre del cliente" />
        </div>

        <label class="checkbox-wrapper" style="margin-bottom:1em">
            <input type="checkbox" id="clienteRegular">
            <span>Cliente regular (3% OFF)</span>
        </label>

        <div class="input-group" style="margin-bottom:0">
            <input type="text" id="nombreNegocio" placeholder="Nombre del Negocio (Opcional)" />
        </div>
    </div>

    <div class="acciones-fixed">
        <button id="btnMostrarFormulario" class="btn-primary">Enviar Pedido</button>
        <button id="btnGenerarTicket" class="btn-secondary">ðŸ“„ Generar Ticket PDF</button>
    </div>

    <div id="formOverlay">
      <div id="formDatos">
        <button type="button" id="btnCerrarFormulario">&times;</button>
        <h3>Confirmar Pedido</h3>
        <p style="color:#666;">Â¿EstÃ¡s seguro de enviar este pedido?</p>
        
        <div id="totalPedido" style="font-size:1.5em; font-weight:bold; color:var(--text-dark); margin: 15px 0;"></div>
        <div id="sinStockAviso" style="color:var(--danger); font-size:0.9em; margin-bottom:15px; font-weight:bold;"></div>
        
        <button class="btn-primary" id="confirmarEnvio">SÃ­, enviar</button>
        <div id="postActions" style="margin-top:10px;"></div>
      </div>
    </div>
  </main>

  <footer>
    Distribuidora Funaz
  </footer>

<script>
let productos = [];
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
const usuario = { user: localStorage.getItem('loggedUser') || 'invitado' };

const lista = document.getElementById('listaCarrito');
const formOverlay = document.getElementById('formOverlay');
const btnMostrarFormulario = document.getElementById('btnMostrarFormulario');
const btnCerrarFormulario = document.getElementById('btnCerrarFormulario');
const totalPedido = document.getElementById('totalPedido');
const btnConfirmar = document.getElementById('confirmarEnvio');
const postActions = document.getElementById('postActions');
const sinStockAviso = document.getElementById('sinStockAviso');
const btnGenerarTicket = document.getElementById('btnGenerarTicket');
const opcionesContainer = document.getElementById('opcionesContainer');

const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

// FunciÃ³n helper para formato moneda
function formatMoney(n) {
  try { return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(n); }
  catch(e){ return '$' + Number(n).toFixed(2); }
}

async function cargarProductos() {
  try {
    const r = await fetch(`${apiBase}/productos`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    productos = await r.json();
    renderizarCarrito();
  } catch (err) {
    lista.innerHTML = '<p style="text-align:center">Error cargando productos.</p>';
    console.error(err);
  }
}

// --- NUEVA FUNCIÃ“N: CARGAR CLIENTES ---
async function cargarListaClientes() {
    try {
        const r = await fetch(`${apiBase}/lista-clientes`);
        if (!r.ok) return; // Si falla, seguimos en modo manual sin error visual
        const clientes = await r.json();
        
        const selector = document.getElementById('selectorCliente');
        const inputNombre = document.getElementById('nombreCliente');

        // Llenar select
        clientes.forEach(c => {
            if (!c.name) return;
            const opt = document.createElement('option');
            opt.value = c.user_id; // Guardamos el user_id
            opt.textContent = c.name;
            selector.appendChild(opt);
        });

        // Evento cambio
        selector.addEventListener('change', () => {
            const idx = selector.selectedIndex;
            if (idx > 0) {
                // Si seleccionÃ³ alguien, rellenamos el nombre
                inputNombre.value = selector.options[idx].textContent;
            } else {
                // Si vuelve a manual
                // No borramos el nombre obligatoriamente, pero quitamos la asociaciÃ³n ID
            }
        });
    } catch (err) {
        console.error("Error cargando clientes:", err);
    }
}

function guardarCarrito() {
  localStorage.setItem('carrito', JSON.stringify(carrito));
}

function renderizarCarrito() {
  lista.innerHTML = '';
  postActions.innerHTML = '';
  sinStockAviso.textContent = '';

  if (carrito.length === 0) {
    lista.innerHTML = '<div style="text-align:center; padding:3em; color:#999;">ðŸ›’<br><br>Tu carrito estÃ¡ vacÃ­o.</div>';
    btnMostrarFormulario.style.display = 'none';
    btnGenerarTicket.style.display = 'none';
    opcionesContainer.style.display = 'none';
    ocultarFormulario();
    return;
  }
  btnMostrarFormulario.style.display = 'block';
  btnGenerarTicket.style.display = 'block';
  opcionesContainer.style.display = 'block';

  carrito.forEach((item, i) => {
    const p = productos.find(prod => prod.id == item.id);
    if (!p) return;

    const div = document.createElement('div');
    div.className = 'producto-card';
    const precioPublico = (Number(p.precio || 0) * 1.10);

    div.innerHTML = `
      <img src="/imagenes/${p.id}.png" alt="${(p.nombre||'').replace(/"/g,'')}" onerror="this.onerror=null; this.src='/imagenes/placeholder.png'"/>
      <div class="producto-info">
        <h3>${p.nombre}</h3>
        <p>Unitario: ${formatMoney(precioPublico)}</p>
        <p class="subtotal">Subtotal: ${formatMoney(precioPublico * item.cantidad)}</p>
      </div>
      <div class="controles-cantidad">
        <div class="stepper">
            <button class="btn-aumentar">+</button>
            <span class="cantidad-display">${item.cantidad}</span>
            <button class="btn-reducir">-</button>
        </div>
        <button class="btn-eliminar-item btn-eliminar">Eliminar</button>
      </div>
    `;

    const btnAumentar = div.querySelector('.btn-aumentar');
    const btnReducir = div.querySelector('.btn-reducir');
    const btnEliminar = div.querySelector('.btn-eliminar');
    const cantidadDisplay = div.querySelector('.cantidad-display');

    btnAumentar.addEventListener('click', (e) => {
      e.stopPropagation();
      const prod = productos.find(pr => pr.id == item.id);
      carrito[i].cantidad++;
      guardarCarrito();
      cantidadDisplay.textContent = carrito[i].cantidad;
      renderizarCarrito();
    });

    btnReducir.addEventListener('click', (e) => {
      e.stopPropagation();
      if (carrito[i].cantidad > 1) carrito[i].cantidad--;
      else carrito.splice(i, 1);
      guardarCarrito();
      renderizarCarrito();
    });

    btnEliminar.addEventListener('click', (e) => {
      e.stopPropagation();
      carrito.splice(i, 1);
      guardarCarrito();
      renderizarCarrito();
    });

    lista.appendChild(div);
  });
}

function mostrarFormulario() {
  let total = carrito.reduce((acc, item) => {
    const p = productos.find(prod => prod.id == item.id);
    const precioPublico = p ? Number(p.precio || 0) * 1.10 : 0;
    return acc + (precioPublico * item.cantidad);
  }, 0);

  const esRegular = document.getElementById('clienteRegular').checked;
  if (esRegular) total *= 0.97;

  totalPedido.textContent = formatMoney(total);
  formOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function ocultarFormulario() {
  formOverlay.style.display = 'none';
  document.body.style.overflow = '';
}

btnMostrarFormulario.addEventListener('click', mostrarFormulario);
btnCerrarFormulario.addEventListener('click', ocultarFormulario);
formOverlay.addEventListener('click', e => { if (e.target === formOverlay) ocultarFormulario(); });

// --- LÃ“GICA DE ENVÃO MODIFICADA ---
btnConfirmar.addEventListener('click', async () => {
  btnConfirmar.disabled = true;
  btnConfirmar.textContent = 'Procesando...';

  const nuevosCarrito = [];
  const productosClon = productos.map(p => ({...p}));

  for (const item of carrito) {
    const producto = productosClon.find(p => p.id == item.id);
    if (!producto) continue;

    if (typeof producto.stock === 'number') {
      producto.stock = producto.stock - item.cantidad;
    }

    let precioConRecargo = Number(producto.precio) * 1.10;
    const esRegular = document.getElementById('clienteRegular').checked;
    if (esRegular) precioConRecargo *= 0.97;

    nuevosCarrito.push({
      ...item,
      precio: precioConRecargo
    });
  }

  if (nuevosCarrito.length === 0) {
    alert('No hay productos disponibles para pedir.');
    btnConfirmar.disabled = false;
    btnConfirmar.textContent = 'SÃ­, enviar';
    return;
  }
  
  // Capturamos datos
  const nombreInput = document.getElementById('nombreCliente');
  const nombreCliente = nombreInput.value.trim() || 'cliente';
  const nombreNegocio = document.getElementById('nombreNegocio').value.trim(); // NUEVO
  const userId = document.getElementById('selectorCliente').value || null; // NUEVO
  
  try {
    const res = await fetch(`${apiBase}/guardar-pedidos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pedido: nuevosCarrito,
        user: nombreCliente,
        user_id: userId,          // Enviar ID
        nombre_negocio: nombreNegocio // Enviar Negocio
      })
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || `HTTP ${res.status}`);
    }

    alert('Pedido enviado y stock actualizado en el servidor.');
    carrito = [];
    guardarCarrito();
    ocultarFormulario();
    renderizarCarrito();
    
    // Resetear formulario visual
    document.getElementById('selectorCliente').selectedIndex = 0;
    document.getElementById('nombreNegocio').value = '';
    
  } catch (err) {
    console.error('Error enviando pedido:', err);
    alert('No se pudo enviar el pedido al servidor. Revisa la consola.');
  } finally {
    btnConfirmar.disabled = false;
    btnConfirmar.textContent = 'SÃ­, enviar';
    window.location.href = 'index.html';
  }
});

async function generarTicket() {
  const esRegular = document.getElementById('clienteRegular').checked;
  const nombreCliente = document.getElementById('nombreCliente').value.trim() || 'Cliente';
  const nombreNegocio = document.getElementById('nombreNegocio').value.trim(); // NUEVO
  
  const items = [];
  let total = 0;

  for (const item of carrito) {
    const p = productos.find(prod => prod.id == item.id);
    if (!p) continue;

    const factorDescuento = esRegular ? 0.97 : 1;
    const precioUnitarioEnviado = Number(p.precio) * factorDescuento * 1.1;
    const subtotal = item.cantidad * (precioUnitarioEnviado * 1.1);
    total += subtotal;

    items.push({
      id: item.id,
      nombre: p.nombre,
      cantidad: item.cantidad,
      precio_unitario: precioUnitarioEnviado,
      subtotal: subtotal 
    });
  }

  if (items.length === 0) {
    alert('Carrito vacÃ­o');
    return;
  }

  const payload = {
    user: nombreCliente,
    items,
    total,
    fecha: new Date().toISOString(),
    nombre_negocio: nombreNegocio // NUEVO para el PDF
  };

  try {
    const res = await fetch(`${apiBase}/generar-pdf-peticion`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      throw new Error(txt || `HTTP ${res.status}`);
    }

    const data = await res.json();
    if (data.ok && data.pdf) {
      window.open(data.pdf, '_blank');
    } else {
      alert('Error generando el ticket');
    }
  } catch (err) {
    console.error('Error generando ticket:', err);
    alert('No se pudo generar el ticket: ' + err.message);
  }
}

btnGenerarTicket.addEventListener('click', generarTicket);

// iniciar
(async function init(){
  await cargarProductos();
  await cargarListaClientes(); // Cargamos clientes al inicio
})();
</script>
</body>
</html>
