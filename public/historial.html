<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Historial de Stock - Distribuidora Funaz</title>
  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --soft-green: #E8F5E9;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --text-dark: #333;
      --text-grey: #666;
      --danger: #e57373;
      --danger-bg: #ffebee;
      --warning: #fbc02d;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }

    /* HEADER */
    header {
      background: var(--primary-green); color: var(--white);
      padding: 1em; position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 1.2em; font-weight: 600; }
    .btn-volver { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 0.9em; display:flex; gap:5px; align-items:center; }

    /* FILTROS */
    .filtros {
      display: flex; gap: 10px; padding: 1em; 
      overflow-x: auto; white-space: nowrap;
      background: var(--white); border-bottom: 1px solid #eee;
    }
    .filtros button {
      padding: 8px 16px; border: 1px solid #ddd; background: var(--white);
      border-radius: 20px; color: var(--text-grey); font-weight: 500; cursor: pointer;
      transition: all 0.2s;
    }
    .filtros button.active {
      background: var(--soft-green); border-color: var(--primary-green); color: var(--primary-green); font-weight: bold;
    }

    /* CONTENEDOR PRINCIPAL */
    main { max-width: 800px; margin: 0 auto; padding: 1em; }

    /* GRUPO DE FECHA */
    .fecha-grupo { margin-bottom: 2em; }
    .fecha-header {
      font-size: 0.9em; text-transform: uppercase; color: var(--text-grey);
      margin-bottom: 10px; font-weight: bold; letter-spacing: 1px;
      border-bottom: 2px solid #eee; padding-bottom: 5px;
    }

    /* TARJETA DE MOVIMIENTO */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 1em;
      margin-bottom: 10px;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      display: flex; flex-direction: column; gap: 8px;
      position: relative;
      transition: transform 0.2s;
    }
    
    /* ESTADO ALERTA (Gap detectado) */
    .card.alert {
      border: 1px solid var(--danger);
      background: var(--danger-bg);
    }
    /* ESTADO OK */
    .card.ok { border-left: 4px solid var(--light-green); }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .prod-nombre { font-weight: bold; font-size: 1.1em; color: var(--text-dark); }
    .hora { font-size: 0.8em; color: var(--text-grey); }

    .card-body { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
    
    .stock-flow {
      display: flex; align-items: center; gap: 8px;
      font-family: monospace; font-size: 1.1em; color: #555;
    }
    .arrow { color: #999; }
    .cambio-badge {
      padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em;
    }
    .negativo { background: #ffebee; color: #d32f2f; }
    .positivo { background: #e8f5e9; color: #2e7d32; }

    .tipo-mov { font-size: 0.75em; padding: 3px 6px; border-radius: 4px; background: #eee; color: #666; }

    /* BOTON ARREGLAR */
    .btn-fix {
      margin-top: 10px; width: 100%;
      background: var(--danger); color: white; border: none;
      padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 5px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.85; } 100% { opacity: 1; } }

    .alert-msg { font-size: 0.85em; color: #c62828; margin-top: 5px; font-style: italic; }

  </style>
</head>
<body>

  <header>
    <a href="admin.html" class="btn-volver">⬅ Admin</a>
    <h1>Historial de Stock</h1>
    <div style="width: 30px;"></div>
  </header>

  <div class="filtros">
    <button class="active" onclick="filtrar('dia', this)">Por Día</button>
    <button onclick="filtrar('semana', this)">Semana</button>
    <button onclick="filtrar('mes', this)">Mes</button>
    <button onclick="filtrar('anio', this)">Año</button>
  </div>

  <main id="contenedorHistorial">
    <p style="text-align:center; color:#999; margin-top:2em;">Cargando movimientos...</p>
  </main>

<script>
let historialCompleto = [];
let filtroActual = 'dia';

async function cargarHistorial() {
  try {
    const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/historial');
    if (!res.ok) throw new Error('Error al cargar');
    historialCompleto = await res.json();
    renderizar();
  } catch (err) {
    document.getElementById('contenedorHistorial').innerHTML = '<p style="text-align:center; color:red">Error cargando datos.</p>';
    console.error(err);
  }
}

function filtrar(tipo, btn) {
  filtroActual = tipo;
  document.querySelectorAll('.filtros button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderizar();
}

function formatearFecha(fechaStr) {
  const d = new Date(fechaStr);
  if (filtroActual === 'dia') return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
  if (filtroActual === 'semana') {
    const startOfWeek = new Date(d);
    startOfWeek.setDate(d.getDate() - d.getDay());
    return `Semana del ${startOfWeek.toLocaleDateString()}`;
  }
  if (filtroActual === 'mes') return d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  return d.getFullYear();
}

function renderizar() {
  const container = document.getElementById('contenedorHistorial');
  container.innerHTML = '';

  if (historialCompleto.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#999">No hay movimientos registrados.</p>';
    return;
  }

  // 1. Agrupar por fecha segun filtro
  const grupos = {};
  historialCompleto.forEach(item => {
    const key = formatearFecha(item.fecha);
    if (!grupos[key]) grupos[key] = [];
    grupos[key].push(item);
  });

  // 2. Analisis de "Saltos Mágicos" (Red Flags)
  // Necesitamos agrupar por PRODUCTO y ordenar cronológicamente para detectar saltos
  const movimientosPorProducto = {};
  // Ordenamos cronológicamente ASCENDENTE para el cálculo matemático
  const historialOrdenado = [...historialCompleto].sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
  
  const mapaDeErrores = {}; // ID_HISTORIAL -> true/false

  historialOrdenado.forEach(mov => {
    if (!movimientosPorProducto[mov.producto_id]) {
      movimientosPorProducto[mov.producto_id] = mov; // Primer movimiento, no podemos comparar
    } else {
      const anterior = movimientosPorProducto[mov.producto_id];
      // Logica Clave: El stock final del anterior DEBE ser igual al stock inicial del actual.
      // Stock Inicial Actual = Stock Nuevo - Cambio
      // Ejemplo: Vendi 1, quedo en 7. Stock inicial era 8.
      // Anterior quedo en 9. 9 != 8 -> ERROR.
      
      const stockInicialActual = mov.stock_nuevo - mov.cantidad_cambio;
      
      // Margen de error 0.
      if (anterior.stock_nuevo !== stockInicialActual) {
        if (!mov.revisado) { // Si ya le diste "Arreglar", ignoramos
             mapaDeErrores[mov.id] = true;
        }
      }
      movimientosPorProducto[mov.producto_id] = mov;
    }
  });


  // 3. Renderizar Grupos
  Object.keys(grupos).forEach(fechaHeader => {
    const divGrupo = document.createElement('div');
    divGrupo.className = 'fecha-grupo';
    divGrupo.innerHTML = `<div class="fecha-header">${fechaHeader}</div>`;

    grupos[fechaHeader].forEach(item => {
      const esError = mapaDeErrores[item.id];
      const cambioTexto = item.cantidad_cambio > 0 ? `+${item.cantidad_cambio}` : `${item.cantidad_cambio}`;
      const claseColor = item.cantidad_cambio > 0 ? 'positivo' : 'negativo';
      const hora = new Date(item.fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const card = document.createElement('div');
      card.className = `card ${esError ? 'alert' : 'ok'}`;
      
      let htmlBotones = '';
      if (esError) {
        htmlBotones = `
            <div class="alert-msg">⚠ Salto de stock detectado (DB editada manualmente)</div>
            <button class="btn-fix" onclick="arreglar(${item.id})">✅ Ya lo vi (Arreglar)</button>
        `;
      }

      card.innerHTML = `
        <div class="card-header">
          <div class="prod-nombre">${item.producto_nombre}</div>
          <div class="hora">${hora}</div>
        </div>
        <div class="card-body">
          <div class="stock-flow">
            <span>${item.stock_anterior}</span>
            <span class="arrow">➝</span>
            <span>${item.stock_nuevo}</span>
          </div>
          <div class="cambio-badge ${claseColor}">${cambioTexto}</div>
        </div>
        <div style="margin-top:5px; display:flex; justify-content:space-between;">
           <span class="tipo-mov">${item.tipo_movimiento.replace('_', ' ')}</span>
        </div>
        ${htmlBotones}
      `;
      divGrupo.appendChild(card);
    });

    container.appendChild(divGrupo);
  });
}

async function arreglar(id) {
  if(!confirm("¿Marcar este salto como revisado? Desaparecerá la alerta roja.")) return;
  
  try {
    const res = await fetch(`https://distribuidorafunaz-a2o6.onrender.com/api/historial-check/${id}`, { method: 'PUT' });
    if (res.ok) {
        // Actualizamos localmente para no recargar toda la pagina y que sea rapido
        const item = historialCompleto.find(i => i.id == id);
        if(item) item.revisado = true;
        renderizar();
    }
  } catch (err) {
    alert("Error al conectar con servidor");
  }
}

// Iniciar
cargarHistorial();
</script>

</body>
</html>
