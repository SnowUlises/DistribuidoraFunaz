<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Historial de Stock - Distribuidora Funaz</title>
  <style>
    /* ... (ESTILOS ORIGINALES MANTENIDOS) ... */
    :root { --primary-green: #2E7D32; --light-green: #4CAF50; --soft-green: #E8F5E9; --bg-color: #fcfdfc; --white: #ffffff; --text-dark: #333; --text-grey: #666; --orange: #ff9800; --orange-bg: #fff3e0; --orange-border: #ffb74d; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }
    header { background: var(--primary-green); color: var(--white); padding: 1em; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 1.2em; font-weight: 600; }
    .btn-volver { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 0.9em; display:flex; gap:5px; align-items:center; }
    .controles-superiores { padding: 10px 1em; background: var(--white); display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #f0f0f0; }
    .fila-controles { display: flex; gap: 10px; align-items: center; justify-content: space-between; width: 100%; }
    .buscador-container { flex-grow: 1; }
    .input-buscador { width: 100%; padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 0.95em; }
    .input-buscador:focus { border-color: var(--primary-green); }
    .btn-check { background: var(--text-dark); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.85em; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
    .btn-check:active { transform: scale(0.95); }
    .toggle-orange { display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: #e65100; font-weight: bold; cursor: pointer; }
    .toggle-orange input { accent-color: var(--orange); transform: scale(1.2); }
    .filtros { display: flex; gap: 10px; padding: 10px 1em; overflow-x: auto; white-space: nowrap; background: var(--white); border-bottom: 1px solid #eee; }
    .filtros button { padding: 6px 14px; border: 1px solid #ddd; background: var(--white); border-radius: 20px; color: var(--text-grey); font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.9em; }
    .filtros button.active { background: var(--soft-green); border-color: var(--primary-green); color: var(--primary-green); font-weight: bold; }
    main { max-width: 800px; margin: 0 auto; padding: 1em; }
    .fecha-grupo { margin-bottom: 2em; }
    .fecha-header { font-size: 0.9em; text-transform: uppercase; color: var(--text-grey); margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    .card { background: var(--white); border-radius: 12px; padding: 1em; margin-bottom: 10px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 8px; }
    .card.normal { border-left: 4px solid var(--light-green); }
    .card.ajuste { border-left: 4px solid var(--orange); background: var(--orange-bg); border-color: var(--orange-border); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .prod-nombre { font-weight: bold; font-size: 1.1em; color: var(--text-dark); }
    .hora { font-size: 0.8em; color: var(--text-grey); }
    .card-body { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
    .stock-flow { display: flex; align-items: center; gap: 8px; font-family: monospace; font-size: 1.1em; color: #555; }
    .arrow { color: #999; }
    .cambio-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; }
    .negativo { background: #ffebee; color: #d32f2f; }
    .positivo { background: #e8f5e9; color: #2e7d32; }
    .neutro { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
    .tipo-mov { font-size: 0.75em; padding: 3px 6px; border-radius: 4px; background: #eee; color: #666; }
    .btn-cargar-mas { display: block; width: 100%; max-width: 300px; margin: 20px auto; padding: 12px; background: var(--white); border: 1px solid var(--primary-green); color: var(--primary-green); font-weight: bold; border-radius: 25px; cursor: pointer; transition: all 0.2s; }
    .btn-cargar-mas:hover { background: var(--soft-green); }
    
    /* Indicador de carga flotante */
    #loadingIndicator {
        position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: white; padding: 8px 16px;
        border-radius: 20px; font-size: 0.85em; z-index: 999; display: none;
    }
  </style>
</head>
<body>

  <header>
    <a href="admin.html" class="btn-volver">‚¨Ö Admin</a>
    <h1>Historial de Stock</h1>
    <div style="width: 30px;"></div>
  </header>

  <div id="loadingIndicator">‚è≥ Cargando datos...</div>

  <div class="controles-superiores">
    <div class="fila-controles">
        <div class="buscador-container">
            <input type="text" id="buscador" class="input-buscador" placeholder="üîç Buscar producto..." onkeyup="renderizar()">
        </div>
        <button class="btn-check" onclick="forzarCheck()">‚Üª Check Ahora</button>
    </div>
    <div class="fila-controles">
        <label class="toggle-orange">
            <input type="checkbox" id="checkManual" onchange="renderizar()">
            Solo Ajustes DB
        </label>
    </div>
  </div>

  <div class="filtros">
    <button class="active" onclick="filtrar('dia', this)">Por D√≠a</button>
    <button onclick="filtrar('semana', this)">Semana</button>
    <button onclick="filtrar('mes', this)">Mes</button>
    <button onclick="filtrar('anio', this)">A√±o</button>
  </div>

  <main id="contenedorHistorial">
    <p style="text-align:center; color:#999; margin-top:2em;">Iniciando...</p>
  </main>
  
  <div style="text-align: center; margin-bottom: 50px;">
      <button id="btnServerLoad" onclick="cargarMasAntiguedad()" style="
        background: #333; color: white; border: none; 
        padding: 12px 20px; border-radius: 25px; 
        cursor: pointer; font-weight: bold; display: none;">
        üìÇ Descargar 15 d√≠as anteriores
      </button>
  </div>

<script>
// VARIABLES GLOBALES
let historialDB = [];          
let filtroActual = 'dia';
let limiteVisual = 50; 

// Control de Fechas (Para paginaci√≥n segura)
let fechaLimiteSuperior = new Date(); // La fecha m√°s reciente cargada
let fechaLimiteInferior = new Date(); // La fecha m√°s antigua cargada

// CONSTANTES DE SEGURIDAD
const DIAS_POR_LOTE = 5; // Pedimos de 5 en 5 d√≠as para no superar los 1000 registros

// --- 1. INICIO ---
async function iniciar() {
    // Inicializamos: Queremos cargar los √∫ltimos 30 d√≠as inicialmente
    // Pero lo haremos en bucle para no saturar la API
    const hoy = new Date();
    const haceUnMes = new Date();
    haceUnMes.setDate(haceUnMes.getDate() - 30);

    // Seteamos los l√≠mites globales iniciales
    fechaLimiteSuperior = hoy;
    fechaLimiteInferior = hoy; // Se ir√° restando en el bucle

    console.log(`üìÖ Iniciando carga escalonada...`);
    
    // Llamamos a la funci√≥n "Inteligente" que carga por trozos
    await cargarRangoEscalonado(haceUnMes, hoy);
    
    // Mostrar bot√≥n para cargar m√°s historia
    document.getElementById('btnServerLoad').style.display = 'inline-block';
}

// --- 2. CARGA ESCALONADA (CORE DEL FIX) ---
// Esta funci√≥n divide un rango grande en peticiones peque√±as
async function cargarRangoEscalonado(fechaObjetivo, fechaInicio) {
    const btn = document.getElementById('btnServerLoad');
    const indicador = document.getElementById('loadingIndicator');
    
    btn.disabled = true;
    btn.innerText = "‚è≥ Descargando historial...";
    indicador.style.display = 'block';

    let cursorFecha = new Date(fechaInicio); // Empezamos desde "hoy" hacia atr√°s

    // Mientras nuestro cursor sea mayor que la fecha objetivo (ej: hace 1 mes)
    while (cursorFecha > fechaObjetivo) {
        
        // 1. Calculamos el siguiente bloque (ej: 5 d√≠as atr√°s)
        let bloqueHasta = new Date(cursorFecha);
        let bloqueDesde = new Date(cursorFecha);
        bloqueDesde.setDate(bloqueDesde.getDate() - DIAS_POR_LOTE);

        // Si el bloque se pasa de la fecha objetivo, ajustamos
        if (bloqueDesde < fechaObjetivo) {
            bloqueDesde = new Date(fechaObjetivo);
        }

        console.log(`üì° Pidiendo bloque: ${bloqueDesde.toLocaleDateString()} -> ${bloqueHasta.toLocaleDateString()}`);

        // 2. Hacemos la petici√≥n SOLO de este bloque peque√±o
        await fetchBloqueUnico(bloqueDesde.toISOString(), bloqueHasta.toISOString());

        // 3. Actualizamos el l√≠mite inferior global para saber hasta donde tenemos datos
        fechaLimiteInferior = bloqueDesde;
        
        // 4. Movemos el cursor para la siguiente vuelta
        cursorFecha = new Date(bloqueDesde);
        
        // Peque√±a pausa para no saturar red (opcional, 50ms)
        await new Promise(r => setTimeout(r, 50));
    }

    btn.disabled = false;
    btn.innerText = "üìÇ Descargar 15 d√≠as anteriores";
    indicador.style.display = 'none';
}

// --- 3. FETCH DE UN SOLO BLOQUE ---
async function fetchBloqueUnico(desde, hasta) {
    try {
        const url = `https://distribuidorafunaz-a2o6.onrender.com/api/historial?desde=${desde}&hasta=${hasta}`;
        const res = await fetch(url);
        
        if(res.ok) {
            let nuevosDatos = await res.json();
            
            // Procesar datos
            nuevosDatos = nuevosDatos.map(h => ({
                ...h, 
                esAjuste: h.tipo_movimiento === 'AJUSTE_DETECTADO_DB' || h.tipo_movimiento === 'AJUSTE_MANUAL',
                sortKey: new Date(h.fecha).getTime()
            }));

            // Filtrar duplicados (por si las horas se solapan al milisegundo)
            const idsExistentes = new Set(historialDB.map(h => h.id));
            const limpios = nuevosDatos.filter(d => !idsExistentes.has(d.id));
            
            // Agregar al array principal
            historialDB = [...historialDB, ...limpios];

            // Ordenar: M√°s nuevo arriba
            historialDB.sort((a, b) => b.sortKey - a.sortKey);
            
            // RENDERIZAR INMEDIATAMENTE (Para que el usuario vea progreso)
            renderizar();
        }
    } catch (err) { 
        console.error("Error en bloque:", err);
    }
}

// --- 4. BOT√ìN CARGAR M√ÅS ANTIG√úEDAD ---
async function cargarMasAntiguedad() {
    // El usuario quiere ver m√°s atr√°s.
    // Tomamos la fecha m√°s antigua que tenemos y le restamos 15 d√≠as
    const nuevaMeta = new Date(fechaLimiteInferior);
    nuevaMeta.setDate(nuevaMeta.getDate() - 15);
    
    // Llamamos al cargador escalonado con la nueva meta
    // El "inicio" es fechaLimiteInferior (donde nos quedamos la √∫ltima vez)
    await cargarRangoEscalonado(nuevaMeta, fechaLimiteInferior);
}

// --- 5. RENDERIZADO (VISUAL) ---
function renderizar() {
    const cont = document.getElementById('contenedorHistorial');
    const busq = document.getElementById('buscador').value.toLowerCase();
    const soloAjuste = document.getElementById('checkManual').checked;

    cont.innerHTML = '';

    // Filtrado en memoria
    const listaFiltrada = historialDB.filter(i => {
        return i.producto_nombre.toLowerCase().includes(busq) && (!soloAjuste || i.esAjuste);
    });

    if(listaFiltrada.length === 0) {
        cont.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">No hay movimientos o cargando...</p>';
        return;
    }

    // Paginaci√≥n VISUAL (Para no trabar el navegador al hacer scroll)
    const visible = listaFiltrada.slice(0, limiteVisual);
    
    const grupos = {};
    visible.forEach(i => {
        const k = formatearFecha(i.fecha);
        if(!grupos[k]) grupos[k] = [];
        grupos[k].push(i);
    });

    Object.keys(grupos).forEach(fecha => {
        const div = document.createElement('div');
        div.className = 'fecha-grupo';
        div.innerHTML = `<div class="fecha-header">${fecha}</div>`;
        
        grupos[fecha].forEach(item => {
            const esAjuste = item.esAjuste;
            const signo = item.cantidad_cambio > 0 ? '+' : '';
            const colorBadge = esAjuste ? 'neutro' : (item.cantidad_cambio > 0 ? 'positivo' : 'negativo');
            const hora = new Date(item.fecha).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            const card = document.createElement('div');
            card.className = `card ${esAjuste ? 'ajuste' : 'normal'}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="prod-nombre">${item.producto_nombre}</div>
                    <div class="hora">${hora}</div>
                </div>
                <div class="card-body">
                    <div class="stock-flow">
                        <span>${item.stock_anterior}</span>
                        <span class="arrow">‚ûù</span>
                        <span>${item.stock_nuevo}</span>
                    </div>
                    <div class="cambio-badge ${colorBadge}">
                        ${signo}${item.cantidad_cambio}
                    </div>
                </div>
                <div style="margin-top:5px">
                    <span class="tipo-mov">
                        ${item.tipo_movimiento.replace(/_/g,' ')}
                    </span>
                </div>
            `;
            div.appendChild(card);
        });
        cont.appendChild(div);
    });

    // Bot√≥n "Ver m√°s" (Paginaci√≥n local)
    if(limiteVisual < listaFiltrada.length) {
        const btn = document.createElement('button');
        btn.className = 'btn-cargar-mas';
        btn.innerText = `Ver siguientes (${listaFiltrada.length - limiteVisual} restantes)`;
        btn.onclick = () => { limiteVisual += 50; renderizar(); };
        cont.appendChild(btn);
    }
}

// --- 6. FUNCIONES AUXILIARES ---
async function forzarCheck() {
    const btn = document.querySelector('.btn-check');
    btn.innerText = "‚è≥..."; btn.disabled = true;
    try {
        await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/forzar-monitor', { method: 'POST' });
        // Recargamos solo los ultimos 5 d√≠as para actualizar r√°pido
        const hoy = new Date();
        const hace5 = new Date(); hace5.setDate(hoy.getDate() - 5);
        await fetchBloqueUnico(hace5.toISOString(), hoy.toISOString());
        btn.innerText = "‚úÖ";
    } catch (e) { console.error(e); btn.innerText = "‚ùå"; }
    setTimeout(() => { btn.innerText = "‚Üª Check Ahora"; btn.disabled = false; }, 1000);
}

function filtrar(tipo, btn) {
    filtroActual = tipo;
    document.querySelectorAll('.filtros button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    limiteVisual = 50;
    renderizar();
}

function formatearFecha(f) {
    const d = new Date(f);
    if(filtroActual === 'dia') return d.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'});
    if(filtroActual === 'semana') return "Semana del " + d.toLocaleDateString();
    if(filtroActual === 'mes') return d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
    if(filtroActual === 'anio') return d.getFullYear();
}

// Iniciar al cargar
iniciar();

</script>
</body>
</html>
