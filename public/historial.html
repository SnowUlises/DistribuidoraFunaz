<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Historial de Stock - Distribuidora Funaz</title>
  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --soft-green: #E8F5E9;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --text-dark: #333;
      --text-grey: #666;
      --orange: #ff9800;
      --orange-bg: #fff3e0;
      --orange-border: #ffcc80;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }

    /* HEADER */
    header {
      background: var(--primary-green); color: var(--white);
      padding: 1em; position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 1.2em; font-weight: 600; }
    .btn-volver { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 0.9em; display:flex; gap:5px; align-items:center; }

    /* CONTROLES */
    .controles-superiores {
      padding: 10px 1em;
      background: var(--white);
      display: flex; flex-direction: column; gap: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .fila-controles { display: flex; gap: 10px; align-items: center; justify-content: space-between; width: 100%; }

    .buscador-container { flex-grow: 1; }
    .input-buscador {
      width: 100%; padding: 8px 12px; border-radius: 20px;
      border: 1px solid #ddd; outline: none; font-size: 0.95em;
    }
    .input-buscador:focus { border-color: var(--primary-green); }

    /* BOTON FORZAR CHECK */
    .btn-force-check {
        background: var(--text-dark); color: white; border: none;
        padding: 8px 16px; border-radius: 20px; cursor: pointer;
        font-size: 0.85em; white-space: nowrap; display: flex; align-items: center; gap: 5px;
        font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-force-check:active { transform: scale(0.95); }

    .toggle-orange {
      display: flex; align-items: center; gap: 5px;
      font-size: 0.85em; color: #e65100; font-weight: bold; cursor: pointer;
    }
    .toggle-orange input { accent-color: var(--orange); transform: scale(1.2); }

    /* FILTROS */
    .filtros {
      display: flex; gap: 10px; padding: 10px 1em; 
      overflow-x: auto; white-space: nowrap;
      background: var(--white); border-bottom: 1px solid #eee;
    }
    .filtros button {
      padding: 6px 14px; border: 1px solid #ddd; background: var(--white);
      border-radius: 20px; color: var(--text-grey); font-weight: 500; cursor: pointer;
      transition: all 0.2s; font-size: 0.9em;
    }
    .filtros button.active {
      background: var(--soft-green); border-color: var(--primary-green); color: var(--primary-green); font-weight: bold;
    }

    /* CONTENEDOR PRINCIPAL */
    main { max-width: 800px; margin: 0 auto; padding: 1em; }

    .fecha-grupo { margin-bottom: 2em; }
    .fecha-header {
      font-size: 0.9em; text-transform: uppercase; color: var(--text-grey);
      margin-bottom: 10px; font-weight: bold; letter-spacing: 1px;
      border-bottom: 2px solid #eee; padding-bottom: 5px;
    }

    /* CARDS */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 1em;
      margin-bottom: 10px;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      display: flex; flex-direction: column; gap: 8px;
      position: relative;
    }
    
    .card.normal { border-left: 4px solid var(--light-green); }
    
    /* CARD NARANJA (Ajuste) */
    .card.ajuste-db {
      border: 1px solid var(--orange-border);
      background: var(--orange-bg);
      border-left: 4px solid var(--orange);
    }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .prod-nombre { font-weight: bold; font-size: 1.1em; color: var(--text-dark); }
    .hora { font-size: 0.8em; color: var(--text-grey); }

    .card-body { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
    
    .stock-flow {
      display: flex; align-items: center; gap: 8px;
      font-family: monospace; font-size: 1.1em; color: #555;
    }
    .arrow { color: #999; }
    .cambio-badge {
      padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em;
    }
    .negativo { background: #ffebee; color: #d32f2f; }
    .positivo { background: #e8f5e9; color: #2e7d32; }
    .neutro { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }

    .tipo-mov { font-size: 0.75em; padding: 3px 6px; border-radius: 4px; background: #eee; color: #666; }

    .btn-cargar-mas {
      display: block; width: 100%; max-width: 300px; margin: 20px auto;
      padding: 12px; background: var(--white); border: 1px solid var(--primary-green);
      color: var(--primary-green); font-weight: bold; border-radius: 25px;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-cargar-mas:hover { background: var(--soft-green); }

  </style>
</head>
<body>

  <header>
    <a href="admin.html" class="btn-volver">‚¨Ö Admin</a>
    <h1>Historial de Stock</h1>
    <div style="width: 30px;"></div>
  </header>

  <div class="controles-superiores">
    <div class="fila-controles">
        <div class="buscador-container">
            <input type="text" id="buscador" class="input-buscador" placeholder="üîç Buscar producto..." onkeyup="resetYRenderizar()">
        </div>
        <button class="btn-force-check" onclick="forzarVerificacion()">
            ‚Üª Analizar Stock
        </button>
    </div>
    <div class="fila-controles">
        <label class="toggle-orange">
        <input type="checkbox" id="checkManual" onchange="resetYRenderizar()">
        Solo Ajustes DB
        </label>
    </div>
  </div>

  <div class="filtros">
    <button class="active" onclick="filtrar('dia', this)">Por D√≠a</button>
    <button onclick="filtrar('semana', this)">Semana</button>
    <button onclick="filtrar('mes', this)">Mes</button>
    <button onclick="filtrar('anio', this)">A√±o</button>
  </div>

  <main id="contenedorHistorial">
    <p style="text-align:center; color:#999; margin-top:2em;">Iniciando sistema...</p>
  </main>
  
<script>
let historialRaw = [];       
let stockRealMap = {};       
let historialUnificado = []; 

let filtroActual = 'dia';
let limiteCarga = 50;

// --- 1. INICIO Y CARGA DE DATOS ---
async function iniciarSistema() {
    await obtenerDatosCompletos();
    // Monitor automatico cada 4 min (240.000 ms)
    setInterval(monitorCambiosStock, 240000); 
}

async function obtenerDatosCompletos() {
    try {
        const [resHist, resProd] = await Promise.all([
            fetch('https://distribuidorafunaz-a2o6.onrender.com/api/historial'),
            fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos')
        ]);

        if(!resHist.ok || !resProd.ok) throw new Error("Error en APIs");

        historialRaw = await resHist.json();
        const productos = await resProd.json();
        
        productos.forEach(p => stockRealMap[p.id] = p.stock);

        recalcularHistorialCronologico();
        renderizar();

    } catch (err) {
        document.getElementById('contenedorHistorial').innerHTML = '<p style="text-align:center; color:red">Error de conexi√≥n.</p>';
        console.error(err);
    }
}

// --- 2. BOTON DE FORZAR VERIFICACION ---
async function forzarVerificacion() {
    const btn = document.querySelector('.btn-force-check');
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = "‚è≥ Analizando...";
    btn.disabled = true;

    await monitorCambiosStock(); // Reutiliza el monitor

    btn.innerHTML = "‚úÖ Actualizado";
    setTimeout(() => { 
        btn.innerHTML = textoOriginal; 
        btn.disabled = false; 
    }, 1500);
}

// --- 3. MONITOR DE CAMBIOS ---
async function monitorCambiosStock() {
    console.log("Checkeando consistencia de stock...");
    try {
        // Obtenemos solo productos para ver el "Ahora"
        const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos');
        if(!res.ok) return;
        
        const productos = await res.json();
        let huboCambios = false;

        productos.forEach(p => {
            const stockGuardado = stockRealMap[p.id];
            // Si el stock actual es diferente al que teniamos en memoria
            if (stockGuardado !== undefined && stockGuardado !== p.stock) {
                console.log(`Diferencia encontrada en ${p.nombre}`);
                stockRealMap[p.id] = p.stock;
                huboCambios = true;
            }
        });

        // Si la realidad cambi√≥, traemos el historial fresco tambi√©n para evitar desfasajes
        if (huboCambios) {
             const resH = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/historial');
             if(resH.ok) {
                 historialRaw = await resH.json();
                 recalcularHistorialCronologico();
                 renderizar();
             }
        }
    } catch (e) { console.log("Error monitor", e); }
}

// --- 4. LOGICA CENTRAL: ANALISIS CRONOLOGICO ---
function recalcularHistorialCronologico() {
    const movimientosPorProducto = {};
    const listaFinal = [];

    // Helper para parsear fecha segura a timestamp num√©rico
    const getTs = (fechaStr) => {
        const d = new Date(fechaStr);
        return isNaN(d.getTime()) ? 0 : d.getTime();
    };

    // A. Ordenar historial puro por FECHA ASCENDENTE (Del m√°s viejo al m√°s nuevo)
    const rawOrdenado = [...historialRaw].sort((a,b) => getTs(a.fecha) - getTs(b.fecha));

    rawOrdenado.forEach(mov => {
        if(!movimientosPorProducto[mov.producto_id]) movimientosPorProducto[mov.producto_id] = [];
        movimientosPorProducto[mov.producto_id].push(mov);
    });

    // B. Recorrer cada producto buscando huecos
    Object.keys(movimientosPorProducto).forEach(prodId => {
        const movs = movimientosPorProducto[prodId];
        
        for (let i = 0; i < movs.length; i++) {
            const actual = movs[i];
            const tsActual = getTs(actual.fecha);

            // --- HUECO INTERMEDIO (Entre el anterior y el actual) ---
            if (i > 0) {
                const anterior = movs[i-1];
                const stockDeberia = anterior.stock_nuevo;
                const stockRealInicioActual = actual.stock_nuevo - actual.cantidad_cambio;

                if (stockDeberia !== stockRealInicioActual) {
                    // Detectado ajuste manual. 
                    // FECHA CLAVE: 1 segundo ANTES del movimiento actual.
                    // Esto garantiza que al ordenar por fecha, quede debajo del movimiento actual.
                    const tsAjuste = tsActual - 1000; 
                    
                    listaFinal.push({
                        id: `ajuste-${actual.id}`,
                        producto_id: actual.producto_id,
                        producto_nombre: actual.producto_nombre,
                        fecha: new Date(tsAjuste).toISOString(),
                        timestampSort: tsAjuste, // Clave de ordenamiento explicita
                        stock_anterior: stockDeberia,
                        stock_nuevo: stockRealInicioActual,
                        cantidad_cambio: stockRealInicioActual - stockDeberia,
                        tipo_movimiento: 'Ajuste_DB',
                        esAjuste: true
                    });
                }
            }
            
            // Agregamos el movimiento real con su timestamp expl√≠cito
            listaFinal.push({ 
                ...actual, 
                timestampSort: tsActual,
                esAjuste: false 
            });
        }

        // --- HUECO FINAL (Entre el √∫ltimo historial y la API actual) ---
        const ultimoMov = movs[movs.length - 1];
        const stockActualAPI = stockRealMap[ultimoMov.producto_id];
        const tsUltimo = getTs(ultimoMov.fecha);

        if (stockActualAPI !== undefined && ultimoMov.stock_nuevo !== stockActualAPI) {
            // Este es un ajuste que no tiene venta posterior a√∫n.
            // Debe ir al TOPE de la lista (es lo m√°s reciente).
            // Usamos Date.now() o (Ultimo + 1 seg) si el reloj est√° mal.
            const tsFinal = Math.max(Date.now(), tsUltimo + 1000);

            listaFinal.push({
                id: `ajuste-final-${ultimoMov.id}`,
                producto_id: ultimoMov.producto_id,
                producto_nombre: ultimoMov.producto_nombre,
                fecha: new Date(tsFinal).toISOString(),
                timestampSort: tsFinal,
                stock_anterior: ultimoMov.stock_nuevo,
                stock_nuevo: stockActualAPI,
                cantidad_cambio: stockActualAPI - ultimoMov.stock_nuevo,
                tipo_movimiento: 'Detectado_Ahora',
                esAjuste: true
            });
        }
    });

    // C. Ordenar lista final por timestamp DESCENDENTE (Lo m√°s nuevo arriba)
    // Esto es crucial para que los ajustes (-1000ms) queden debajo de las ventas.
    historialUnificado = listaFinal.sort((a,b) => b.timestampSort - a.timestampSort);
}


// --- 5. RENDERIZADO ---
function filtrar(tipo, btn) {
  filtroActual = tipo;
  document.querySelectorAll('.filtros button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  resetYRenderizar();
}

function resetYRenderizar() {
  limiteCarga = 50;
  renderizar();
}

function cargarMas() {
  limiteCarga += 50;
  renderizar();
}

function formatearFecha(fechaStr) {
  const d = new Date(fechaStr);
  if(isNaN(d.getTime())) return "Fecha desconocida";
  
  if (filtroActual === 'dia') return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
  if (filtroActual === 'semana') return `Semana del ${d.toLocaleDateString()}`;
  if (filtroActual === 'mes') return d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  return d.getFullYear();
}

function renderizar() {
  const container = document.getElementById('contenedorHistorial');
  const busqueda = document.getElementById('buscador').value.toLowerCase();
  const soloAjustes = document.getElementById('checkManual').checked;

  container.innerHTML = '';

  let lista = historialUnificado.filter(item => {
    const matchNombre = item.producto_nombre.toLowerCase().includes(busqueda);
    const matchTipo = soloAjustes ? item.esAjuste : true;
    return matchNombre && matchTipo;
  });

  if (lista.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#999">No hay registros.</p>';
    return;
  }

  const listaPaginada = lista.slice(0, limiteCarga);
  const grupos = {};

  listaPaginada.forEach(item => {
    const key = formatearFecha(item.fecha);
    if (!grupos[key]) grupos[key] = [];
    grupos[key].push(item);
  });

  Object.keys(grupos).forEach(fechaHeader => {
    const divGrupo = document.createElement('div');
    divGrupo.className = 'fecha-grupo';
    divGrupo.innerHTML = `<div class="fecha-header">${fechaHeader}</div>`;

    grupos[fechaHeader].forEach(item => {
      const cambioTexto = item.cantidad_cambio > 0 ? `+${item.cantidad_cambio}` : `${item.cantidad_cambio}`;
      const hora = new Date(item.fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // ESTILOS: Naranja para ajustes, Verde para normal
      let claseCard = item.esAjuste ? 'ajuste-db' : 'normal';
      let claseBadge = item.cantidad_cambio > 0 ? 'positivo' : 'negativo';
      if(item.esAjuste) claseBadge = 'neutro'; // Badge naranja

      const tipoLegible = item.esAjuste ? 'Ajuste de DB' : item.tipo_movimiento.replace('_', ' ');

      const card = document.createElement('div');
      card.className = `card ${claseCard}`;
      
      card.innerHTML = `
        <div class="card-header">
          <div class="prod-nombre">${item.producto_nombre}</div>
          <div class="hora">${hora}</div>
        </div>
        <div class="card-body">
          <div class="stock-flow">
            <span>${item.stock_anterior}</span>
            <span class="arrow">‚ûù</span>
            <span>${item.stock_nuevo}</span>
          </div>
          <div class="cambio-badge ${claseBadge}">${cambioTexto}</div>
        </div>
        <div style="margin-top:5px;">
           <span class="tipo-mov">${tipoLegible}</span>
        </div>
      `;
      divGrupo.appendChild(card);
    });

    container.appendChild(divGrupo);
  });

  if (limiteCarga < lista.length) {
    const btnMas = document.createElement('button');
    btnMas.className = 'btn-cargar-mas';
    btnMas.innerText = `Cargar m√°s (${lista.length - limiteCarga} restantes)`;
    btnMas.onclick = cargarMas;
    container.appendChild(btnMas);
  }
}

// ARRANQUE
iniciarSistema();

</script>
</body>
</html>
