<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Historial - Distribuidora Funaz</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4d7c0f', // Verde tipo lima oscuro (lime-700)
            secondary: '#ecfccb', // Verde lima muy claro (lime-100)
            accent: '#84cc16', // Verde lima vibrante (lime-500)
            dark: '#1f2937',
          }
        }
      }
    }
  </script>

  <style>
    /* Estilos extra para scrollbar oculta y detalles finos */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
  </style>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-800 font-sans pb-24">

  <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="admin.html" class="flex items-center text-primary font-semibold hover:text-accent transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Admin
      </a>
      <h1 class="text-lg font-bold text-gray-800 tracking-tight">Historial de Stock</h1>
      <div class="w-16"></div> </div>
  </header>

  <div id="loadingIndicator" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg z-50 animate-pulse">
    ‚è≥ Sincronizando datos...
  </div>

  <div class="max-w-3xl mx-auto">
    
    <div class="bg-white p-4 border-b border-gray-100">
      <div class="flex gap-3 mb-3">
        <div class="relative flex-grow">
          <input type="text" id="buscador" onkeyup="renderizar()" 
            class="w-full bg-gray-100 text-gray-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition-all"
            placeholder="Buscar producto...">
          <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
        </div>
        <button onclick="forzarCheck()" class="btn-check bg-primary hover:bg-green-800 text-white px-4 py-2 rounded-full text-sm font-bold shadow-sm active:scale-95 transition-transform flex items-center gap-1">
          <span>‚Üª</span> <span class="hidden sm:inline">Check</span>
        </button>
      </div>

      <div class="flex items-center justify-end">
        <label class="flex items-center gap-2 cursor-pointer text-xs font-semibold text-orange-600 bg-orange-50 px-3 py-1 rounded-full border border-orange-100 hover:bg-orange-100 transition-colors">
          <input type="checkbox" id="checkManual" onchange="renderizar()" class="accent-orange-500 w-4 h-4">
          Solo Ajustes Autom√°ticos
        </label>
      </div>
    </div>

    <div class="flex gap-2 p-3 overflow-x-auto hide-scrollbar bg-white border-b border-gray-100 filtros sticky top-[60px] z-40">
      <button onclick="filtrar('dia', this)" class="active filter-btn px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 text-gray-500 whitespace-nowrap transition-all hover:bg-gray-50">Por D√≠a</button>
      <button onclick="filtrar('semana', this)" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 text-gray-500 whitespace-nowrap transition-all hover:bg-gray-50">Semana</button>
      <button onclick="filtrar('mes', this)" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 text-gray-500 whitespace-nowrap transition-all hover:bg-gray-50">Mes</button>
      <button onclick="filtrar('anio', this)" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 text-gray-500 whitespace-nowrap transition-all hover:bg-gray-50">A√±o</button>
    </div>

    <main id="contenedorHistorial" class="p-4 space-y-6 min-h-[50vh]">
      <div class="flex flex-col items-center justify-center py-10 text-gray-400">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div>
        <p class="text-sm">Cargando movimientos...</p>
      </div>
    </main>

    <div class="text-center pb-10 pt-4">
        <button id="btnServerLoad" onclick="cargarMasAntiguedad()" 
          class="hidden bg-white border border-primary text-primary px-6 py-3 rounded-full text-sm font-bold shadow-sm hover:bg-secondary transition-all active:scale-95">
          üìÇ Cargar 15 d√≠as anteriores
        </button>
    </div>

  </div>

<script>
    // ==========================================
    // ESTILOS DIN√ÅMICOS PARA FILTROS
    // ==========================================
    const styleActive = "bg-secondary border-primary text-primary font-bold shadow-sm";
    const styleInactive = "bg-white border-gray-200 text-gray-500 hover:bg-gray-50";

    function updateFilterStyles(activeBtn) {
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.className = `filter-btn px-4 py-1.5 rounded-full text-sm font-medium border whitespace-nowrap transition-all ${styleInactive}`;
        });
        activeBtn.className = `filter-btn px-4 py-1.5 rounded-full text-sm font-medium border whitespace-nowrap transition-all ${styleActive}`;
    }
    // Inicializar primer bot√≥n como activo
    updateFilterStyles(document.querySelector('.filter-btn'));


    // ==========================================
    // L√ìGICA PRINCIPAL (MANTENIDA DEL ORIGINAL)
    // ==========================================
    let historialDB = [];          
    let filtroActual = 'dia';
    let limiteVisual = 50; 

    let fechaLimiteSuperior = new Date(); 
    let fechaLimiteInferior = new Date(); 

    const DIAS_POR_LOTE = 5; 

    // --- 1. INICIO ---
    async function iniciar() {
        const hoy = new Date();
        const haceUnMes = new Date();
        haceUnMes.setDate(haceUnMes.getDate() - 30);

        fechaLimiteSuperior = hoy;
        fechaLimiteInferior = hoy;

        console.log(`üìÖ Iniciando carga escalonada...`);
        await cargarRangoEscalonado(haceUnMes, hoy);
        document.getElementById('btnServerLoad').style.display = 'inline-block';
    }

    // --- 2. CARGA ESCALONADA ---
    async function cargarRangoEscalonado(fechaObjetivo, fechaInicio) {
        const btn = document.getElementById('btnServerLoad');
        const indicador = document.getElementById('loadingIndicator');
        
        btn.disabled = true;
        btn.innerHTML = `<span class="opacity-50">‚è≥</span> Descargando...`;
        indicador.classList.remove('hidden');

        let cursorFecha = new Date(fechaInicio);

        while (cursorFecha > fechaObjetivo) {
            let bloqueHasta = new Date(cursorFecha);
            let bloqueDesde = new Date(cursorFecha);
            bloqueDesde.setDate(bloqueDesde.getDate() - DIAS_POR_LOTE);

            if (bloqueDesde < fechaObjetivo) {
                bloqueDesde = new Date(fechaObjetivo);
            }

            console.log(`üì° Pidiendo: ${bloqueDesde.toLocaleDateString()} -> ${bloqueHasta.toLocaleDateString()}`);
            await fetchBloqueUnico(bloqueDesde.toISOString(), bloqueHasta.toISOString());

            fechaLimiteInferior = bloqueDesde;
            cursorFecha = new Date(bloqueDesde);
            await new Promise(r => setTimeout(r, 50));
        }

        btn.disabled = false;
        btn.innerText = "üìÇ Cargar 15 d√≠as anteriores";
        indicador.classList.add('hidden');
    }

    // --- 3. FETCH BLOQUE √öNICO ---
    async function fetchBloqueUnico(desde, hasta) {
        try {
            const url = `https://distribuidorafunaz-a2o6.onrender.com/api/historial?desde=${desde}&hasta=${hasta}`;
            const res = await fetch(url);
            
            if(res.ok) {
                let nuevosDatos = await res.json();
                
                nuevosDatos = nuevosDatos.map(h => ({
                    ...h, 
                    esAjuste: h.tipo_movimiento === 'ajuste db' || h.tipo_movimiento === 'AJUSTE_DETECTADO_DB',
                    sortKey: new Date(h.fecha).getTime()
                }));

                const idsExistentes = new Set(historialDB.map(h => h.id));
                const limpios = nuevosDatos.filter(d => !idsExistentes.has(d.id));
                
                historialDB = [...historialDB, ...limpios];
                historialDB.sort((a, b) => b.sortKey - a.sortKey);
                
                renderizar();
            }
        } catch (err) { 
            console.error("Error en bloque:", err);
        }
    }

    // --- 4. CARGAR M√ÅS ---
    async function cargarMasAntiguedad() {
        const nuevaMeta = new Date(fechaLimiteInferior);
        nuevaMeta.setDate(nuevaMeta.getDate() - 15);
        await cargarRangoEscalonado(nuevaMeta, fechaLimiteInferior);
    }

    // --- 5. RENDERIZADO (AQU√ç EST√Å LA MAGIA VISUAL NUEVA) ---
    function renderizar() {
        const cont = document.getElementById('contenedorHistorial');
        const busq = document.getElementById('buscador').value.toLowerCase();
        const soloAjuste = document.getElementById('checkManual').checked;

        cont.innerHTML = '';

        const listaFiltrada = historialDB.filter(i => {
            return i.producto_nombre.toLowerCase().includes(busq) && (!soloAjuste || i.esAjuste);
        });

        if(listaFiltrada.length === 0) {
            cont.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-60">
                    <span class="text-4xl mb-2">üì≠</span>
                    <p>No se encontraron movimientos.</p>
                </div>`;
            return;
        }

        const visible = listaFiltrada.slice(0, limiteVisual);
        
        const grupos = {};
        visible.forEach(i => {
            const k = formatearFecha(i.fecha);
            if(!grupos[k]) grupos[k] = [];
            grupos[k].push(i);
        });

        Object.keys(grupos).forEach(fecha => {
            // Header de fecha
            const section = document.createElement('div');
            section.className = "mb-6";
            section.innerHTML = `
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-1 border-b border-gray-100 pb-1">
                    ${fecha}
                </h3>
            `;
            
            const grid = document.createElement('div');
            grid.className = "space-y-3"; // Espacio entre tarjetas

            grupos[fecha].forEach(item => {
                const esAjuste = item.esAjuste;
                const esNegativo = item.cantidad_cambio < 0;
                const signo = item.cantidad_cambio > 0 ? '+' : '';
                
                // Colores din√°micos seg√∫n el tipo de movimiento
                let colorClass = "bg-secondary text-primary border-primary"; // Positivo (Verde)
                let icon = "üìà";

                if (esNegativo) {
                    colorClass = "bg-red-50 text-red-600 border-red-200"; // Negativo (Rojo)
                    icon = "üìâ";
                }
                if (esAjuste) {
                    colorClass = "bg-orange-50 text-orange-600 border-orange-200"; // Ajuste (Naranja)
                    icon = "‚ö†Ô∏è";
                }

                const hora = new Date(item.fecha).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                // --- INFO DE LA RAZ√ìN ---
                // Si existe 'razon', la usamos. Si no, usamos 'tipo_movimiento'
                let razonTexto = item.razon || item.tipo_movimiento.replace(/_/g, ' ');
                // Si es muy largo, Tailwind se encarga del wrap, pero podemos darle estilo
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative overflow-hidden";
                if(esAjuste) card.classList.add('border-l-4', 'border-l-orange-400'); // Borde naranja a la izquierda si es ajuste

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-800 text-lg leading-tight">
                                ${item.producto_nombre}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                <span>üïê ${hora}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-gray-400 mb-1">Stock</span>
                            <div class="flex items-center gap-1 font-mono text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded-md">
                                <span class="${esNegativo ? 'text-gray-400' : ''}">${item.stock_anterior}</span>
                                <span class="text-gray-300">‚ûú</span>
                                <span class="font-bold ${esNegativo ? 'text-red-500' : 'text-primary'}">${item.stock_nuevo}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2 border-t border-gray-50 mt-2">
                        <div class="flex-1 pr-4">
                            <p class="text-xs text-gray-500 leading-snug break-words">
                                ${razonTexto}
                            </p>
                        </div>

                        <div class="px-3 py-1 rounded-lg border text-sm font-bold shadow-sm whitespace-nowrap ${colorClass}">
                            ${signo}${item.cantidad_cambio}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            section.appendChild(grid);
            cont.appendChild(section);
        });

        // Bot√≥n Ver m√°s local
        if(limiteVisual < listaFiltrada.length) {
            const btnDiv = document.createElement('div');
            btnDiv.className = "text-center pt-4";
            
            const btn = document.createElement('button');
            btn.className = "text-primary text-sm font-semibold hover:underline";
            btn.innerText = `üëá Ver siguientes (${listaFiltrada.length - limiteVisual} restantes)`;
            btn.onclick = () => { limiteVisual += 50; renderizar(); };
            
            btnDiv.appendChild(btn);
            cont.appendChild(btnDiv);
        }
    }

    // --- 6. HELPERS ---
    async function forzarCheck() {
        const btn = document.querySelector('.btn-check');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span>‚è≥</span>`; 
        btn.disabled = true;
        try {
            await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/forzar-monitor', { method: 'POST' });
            const hoy = new Date();
            const hace5 = new Date(); hace5.setDate(hoy.getDate() - 5);
            await fetchBloqueUnico(hace5.toISOString(), hoy.toISOString());
            btn.innerHTML = `<span>‚úÖ</span>`;
        } catch (e) { console.error(e); btn.innerHTML = `<span>‚ùå</span>`; }
        setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 1500);
    }

    function filtrar(tipo, btn) {
        filtroActual = tipo;
        updateFilterStyles(btn);
        limiteVisual = 50;
        renderizar();
    }

    function formatearFecha(f) {
        const d = new Date(f);
        // Capitalizamos primera letra
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        if(filtroActual === 'semana') return "Semana del " + d.toLocaleDateString();
        if(filtroActual === 'mes') return d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
        if(filtroActual === 'anio') return d.getFullYear();
        
        let s = d.toLocaleDateString('es-ES', options);
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    iniciar();
</script>

</body>
</html>
